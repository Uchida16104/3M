<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§  3M â€” I Message to You About My Mind.</title>

  <!-- htmx: CDN (unpkg) -->
  <script src="https://unpkg.com/htmx.org@1.11.0"></script>

  <style>
    :root{font-family: system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    body{padding:20px;max-width:900px;margin:0 auto;background:#f7f9fb;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{margin-top:0;color:#444}
    textarea,input[type=text]{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ccd;border-radius:8px}
    .card{background:white;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    ul{padding-left:18px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button, .btn {background:#1565d8;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .secondary{background:#eee;color:#111;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:#666}
    .item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .item .controls{display:flex;flex-direction:column;gap:6px}
    .draggable{cursor:grab}
    .final{white-space:pre-wrap;background:#0b1220;color:#e8f0ff;padding:12px;border-radius:8px}
    .danger{color:#b00020}
    /* small utility for hidden fragments */
    .frag { display: none; }
    /* card-like container for PDF capture preview (hidden by default) */
    .pdf-card-preview { display:none; }
  </style>
</head>
<body>

  <!-- === MAIN container (we swap its innerHTML using htmx) === -->
  <main id="main"
        hx-get="index.html #frag-phase1"
        hx-trigger="load"
        hx-swap="innerHTML">
    <!-- åˆå›èª­ã¿è¾¼ã¿æ™‚ã« frag-phase1 ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ -->
  </main>

  <!-- ============================
       FRAGMENTS (kept in same file)
       We use htmx to fetch "#frag-phaseX" from this same file.
       Each fragment holds the HTML view for that phase or the whole flow view.
       ============================ -->

  <!-- ãƒ•ã‚§ãƒ¼ã‚º1 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase1" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <p class="lead">è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªã„ã¨ãã«ã€è©±ã™å†…å®¹ã‚’æ®µéšçš„ã«æ•´ç†ã—ã¦ç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«æ²¿ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚</p>

    <section class="card" id="phase1">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º1 â€” ã‚ã‚Šã®ã¾ã¾å…¥åŠ›</h2>
      <p class="small">æ€ã£ãŸã“ã¨ã‚’ãã®ã¾ã¾æ›¸ãå‡ºã—ã¾ã™ï¼ˆé•·æ–‡å¯ï¼‰ã€‚</p>
      <textarea id="rawText" name="rawText" rows="6" placeholder="ã“ã“ã«æ€ã£ã¦ã„ã‚‹ã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      <div style="margin-top:10px">
        <!-- htmx: load phase2 fragment but keep data via localStorage (handled in JS events) -->
        <button class="btn" hx-get="index.html #frag-phase2" hx-swap="innerHTML" hx-target="#main">5ã¤ã«åˆ†è§£ã™ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º2</button>
      </div>
    </section>

    <!-- support banner placeholder -->
    <div id="supportBannerPlaceholder"></div>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º2 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase2" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <p class="lead">è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªã„ã¨ãã«ã€è©±ã™å†…å®¹ã‚’æ®µéšçš„ã«æ•´ç†ã—ã¦ç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«æ²¿ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚</p>

    <section class="card" id="phase2">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º2 â€” 5ã¤ã®è¦ç´ ã«åˆ†è§£</h2>
      <p class="small">å…¥åŠ›ã‚’è‡ªå‹•ã§æ–‡ã‚„å¥ã«åˆ†å‰²ã—ã¾ã™ã€‚ç·¨é›†ã—ã¦1è¦ç´ ãšã¤ä¸å¯§ã«æ•´ãˆã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚</p>
      <ul id="elementsList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="secondary" hx-get="index.html #frag-phase1" hx-swap="innerHTML" hx-target="#main">æˆ»ã‚‹</button>
        <button class="btn" hx-get="index.html #frag-phase3" hx-swap="innerHTML" hx-target="#main">å„ªå…ˆåº¦ãƒã‚§ãƒƒã‚¯ â†’ ãƒ•ã‚§ãƒ¼ã‚º3</button>
      </div>
    </section>
    <div id="supportBannerPlaceholder2"></div>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º3 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase3" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <section class="card" id="phase3">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º3 â€” ç·Šæ€¥åº¦ã¨å„ªå…ˆé †ä½ã§ä¸Šä½3ã¤ã«çµã‚‹</h2>
      <p class="small">ãã‚Œãã‚Œã®è¦ç´ ã«ã¤ã„ã¦ã€ç·Šæ€¥æ€§ï¼ˆ0-5ï¼‰ã¨é‡è¦æ€§ï¼ˆ0-5ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è‡ªå‹•çš„ã«åˆè¨ˆã‚¹ã‚³ã‚¢ã§ä¸Šä½3ã¤ãŒé¸ã°ã‚Œã¾ã™ã€‚æ‰‹å‹•ã§ãƒ”ãƒ³ç•™ã‚ã‚‚å¯èƒ½ã§ã™ã€‚</p>
      <ul id="priorityList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="secondary" hx-get="index.html #frag-phase2" hx-swap="innerHTML" hx-target="#main">æˆ»ã‚‹</button>
        <button class="btn" hx-get="index.html #frag-phase4" hx-swap="innerHTML" hx-target="#main">3ã¤ã«çµã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º4</button>
      </div>
    </section>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º4 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase4" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <section class="card" id="phase4">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º4 â€” 3ã¤ã®è¦ç´ ã«å„ªå…ˆé †ä½ã‚’ä»˜ã‘ã‚‹</h2>
      <p class="small">ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§é †åºã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆä¸ŠãŒä¼ãˆã‚‹é †åºã®å„ªå…ˆåº¦é«˜ï¼‰ã€‚</p>
      <ul id="orderedList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="secondary" hx-get="index.html #frag-phase3" hx-swap="innerHTML" hx-target="#main">æˆ»ã‚‹</button>
        <button class="btn" hx-get="index.html #frag-phase5" hx-swap="innerHTML" hx-target="#main">æ–‡ç« ã‚’çµ„ã¿ç«‹ã¦ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º5</button>
      </div>
    </section>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º5 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase5" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <section class="card" id="phase5">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º5 â€” ç›¸æ‰‹ã«ä¼ãˆã‚‹æ–‡ç« ã‚’ä½œã‚‹</h2>
      <p class="small">é¸ã°ã‚ŒãŸ3ã¤ã‚’çŸ­ãã€å…·ä½“çš„ãªä¸€è¨€ãšã¤ã«ã¾ã¨ã‚ã¾ã™ã€‚ç›¸æ‰‹ã«ä¼ãˆã‚‹ã¨ãã®å†’é ­ï¼ˆç›®çš„ï¼‰ã¨æœ€å¾Œï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰ã‚‚ç”¨æ„ã—ã¾ã™ã€‚</p>
      <div>
        <label class="small">å†’é ­ï¼ˆç›®çš„ï¼‰</label>
        <input type="text" id="intro" name="intro" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯â—‹â—‹ã«ã¤ã„ã¦è©±ã—ãŸãã¦æ¥ã¾ã—ãŸã€‚">
      </div>
      <ul id="finalInputs"></ul>
      <div style="margin-top:8px">
        <label class="small">ç· ã‚ï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰</label>
        <input type="text" id="closing" name="closing" placeholder="ä¾‹ï¼šã“ã‚Œã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿï¼åŠ©ã‘ã¦ã»ã—ã„ã§ã™ã€‚">
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="secondary" hx-get="index.html #frag-phase4" hx-swap="innerHTML" hx-target="#main">æˆ»ã‚‹</button>
        <button class="btn" hx-get="index.html #frag-phase6" hx-swap="innerHTML" hx-target="#main">å®Œæˆ â†’ ãƒ•ã‚§ãƒ¼ã‚º6</button>
      </div>
    </section>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º6 ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ -->
  <div id="frag-phase6" class="frag">
    <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
    <section class="card" id="phase6">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º6 â€” å®Œæˆ</h2>
      <p class="small">ä¸‹ãŒç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®æœ€çµ‚æ–‡ç« ã§ã™ã€‚ç·¨é›†ã‚‚ã§ãã¾ã™ã€‚</p>
      <div class="final" id="finalMessage" contenteditable="false"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="copyBtn" class="btn">ã‚³ãƒ”ãƒ¼</button>
        <button id="editBtn" class="secondary">ç·¨é›†ã™ã‚‹</button>
        <button id="resetBtn" class="secondary">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        <!-- PDF ãƒœã‚¿ãƒ³ã¯ JavaScript ã§è¿½åŠ ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã®ãŸã‚ï¼‰ -->
      </div>
    </section>
  </div>

  <!-- ============================
       README ã®å›ºå®šãƒ†ã‚­ã‚¹ãƒˆï¼ˆèª¬æ˜ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆç­‰ï¼‰
       ã“ã“ã§ã¯ README ã®ã€Œæ¦‚è¦ç­‰ã€ã¯å¤‰æ›´ã—ãªã„ã¨ã„ã†è¦ä»¶ã®ãŸã‚ã€
       README ç›¸å½“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒšãƒ¼ã‚¸æœ«å°¾ã«åŸæ–‡ã®ã¾ã¾æ²è¼‰ã—ã¦ãŠãã¾ã™ã€‚
       (è¦ä»¶: æ¦‚è¦ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆç­‰ã¯ãã®ã¾ã¾ â€” å¤‰æ›´ãªã—)
       ============================ -->
  <section class="card" id="readmeSection" aria-hidden="true">
    <!-- ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ README ç›¸å½“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒï¼ˆå¤‰æ›´ä¸å¯ï¼‰ -->
    <!-- å®Ÿéš›ã® README ã¯ GitHub ä¸Šã® README.md ã‚’ãã®ã¾ã¾ç¶­æŒã—ã¦ãã ã•ã„ -->
    <h3 class="small">READMEï¼ˆæ¦‚è¦ç­‰ã¯å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ï¼‰</h3>
    <p class="small">ï¼ˆã“ã“ã§ã¯ç°¡ç•¥è¡¨ç¤ºï¼‰</p>
  </section>

  <!-- ============================
       ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼šHTMX ã¨é€£æºã—ã¦çŠ¶æ…‹ä¿å­˜ãƒ»å¾©å…ƒãƒ»åˆæœŸåŒ–ãƒ»PDF ãªã©ã‚’å®Ÿè£…
       - ãƒ•ã‚§ãƒ¼ã‚ºé–“ã§ localStorage ã«ä¿å­˜
       - htmx:afterSwap ã‚’æ‹¾ã£ã¦ DOM åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
       - å®‰å…¨ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºã¨æ”¯æ´ãƒãƒŠãƒ¼è¡¨ç¤º
       ============================ -->
  <script>
  (function(){
    'use strict';

    /* -------------------------
       ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
       ------------------------- */
    function escapeHtml(s){
      return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* -------------------------
       localStorage ã‚­ãƒ¼
       ------------------------- */
    const LS_KEY = '3m.formdata.v1';

    /* -------------------------
       ä¿å­˜/èª­ã¿è¾¼ã¿: å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ä¿å­˜
       ï¼ˆtextarea, input[type=text], input[type=number], checkbox ãªã©ï¼‰
       ------------------------- */
    function saveAllFields(){
      try {
        const data = {};
        document.querySelectorAll('textarea, input[type="text"], input[type="number"], input[type="checkbox"]').forEach(el=>{
          if(!el.name && !el.id) return;
          const key = el.name || el.id;
          if(el.type === 'checkbox') data[key] = el.checked;
          else data[key] = el.value;
        });
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      } catch(e){
        console.error('saveAllFields error', e);
      }
    }

    function loadAllFields(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return {};
        const data = JSON.parse(raw);
        Object.keys(data).forEach(k=>{
          const el = document.querySelector(`[name="${k}"], #${CSS.escape(k)}`);
          if(el){
            if(el.type === 'checkbox') el.checked = !!data[k];
            else el.value = data[k];
            // trigger input event for any listeners
            el.dispatchEvent(new Event('input', {bubbles:true}));
          }
        });
        return data;
      } catch(e){
        console.error('loadAllFields error', e);
        return {};
      }
    }

    /* -------------------------
       ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã® splitIntoPieces ã‚’ç°¡æ½”åŒ–ã—ã¦ä½¿ç”¨ï¼‰
       ------------------------- */
    function splitIntoPieces(text, maxPieces){
      if(!text) return Array.from({length:maxPieces},()=> '');
      let pieces = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      pieces = pieces.flatMap(p => p.split(/(?<=[ã€‚ï¼.!?ï¼Ÿ])\s*/));
      pieces = pieces.map(s=>s.trim()).filter(Boolean);
      while(pieces.length > maxPieces){
        let a = pieces.splice(pieces.length-2,2).join(' ');
        pieces.push(a);
      }
      while(pieces.length < maxPieces) pieces.push('');
      return pieces.slice(0,maxPieces);
    }

    /* -------------------------
       è‡ªå‚·ãƒ»è‡ªæ®ºé–¢é€£ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆæ”¯æ´ãƒãƒŠãƒ¼è¡¨ç¤ºï¼‰
       ------------------------- */
    const RISK_WORDS = ['æ­»ã«ãŸã„','è‡ªæ®º','å¸Œæ­»','æ¶ˆãˆãŸã„','é¦–ã‚’','æ®ºã—ã¦','çµ‚ã‚ã‚Šã«ã—ãŸã„','æ­»ã‚“ã§'];
    function containsSelfHarmKeywords(text){
      if(!text) return false;
      const t = text.replace(/\s+/g,'');
      return RISK_WORDS.some(k => t.includes(k));
    }

    function ensureSupportBanner(container){
      // container: element where to insert banner
      const existing = document.getElementById('supportBanner');
      if(existing) return;
      const banner = document.createElement('div');
      banner.id = 'supportBanner';
      banner.style.padding = '10px';
      banner.style.borderRadius = '8px';
      banner.style.marginTop = '10px';
      banner.style.display = 'none';
      container.appendChild(banner);

      // add footer resources too
      const footer = document.createElement('div');
      footer.className = 'card';
      footer.style.marginTop = '12px';
      footer.innerHTML = `
        <h3>æ”¯æ´ãƒ»ç›¸è«‡çª“å£ï¼ˆä¾‹ï¼‰</h3>
        <p class="small">ç·Šæ€¥ã§ãªã„å ´åˆã‚„è©±ã‚’è´ã„ã¦ã»ã—ã„å ´åˆã¯ä¸‹ã®çª“å£ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ <span class="small">ï¼ˆåœ°åŸŸã«ã‚ˆã£ã¦çª“å£ã‚„ç•ªå·ã¯ç•°ãªã‚Šã¾ã™ï¼‰</span></p>
        <ul class="small">
          <li>TELL Lifelineï¼ˆè‹±èªï¼‰: +81-3-5774-0992ï¼ˆã‚¦ã‚§ãƒ–ã§Lifelineã®æ™‚é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</li>
          <li>ã„ã®ã¡ã®é›»è©±ï¼ˆåœ°åŸŸçª“å£ï¼‰: å„åœ°åŸŸã§24æ™‚é–“ç›¸è«‡ã‚’æä¾›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆè‡ªæ²»ä½“ã®æ¡ˆå†…ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰</li>
          <li>ç·Šæ€¥ãªã‚‰: 119ï¼ˆæ•‘æ€¥ï¼‰ / 110ï¼ˆè­¦å¯Ÿï¼‰</li>
        </ul>
      `;
      container.appendChild(footer);
    }

    /* -------------------------
       ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥åˆæœŸåŒ–ãƒ«ãƒ¼ãƒãƒ³
       å„ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒ main ã«å·®ã—æ›¿ãˆã‚‰ã‚ŒãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹
       ------------------------- */
    function initPhase1(){
      // ensure banner area exists
      ensureSupportBanner(document.body);

      // restore rawText if exists
      const data = loadAllFields();
      const raw = data['rawText'] || '';
      const el = document.getElementById('rawText');
      if(el) el.value = raw;

      // watch for input to autosave and risk-detect
      if(el){
        el.oninput = function(){
          saveAllFields();
          const v = el.value || '';
          const banner = document.getElementById('supportBanner');
          if(containsSelfHarmKeywords(v)){
            banner.style.display = 'block';
            banner.innerHTML = '<strong class="danger">ã‚‚ã—ä»Šã™ãã«å±é™ºã‚’æ„Ÿã˜ã¦ã„ã‚‹ãªã‚‰ã€ã„ã¾ã™ãæœ€å¯„ã‚Šã®ç·Šæ€¥é€£çµ¡ï¼ˆ119ï¼‰ã¾ãŸã¯è­¦å¯Ÿï¼ˆ110ï¼‰ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚å°‚é–€ã®ç›¸è«‡ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®æ”¯æ´æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>';
          } else {
            banner.style.display = 'none';
          }
        };
      }
    }

    function initPhase2(){
      // populate elementsList from saved rawText or existing element inputs
      const raw = (loadAllFields()['rawText'] || '').trim();
      const arr = splitIntoPieces(raw, 5);
      const ul = document.getElementById('elementsList');
      ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <input type="text" name="element${i}" id="element${i}" class="elementInput" value="${escapeHtml(t)}" />
          </div>
          <div class="controls">
            <button class="secondary add" data-index="${i}">ï¼‹</button>
            <button class="secondary del" data-index="${i}">ï¼</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // attach handlers for add/del and input autosave
      ul.addEventListener('click', function(ev){
        const btn = ev.target.closest('button');
        if(!btn) return;
        const idx = Number(btn.dataset.index);
        const inputs = Array.from(document.querySelectorAll('.elementInput')).map(i=>i.value);
        if(btn.classList.contains('add')){
          inputs.splice(idx+1,0,'');
        } else if(btn.classList.contains('del')){
          inputs.splice(idx,1);
        }
        while(inputs.length < 5) inputs.push('');
        while(inputs.length > 5) inputs.pop();
        // rebuild
        const newUl = document.getElementById('elementsList');
        newUl.innerHTML = '';
        inputs.forEach((t,i)=>{
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
            <div style="flex:1">
              <label class="small">è¦ç´  ${i+1}</label>
              <input type="text" name="element${i}" id="element${i}" class="elementInput" value="${escapeHtml(t)}" />
            </div>
            <div class="controls">
              <button class="secondary add" data-index="${i}">ï¼‹</button>
              <button class="secondary del" data-index="${i}">ï¼</button>
            </div>
          `;
          newUl.appendChild(li);
        });
        // save
        saveElementsToLS();
      });

      // input autosave listener
      ul.querySelectorAll('.elementInput').forEach(inp=>{
        inp.addEventListener('input', saveElementsToLS);
      });

      // helper: save elements
      function saveElementsToLS(){
        const elems = Array.from(document.querySelectorAll('.elementInput')).map(i=>i.value);
        const data = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
        elems.forEach((v,i)=> data['element'+i] = v);
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      // restore any existing elementN values
      const saved = loadAllFields();
      for(let i=0;i<5;i++){
        const key = 'element'+i;
        const v = saved[key] || '';
        const e = document.getElementById(key);
        if(e) e.value = v;
      }
    }

    function initPhase3(){
      // build priority list from element inputs saved
      const ul = document.getElementById('priorityList');
      ul.innerHTML = '';
      // gather up to 5 elements
      const elems = [];
      for(let i=0;i<5;i++){
        const val = (loadAllFields()['element'+i] || '').trim();
        elems.push(val);
      }
      elems.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <input type="text" class="ptext" name="ptext${i}" id="ptext${i}" value="${escapeHtml(t)}" />
          </div>
          <div style="width:220px">
            <label class="small">ç·Šæ€¥æ€§ (0-5)</label>
            <input type="number" class="urg" name="urg${i}" id="urg${i}" min="0" max="5" value="${escapeHtml((loadAllFields()['urg'+i]||'0'))}" />
            <label class="small">é‡è¦æ€§ (0-5)</label>
            <input type="number" class="imp" name="imp${i}" id="imp${i}" min="0" max="5" value="${escapeHtml((loadAllFields()['imp'+i]||'0'))}" />
            <div style="margin-top:6px"><input type="checkbox" class="pin" name="pin${i}" id="pin${i}" ${ (loadAllFields()['pin'+i] ? 'checked' : '') } /> ãƒ”ãƒ³ç•™ã‚ï¼ˆå¿…ãšæ®‹ã™ï¼‰</div>
          </div>
        `;
        ul.appendChild(li);
      });

      // autosave inputs in this phase
      ul.addEventListener('input', function(){
        saveAllFields();
      });
      ul.addEventListener('change', function(){
        saveAllFields();
      });

      // if user navigates forward, selection of top 3 will be computed in phase4 init
    }

    function initPhase4(){
      // choose top 3 based on urg+imp and pins
      const items = [];
      for(let i=0;i<5;i++){
        const text = (document.getElementById('ptext'+i) && document.getElementById('ptext'+i).value) || (loadAllFields()['ptext'+i] || '');
        const urg = Number((document.getElementById('urg'+i) && document.getElementById('urg'+i).value) || (loadAllFields()['urg'+i]||0));
        const imp = Number((document.getElementById('imp'+i) && document.getElementById('imp'+i).value) || (loadAllFields()['imp'+i]||0));
        const pin = (document.getElementById('pin'+i) && document.getElementById('pin'+i).checked) || !!(loadAllFields()['pin'+i]);
        items.push({text,urg,imp,pin,score:urg+imp});
      }
      items.sort((a,b)=> (b.score - a.score) || (b.imp - a.imp));
      const pinned = items.filter(it=>it.pin);
      let top = items.slice(0,3);
      pinned.forEach(p=>{ if(!top.includes(p)) { top.pop(); top.push(p); }});
      // unique and pad
      top = Array.from(new Set(top)).slice(0,3);
      while(top.length<3) top.push({text:'',urg:0,imp:0,score:0});

      // render orderedList
      const ul = document.getElementById('orderedList');
      ul.innerHTML = '';
      top.forEach((it,idx)=>{
        const li = document.createElement('li');
        li.className = 'item draggable';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">å„ªå…ˆ ${idx+1}</label>
            <input type="text" class="ordtext" name="ord${idx}" id="ord${idx}" value="${escapeHtml(it.text)}" />
          </div>
          <div class="controls">
            <button class="secondary" data-action="up" data-idx="${idx}">â†‘</button>
            <button class="secondary" data-action="down" data-idx="${idx}">â†“</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // up/down logic
      ul.addEventListener('click', function(ev){
        const b = ev.target.closest('button');
        if(!b) return;
        const action = b.dataset.action;
        const idx = Number(b.dataset.idx);
        const inputs = Array.from(document.querySelectorAll('.ordtext')).map(i=>i.value);
        if(action === 'up' && idx>0){ [inputs[idx-1], inputs[idx]] = [inputs[idx], inputs[idx-1]]; }
        if(action === 'down' && idx < inputs.length-1){ [inputs[idx+1], inputs[idx]] = [inputs[idx], inputs[idx+1]]; }
        // rerender
        ul.innerHTML = '';
        inputs.forEach((t,i)=>{
          const li = document.createElement('li');
          li.className = 'item draggable';
          li.innerHTML = `
            <div style="flex:1">
              <label class="small">å„ªå…ˆ ${i+1}</label>
              <input type="text" class="ordtext" name="ord${i}" id="ord${i}" value="${escapeHtml(t)}" />
            </div>
            <div class="controls">
              <button class="secondary" data-action="up" data-idx="${i}">â†‘</button>
              <button class="secondary" data-action="down" data-idx="${i}">â†“</button>
            </div>
          `;
          ul.appendChild(li);
        });
        saveAllFields();
      });

      // save initial ord values
      document.querySelectorAll('.ordtext').forEach(i=> i.addEventListener('input', saveAllFields));
    }

    function initPhase5(){
      // restore intro/closing and ordtexts
      const data = loadAllFields();
      const intro = document.getElementById('intro');
      const closing = document.getElementById('closing');
      if(intro) intro.value = data['intro'] || '';
      if(closing) closing.value = data['closing'] || '';

      // build finalInputs from ordtext values previously selected (phase4)
      const arr = [];
      for(let i=0;i<3;i++){
        const v = (data['ord'+i] || '');
        arr.push(v);
      }
      // fallback: if none, try to load ordtext inputs from page (if swapped)
      const ul = document.getElementById('finalInputs');
      ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">ä¼ãˆã‚‹æ–‡ ${i+1}ï¼ˆçŸ­ãå…·ä½“çš„ã«ï¼‰</label>
            <textarea rows="2" class="finalPiece" name="finalPiece${i}" id="finalPiece${i}">${escapeHtml(t)}</textarea>
          </div>
        `;
        ul.appendChild(li);
      });

      // autosave
      ul.addEventListener('input', saveAllFields);
      if(intro) intro.addEventListener('input', saveAllFields);
      if(closing) closing.addEventListener('input', saveAllFields);
    }

    function initPhase6(){
      // assemble final message from intro, finalPieces, closing
      const data = loadAllFields();
      const intro = data['intro'] || '';
      const pieces = [];
      for(let i=0;i<3;i++){
        pieces.push(data['finalPiece'+i] || data['ord'+i] || '');
      }
      const closing = data['closing'] || '';
      const lines = [];
      if(intro) lines.push(intro);
      pieces.forEach((p,i)=>{ if(p) lines.push((i+1)+'. '+p); });
      if(closing) lines.push(closing);
      const finalTxt = lines.join('\n');
      const finalDiv = document.getElementById('finalMessage');
      if(finalDiv) finalDiv.textContent = finalTxt;

      // copy button
      const copyBtn = document.getElementById('copyBtn');
      if(copyBtn){
        copyBtn.onclick = async function(){
          try {
            await navigator.clipboard.writeText(finalDiv.textContent || '');
            alert('æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
          } catch(e){
            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        };
      }

      // edit button toggles contentEditable
      const editBtn = document.getElementById('editBtn');
      if(editBtn){
        editBtn.onclick = function(){
          finalDiv.contentEditable = finalDiv.contentEditable !== 'true' ? 'true' : 'false';
          finalDiv.focus();
          // if made editable, track changes into localStorage
          if(finalDiv.contentEditable === 'true'){
            finalDiv.addEventListener('input', function onInput(){
              // save as finalPiece0 (single string)
              const d = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
              d['finalManual'] = finalDiv.textContent;
              localStorage.setItem(LS_KEY, JSON.stringify(d));
            }, {once:false});
          } else {
            // when finishing edit, save
            const d = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
            d['finalManual'] = finalDiv.textContent;
            localStorage.setItem(LS_KEY, JSON.stringify(d));
          }
        };
      }

      // reset button clears localStorage and reloads the first fragment
      const resetBtn = document.getElementById('resetBtn');
      if(resetBtn){
        resetBtn.onclick = function(){
          if(!confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) return;
          localStorage.removeItem(LS_KEY);
          // navigate back to phase1 via htmx
          htmx.ajax('GET', 'index.html #frag-phase1', {target:'#main', swap:'innerHTML'});
        };
      }

      // PDF button: add once (only in phase6)
      if(!document.getElementById('pdfBtn')){
        const pdfBtn = document.createElement('button');
        pdfBtn.className = 'btn';
        pdfBtn.id = 'pdfBtn';
        pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜';
        pdfBtn.style.marginLeft = '8px';
        // append to controls
        const controls = document.querySelector('#phase6 > div[style*="gap:8px"]');
        if(controls) controls.appendChild(pdfBtn);

        pdfBtn.addEventListener('click', generatePdfSafely);
      }
    }

    /* -------------------------
       PDF ç”Ÿæˆï¼ˆhtml2canvas + jsPDF ã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼‰
       å®‰å…¨å¯¾ç­–: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã‚ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã€ãƒ¦ãƒ¼ã‚¶ã«é€šçŸ¥
       ------------------------- */
    async function loadScript(src, globalNameCheck){
      if(globalNameCheck && window[globalNameCheck]) return;
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load '+src));
        document.head.appendChild(s);
      });
    }

    async function generatePdfSafely(){
      const btn = document.getElementById('pdfBtn');
      if(btn) { btn.disabled = true; btn.textContent = 'PDFç”Ÿæˆä¸­...'; }
      try {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', 'html2canvas');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', 'jsPDF');

        const { jsPDF } = window.jspdf;

        // make a visually pleasing card to capture
        const card = document.createElement('div');
        card.style.padding = '20px';
        card.style.background = 'white';
        card.style.borderRadius = '12px';
        card.style.boxShadow = '0 6px 18px rgba(20,30,60,0.08)';
        card.style.width = '700px';
        card.style.fontFamily = 'system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif';
        const finalDiv = document.getElementById('finalMessage');
        const contentText = finalDiv ? finalDiv.textContent : '';
        card.innerHTML = `
          <h2 style="text-align:center; color:#1565d8; margin-bottom:10px;">ğŸ§  3M â€” My Message About My Mind</h2>
          <div style="white-space:pre-wrap; color:#111; line-height:1.7;">${escapeHtml(contentText)}</div>
          <hr style="margin:20px 0;">
          <p style="font-size:12px; text-align:center; color:#666;">Generated safely by 3M â€” Mental Message Maker</p>
        `;
        document.body.appendChild(card);
        // ensure images/fonts rendered
        const canvas = await html2canvas(card, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');

        const pdf = new jsPDF({orientation:'p', unit:'px', format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth - 40;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
        pdf.save('3M_Message.pdf');
        document.body.removeChild(card);
      } catch(e){
        console.error(e);
        alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } finally {
        if(btn) { btn.disabled = false; btn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜'; }
      }
    }

    /* -------------------------
       HTMX ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
       - afterSwap: ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒ main ã«å·®ã—æ›¿ã‚ã£ãŸå¾Œã«ãƒ•ã‚§ãƒ¼ã‚ºå›ºæœ‰åˆæœŸåŒ–ã‚’è¡Œã†
       - beforeRequest / afterRequest ã‚’ç”¨ã„ãŸæ½œåœ¨çš„ã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼ˆè»½é‡ï¼‰
       ------------------------- */
    document.body.addEventListener('htmx:afterSwap', function(evt){
      // when a fragment was swapped into #main, initialize it
      // determine which fragment was swapped by looking at evt.detail.target
      const target = evt.detail.target; // the element that was swapped
      // main å†…ã«å­˜åœ¨ã™ã‚‹ç‰¹å®šã® id ã‚’è¦‹ã¦åˆ¤æ–­
      if(document.getElementById('phase1')){
        initPhase1();
      }
      if(document.getElementById('phase2')){
        initPhase2();
      }
      if(document.getElementById('phase3')){
        initPhase3();
      }
      if(document.getElementById('phase4')){
        initPhase4();
      }
      if(document.getElementById('phase5')){
        initPhase5();
      }
      if(document.getElementById('phase6')){
        initPhase6();
      }
    });

    // Save on any htmx request (navigate away) to minimize data loss
    document.body.addEventListener('htmx:beforeRequest', function(){
      saveAllFields();
    });

    // fallback: save periodically (every 5s) to guard against accidental closure
    setInterval(saveAllFields, 5000);

    // On initial load, if localStorage contains data, we might want to auto-restore into phase1 view.
    // The initial hx-get will load frag-phase1 and then htmx:afterSwap will call initPhase1 which restores fields.

    // Ensure graceful degradation: if HTMX isn't available for any reason, show all fragments sequentially (non-hx fallback)
    if(typeof htmx === 'undefined'){
      // reveal phase1 content directly into main
      const main = document.getElementById('main');
      const frag = document.getElementById('frag-phase1');
      if(main && frag) main.innerHTML = frag.innerHTML;
      // call init manually
      initPhase1();
    }

    // End closure
  })();
  </script>
</body>
</html>
