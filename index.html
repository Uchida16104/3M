<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🧠3M — I Message to You About My Mind</title>

  <!-- Tailwind CDN (dynamic) + runtime configuration for color / accessibility adjustments -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config: customize colors & accessible defaults.
    // This is the recommended way to "customize" Tailwind when using the CDN for prototypes.
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50:  '#f5fbff',
              100: '#e6f4ff',
              200: '#cceaff',
              300: '#99d6ff',
              400: '#66c2ff',
              500: '#2898e6', // main blue
              600: '#1f78b4',
              700: '#155871',
              800: '#0e3a48',
              900: '#061f24'
            },
            accent: {
              50: '#fff8f3',
              100:'#fff0e6',
              200:'#ffd9bf',
              300:'#ffc299',
              400:'#ff9f66',
              500:'#ff7a33',
              700:'#b24c22'
            },
            danger: {
              500: '#c62828'
            },
            success: {
              500: '#2e7d32'
            }
          },
          borderRadius: {
            'xl': '1rem'
          }
        },
        fontFamily: {
          sans: ['Noto Sans JP', 'Helvetica', 'Arial', 'sans-serif']
        }
      },
      // Increase contrast defaults for accessibility
      corePlugins: { preflight: true }
    };
  </script>

  <!-- HTMX (no version specified) - as requested -->
  <script src="https://unpkg.com/htmx.org"></script>

  <!-- Utilities for export: html2canvas and jsPDF (UMD) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* A few minimal handcrafted styles to complement Tailwind for readability */
    :root{
      --content-max-width: 980px;
      --card-bg: #ffffff;
    }
    body{ background: linear-gradient(180deg,#fbfdff 0%, #f7fbff 100%); }
    .phase-card { background: var(--card-bg); }
    /* Make textarea visually consistent and accessible */
    textarea { resize: vertical; min-height: 44px; line-height:1.4; }
    /* focus style for accessibility */
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(40,152,230,0.18); border-color: rgb(40,152,230); }
    /* small helper */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Noto Sans JP", monospace; }
    /* keep content a bit narrower on large screens */
    .container-max { max-width: var(--content-max-width); margin-left: auto; margin-right: auto; }
  </style>
</head>
<body class="text-slate-800 antialiased leading-normal">

  <!-- Top Nav -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-sm border-b border-slate-200">
    <div class="container-max px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="#top" class="text-primary-700 font-semibold text-lg mono">🧠3M</a>
        <nav class="hidden md:flex gap-2 items-center ml-4">
          <!-- internal navigation using id anchors + HTMX hint (hx-push-url="true") -->
          <a href="#overview" hx-push-url="true" class="text-sm text-slate-700 hover:text-primary-600 px-2 py-1">Overview</a>
          <a href="#phases" hx-push-url="true" class="text-sm text-slate-700 hover:text-primary-600 px-2 py-1">Phases</a>
          <a href="#safety" hx-push-url="true" class="text-sm text-slate-700 hover:text-primary-600 px-2 py-1">Safety</a>
          <a href="#export" hx-push-url="true" class="text-sm text-slate-700 hover:text-primary-600 px-2 py-1">Export</a>
          <a href="#tech" hx-push-url="true" class="text-sm text-slate-700 hover:text-primary-600 px-2 py-1">Tech</a>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <!-- Emergency quick actions (支援機関の連絡ボタン) -->
        <div class="flex gap-2">
          <!-- phone link for immediate call - prints for desktops -->
          <a id="call-support" href="tel:119" class="px-3 py-1 rounded-xl text-white bg-danger-500 text-sm hover:opacity-95">救急 119</a>
          <a id="call-police" href="tel:110" class="px-3 py-1 rounded-xl text-white bg-primary-600 text-sm hover:opacity-95">警察 110</a>
        </div>

        <button id="print-guide" class="ml-2 px-3 py-1 bg-slate-100 text-sm rounded-xl border border-slate-200 hover:bg-slate-50">印刷用案内</button>
      </div>
    </div>
  </header>

  <main class="container-max px-4 py-8">
    <section id="top" class="mb-6">
      <div class="grid md:grid-cols-3 gap-6 items-start">
        <div class="md:col-span-2">
          <h1 class="text-3xl font-extrabold text-primary-700">🧠3M — I Message to You About My Mind</h1>
          <p class="mt-3 text-slate-700">精神的に混乱したとき、「何を言いたいのかわからない」と言われてしまう人のための思考整理・対話支援ツール。</p>

          <div class="mt-4 flex gap-3">
            <a href="#phases" hx-push-url="true" class="px-4 py-2 rounded-xl bg-primary-500 text-white shadow hover:opacity-95">はじめる</a>
            <button id="save-local-btn" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-50">自動保存を確認</button>
            <button id="export-pdf" class="px-4 py-2 rounded-xl bg-amber-400 text-white hover:opacity-95">PDFで保存</button>
            <button id="export-img" class="px-4 py-2 rounded-xl bg-emerald-500 text-white hover:opacity-95">画像で保存</button>
          </div>
        </div>

        <!-- Safety / Quick help panel -->
        <aside class="phase-card p-4 rounded-xl shadow-sm border border-slate-100">
          <h3 class="text-lg font-semibold">セーフティ機能</h3>
          <p class="mt-2 text-sm text-slate-700">高リスクワード（例：「死にたい」「消えたい」）を検出すると、ページ上部に緊急支援を表示します。ローカル運用が前提です。</p>

          <div class="mt-3 space-y-2">
            <a href="https://www.inochinodenwa.org/?page_id=267" target="_blank" rel="noopener" class="block text-sm text-primary-700 underline">いのちの電話（リンク）</a>
            <a href="tel:119" class="block text-sm text-slate-700">救急：119</a>
            <a href="tel:110" class="block text-sm text-slate-700">警察：110</a>
          </div>

          <div id="safety-banner" class="hidden mt-4 p-3 rounded-lg bg-red-50 border border-red-100 text-red-800">
            <strong>緊急アラート:</strong> 高リスクワードが検出されました。すぐに支援窓口へ連絡してください。
            <div class="mt-2 flex gap-2">
              <a id="safety-call" href="tel:119" class="px-3 py-1 bg-red-600 text-white rounded">今すぐ電話</a>
              <button id="safety-print" class="px-3 py-1 bg-slate-100 rounded border">印刷用案内</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Overview -->
    <section id="overview" class="mb-8" aria-labelledby="overview-title">
      <h2 id="overview-title" class="text-2xl font-bold">概要・コンセプト・3つのM</h2>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="phase-card p-4 rounded-xl border">
          <h3 class="font-semibold">概要</h3>
          <p class="mt-2 text-sm text-slate-700">🧠3M（I Message to You About My Mind）は、「自分の気持ちを整理して、相手に安全に伝える」ことをサポートするアプリです。</p>
        </div>

        <div class="phase-card p-4 rounded-xl border">
          <h3 class="font-semibold">コンセプト / 3つのM</h3>
          <ol class="mt-2 text-sm text-slate-700 list-decimal pl-5 space-y-1">
            <li><strong>Mind</strong> — 自分の気持ちをありのままに書き出す</li>
            <li><strong>Message</strong> — 思考を要素に分解し、優先度をつける</li>
            <li><strong>Move</strong> — 伝える言葉としてまとめ、行動に移す</li>
          </ol>
        </div>
      </div>
    </section>

    <!-- Phases Workspace -->
    <section id="phases" class="mb-10" aria-labelledby="phases-title">
      <h2 id="phases-title" class="text-2xl font-bold">フェーズ（11段階）ワークスペース</h2>

      <div class="mt-4 grid lg:grid-cols-3 gap-4">
        <!-- Left column: phases navigation -->
        <nav class="lg:col-span-1 phase-card p-4 rounded-xl border h-full">
          <h3 class="font-semibold">PHASES</h3>
          <ol class="mt-3 text-sm space-y-2">
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase1" hx-push-url="true">フェーズ1：ありのまま入力</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase2" hx-push-url="true">フェーズ2：要素分解（、。で分割）</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase3" hx-push-url="true">フェーズ3：5要素に絞る</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase4" hx-push-url="true">フェーズ4：必要・不要の仕分け</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase5" hx-push-url="true">フェーズ5：緊急度・重要度の分類</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase6" hx-push-url="true">フェーズ6：上位3つに絞る</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase7" hx-push-url="true">フェーズ7：優先順位づけ</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase8" hx-push-url="true">フェーズ8：構成を組み立てる</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase9" hx-push-url="true">フェーズ9：文章化</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase10" hx-push-url="true">フェーズ10：確認・修正</a></li>
            <li><a class="block px-2 py-1 rounded hover:bg-slate-50" href="#phase11" hx-push-url="true">フェーズ11：完成</a></li>
          </ol>

          <div class="mt-4 text-xs text-slate-600">
            <p>※ 全ての入力欄は <strong>textarea</strong> で統一されています（コピー・長文対応）。</p>
          </div>
        </nav>

        <!-- Middle column: workspace -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Phase 1 -->
          <section id="phase1" class="phase-card p-4 rounded-xl border">
            <h3 class="text-lg font-semibold">フェーズ1：ありのまま入力</h3>
            <p class="text-sm text-slate-600 mt-1">まずは判断せずに思ったことを全部書いてください。改行もそのまま残ります。</p>
            <textarea id="raw-input" class="mt-3 w-full p-3 border rounded-xl focus-ring" placeholder="例：最近眠れない、職場で誤解された気がする、誰かに話したいけどタイミングが分からない..." rows="6"></textarea>

            <div class="mt-3 flex gap-2">
              <button id="split-btn" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ2へ（分解）</button>
              <button id="clear-btn" class="px-3 py-2 rounded-xl bg-slate-100 border">クリア</button>
            </div>
            <p class="text-xs mt-2 text-slate-500">分解は「、」「。」で行います。必要に応じて手動で要素を編集できます。</p>
          </section>

          <!-- Phase 2 -->
          <section id="phase2" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ2：要素分解</h3>
            <p class="text-sm text-slate-600 mt-1">自動で文章を区切り、要素リストを作成します。要素数の上限はありません。</p>

            <div id="elements-list" class="mt-3 space-y-2">
              <!-- dynamically inserted textareas per element -->
            </div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase3" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ3へ（5つ選択）</button>
              <button id="add-element" class="px-3 py-2 rounded-xl bg-slate-100 border">要素を追加</button>
            </div>
          </section>

          <!-- Phase 3: choose 5 -->
          <section id="phase3" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ3：5要素に絞る</h3>
            <p class="text-sm text-slate-600 mt-1">下の要素から最も関連する最大5つを選んでください。</p>
            <div id="choose-5" class="mt-3 grid gap-2"></div>
            <div class="mt-3 flex gap-2">
              <button id="to-phase4" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ4へ（仕分け）</button>
              <button id="back-to-phase2" class="px-3 py-2 rounded-xl bg-slate-100 border">戻る</button>
            </div>
          </section>

          <!-- Phase 4 -->
          <section id="phase4" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ4：必要・不要の仕分け</h3>
            <p class="text-sm text-slate-600 mt-1">選んだ項目を「必要」または「不要」に振り分けます（UI上の切替）。</p>

            <div class="mt-3 grid gap-3">
              <div>
                <h4 class="text-sm font-medium">必要</h4>
                <div id="needed-list" class="mt-2 space-y-2"></div>
              </div>
              <div>
                <h4 class="text-sm font-medium">不要</h4>
                <div id="unneeded-list" class="mt-2 space-y-2"></div>
              </div>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase5" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ5へ（分類）</button>
            </div>
          </section>

          <!-- Phase 5 -->
          <section id="phase5" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ5：緊急度と重要度の分類</h3>
            <p class="text-sm text-slate-600 mt-1">各「必要」項目に緊急度(0-5)・重要度(0-5)を入力してください。自動でスコアを算出します。</p>
            <div id="urgency-list" class="mt-3 space-y-2"></div>

            <div class="mt-3 flex gap-2">
              <button id="score-and-to-6" class="px-3 py-2 rounded-xl bg-primary-500 text-white">スコア算出 → フェーズ6へ</button>
            </div>
          </section>

          <!-- Phase 6 -->
          <section id="phase6" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ6：上位3つに絞る</h3>
            <p class="text-sm text-slate-600 mt-1">スコア上位3つを自動で選出します（手動での入れ替えも可）。</p>

            <div id="top3-list" class="mt-3 space-y-2"></div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase7" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ7へ（並べ替え）</button>
            </div>
          </section>

          <!-- Phase 7 -->
          <section id="phase7" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ7：優先順位づけ</h3>
            <p class="text-sm text-slate-600 mt-1">伝える順番（1→2→3）を決めます。</p>

            <div id="priority-sort" class="mt-3 space-y-2"></div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase8" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ8へ（構成）</button>
            </div>
          </section>

          <!-- Phase 8 -->
          <section id="phase8" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ8：構成を組み立てる</h3>
            <p class="text-sm text-slate-600 mt-1">結論 → 理由 → 希望 の構成を元に骨組みを作成します。</p>

            <div class="mt-3 space-y-2">
              <label class="block text-sm">結論（冒頭）</label>
              <textarea id="structure-claim" class="w-full p-3 border rounded-xl focus-ring" rows="2"></textarea>
              <label class="block text-sm mt-2">理由（中盤）</label>
              <textarea id="structure-reason" class="w-full p-3 border rounded-xl focus-ring" rows="3"></textarea>
              <label class="block text-sm mt-2">希望・お願い（結び）</label>
              <textarea id="structure-ask" class="w-full p-3 border rounded-xl focus-ring" rows="2"></textarea>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase9" class="px-3 py-2 rounded-xl bg-primary-500 text-white">フェーズ9へ（文章化）</button>
            </div>
          </section>

          <!-- Phase 9 -->
          <section id="phase9" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ9：文章化</h3>
            <p class="text-sm text-slate-600 mt-1">構成を組み立てたら、相手に伝わる文章として下書きします。</p>

            <label class="block text-sm">最終下書き</label>
            <textarea id="final-draft" class="w-full p-3 border rounded-xl focus-ring" rows="6" placeholder="ここに伝える文章が自動的に生成されます。手直し可能。"></textarea>

            <div class="mt-3 flex gap-2">
              <button id="preview-btn" class="px-3 py-2 rounded-xl bg-primary-500 text-white">プレビュー（確認）</button>
              <button id="copy-btn" class="px-3 py-2 rounded-xl bg-slate-100 border">コピー</button>
            </div>
          </section>

          <!-- Phase 10 -->
          <section id="phase10" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ10：確認・修正</h3>
            <p class="text-sm text-slate-600 mt-1">文面が穏やかで明確かをチェック。第三者確認用に印刷も可能です。</p>

            <div id="preview-area" class="mt-3 p-3 rounded border bg-slate-50">
              <!-- preview injected here -->
            </div>

            <div class="mt-3 flex gap-2">
              <button id="to-phase11" class="px-3 py-2 rounded-xl bg-primary-500 text-white">完成へ</button>
              <button id="print-preview" class="px-3 py-2 rounded-xl bg-slate-100 border">印刷</button>
            </div>
          </section>

          <!-- Phase 11 -->
          <section id="phase11" class="phase-card p-4 rounded-xl border hidden">
            <h3 class="text-lg font-semibold">フェーズ11：完成</h3>
            <p class="text-sm text-slate-600 mt-1">完成した文章はコピー、印刷、ローカル保存（IndexedDB）できます。送信前に落ち着いて確認しましょう。</p>

            <div class="mt-3">
              <textarea id="final-output" class="w-full p-3 border rounded-xl focus-ring" rows="6" readonly></textarea>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="download-json" class="px-3 py-2 rounded-xl bg-slate-100 border">ローカルJSONをダウンロード</button>
              <button id="done-close" class="px-3 py-2 rounded-xl bg-primary-500 text-white">アプリを閉じる</button>
            </div>
          </section>

        </div>
      </div>
    </section>

    <!-- Export / IndexedDB descriptions & controls -->
    <section id="export" class="mb-8">
      <h2 class="text-2xl font-bold">保存とエクスポート</h2>

      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="phase-card p-4 rounded-xl border">
          <h3 class="font-semibold">自動保存（IndexedDB）</h3>
          <p class="text-sm text-slate-700 mt-2">入力内容は自動でブラウザの IndexedDB に保存されます。README に記載の拡張を踏まえ、PDF と <strong>画像</strong>（PNG）でエクスポート可能です。</p>
          <ul class="mt-3 text-sm text-slate-700 list-disc pl-5 space-y-1">
            <li>自動保存はローカル環境のみ（サーバー送信なし）。</li>
            <li>画像エクスポートは html2canvas、PDF は jsPDF を使用。</li>
            <li>保存は日付付きでバージョン管理（履歴）。</li>
          </ul>
        </div>

        <div class="phase-card p-4 rounded-xl border">
          <h3 class="font-semibold">緊急支援ボタン（運用向け）</h3>
          <p class="text-sm text-slate-700 mt-2">「支援機関の連絡ボタン」は即時発火する設計です。電話リンクか、印刷用案内をすぐに表示できるようにしています。</p>
          <div class="mt-3 flex gap-2">
            <a href="tel:119" class="px-3 py-2 bg-red-600 text-white rounded">救急に電話</a>
            <a href="https://www.inochinodenwa.org/?page_id=267" target="_blank" rel="noopener" class="px-3 py-2 bg-primary-600 text-white rounded">いのちの電話</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Technical stack -->
    <section id="tech" class="mb-8">
      <h2 class="text-2xl font-bold">技術構成</h2>
      <div class="phase-card p-4 rounded-xl border mt-3">
        <ul class="text-sm text-slate-700 list-disc pl-5 space-y-1">
          <li>HTML / CSS / JavaScript（シングルページ、オフライン対応）</li>
          <li>HTMX（クライアント挙動の明示用、<code class="mono">hx-push-url="true"</code> を内部リンクに採用）</li>
          <li>Tailwind CSS（CDN + runtime config でカスタムカラー）</li>
          <li>IndexedDB（自動保存・履歴）</li>
          <li>html2canvas + jsPDF（画像・PDF書き出し）</li>
        </ul>
      </div>
    </section>

    <!-- Footer: usage examples / license / credits (not changed content-wise) -->
    <footer class="mt-10 mb-16 text-sm text-slate-600">
      <div class="phase-card p-4 rounded-xl border">
        <h3 class="font-semibold">使用例 / 想定ユーザー / ライセンス / クレジット</h3>
        <p class="mt-2">（README の「使用例」「想定ユーザー」「ライセンス（MIT）」「クレジット」セクションの内容は変更していません。）</p>

        <div class="mt-3">
          <p>想定ユーザー：精神疾患のある方、支援機関の現場・家族など。</p>
          <p class="mt-2">ライセンス：MIT</p>
        </div>
      </div>
    </footer>
  </main>

  <!-- Minimal unobtrusive scripts implementing required behaviors -->
  <script>
    /* ---------------------------
       Minimal IndexedDB wrapper
       - autoSave() called at key points and periodically
       - stores structured JSON and generated images (base64)
       ---------------------------*/
    const DB_NAME = '🧠3M-db';
    const DB_STORE = 'snapshots';
    let db = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const idb = e.target.result;
          if (!idb.objectStoreNames.contains(DB_STORE)) {
            idb.createObjectStore(DB_STORE, { keyPath: 'id' });
          }
        };
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onerror = () => reject(req.error);
      });
    }

    async function saveSnapshot(snapshot) {
      const idb = await openDB();
      return new Promise((res, rej) => {
        const tx = idb.transaction(DB_STORE, 'readwrite');
        const store = tx.objectStore(DB_STORE);
        store.put(snapshot);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    }

    async function downloadJSON() {
      const state = collectFullState();
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `🧠3M_snapshot_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('download-json').addEventListener('click', downloadJSON);

    /* ---------------------------
       Helpers for splitting into elements (フェーズ2)
       - split by 、 or 。 or newline, trimming results
       ---------------------------*/
    function splitIntoElements(text){
      // Replace full-width punctuation variants and split
      const raw = text.replace(/[\r\n]+/g, '。'); // treat newlines as sentence separators
      const parts = raw.split(/[、。]+/).map(s => s.trim()).filter(Boolean);
      return parts;
    }

    // UI wiring
    const rawInput = document.getElementById('raw-input');
    const splitBtn = document.getElementById('split-btn');
    const elementsList = document.getElementById('elements-list');

    const phaseSections = Array.from(document.querySelectorAll('[id^="phase"]'));
    function showPhase(id) {
      phaseSections.forEach(sec => sec.classList.add('hidden'));
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      // push URL fragment (also let hx-push-url exist on link)
      history.replaceState(null, '', '#' + id);
    }

    splitBtn.addEventListener('click', () => {
      const text = rawInput.value || '';
      const elems = splitIntoElements(text);
      renderElements(elems);
      showPhase('phase2');
      autoSave();
    });

    document.getElementById('clear-btn').addEventListener('click', () => {
      rawInput.value = '';
      elementsList.innerHTML = '';
      autoSave();
    });

    function renderElements(list = []) {
      elementsList.innerHTML = '';
      list.forEach((t, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex gap-2 items-start';
        const ta = document.createElement('textarea');
        ta.className = 'w-full p-2 border rounded-xl focus-ring';
        ta.rows = 2;
        ta.value = t;
        ta.dataset.idx = idx;
        const btns = document.createElement('div');
        btns.className = 'flex flex-col gap-1';
        const del = document.createElement('button');
        del.className = 'px-2 py-1 rounded bg-slate-100 text-xs border';
        del.textContent = '削除';
        del.onclick = () => { wrapper.remove(); autoSave(); };
        btns.appendChild(del);
        wrapper.appendChild(ta);
        wrapper.appendChild(btns);
        elementsList.appendChild(wrapper);
      });
      if (list.length === 0) {
        // provide a blank element to encourage adding
        addElement();
      }
    }

    function addElement(val = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-2 items-start';
      const ta = document.createElement('textarea');
      ta.className = 'w-full p-2 border rounded-xl focus-ring';
      ta.rows = 2;
      ta.placeholder = '要素を入力';
      ta.value = val;
      const btns = document.createElement('div');
      btns.className = 'flex flex-col gap-1';
      const del = document.createElement('button');
      del.className = 'px-2 py-1 rounded bg-slate-100 text-xs border';
      del.textContent = '削除';
      del.onclick = () => { wrapper.remove(); autoSave(); };
      btns.appendChild(del);
      wrapper.appendChild(ta);
      wrapper.appendChild(btns);
      elementsList.appendChild(wrapper);
      ta.addEventListener('input', autoSave);
      autoSave();
    }

    document.getElementById('add-element').addEventListener('click', () => addElement());

    // Phase3: choose up to 5
    const choose5 = document.getElementById('choose-5');
    document.getElementById('to-phase3').addEventListener('click', () => {
      // read elementsList textareas
      const tarr = Array.from(elementsList.querySelectorAll('textarea')).map(ta => ta.value.trim()).filter(Boolean);
      choose5.innerHTML = '';
      tarr.forEach((txt, i) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = txt;
        cb.id = 'choose-' + i;
        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.className = 'text-sm';
        label.textContent = txt;
        row.appendChild(cb);
        row.appendChild(label);
        choose5.appendChild(row);
      });
      showPhase('phase3');
      autoSave();
    });

    // next from phase3 to phase4
    document.getElementById('to-phase4').addEventListener('click', () => {
      const checked = Array.from(choose5.querySelectorAll('input[type=checkbox]:checked')).map(c => c.value);
      if (checked.length === 0) { alert('少なくとも1つ選んでください'); return; }
      // limit to 5
      const selection = checked.slice(0, 5);
      populateNeeded(selection);
      showPhase('phase4');
      autoSave();
    });

    document.getElementById('back-to-phase2').addEventListener('click', () => showPhase('phase2'));

    // Phase4: populate needed/unneeded lists
    const neededList = document.getElementById('needed-list');
    const unneededList = document.getElementById('unneeded-list');

    function populateNeeded(arr) {
      neededList.innerHTML = '';
      unneededList.innerHTML = '';
      arr.forEach(v => {
        const row = makeToggleRow(v);
        neededList.appendChild(row);
      });
    }

    function makeToggleRow(text) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-2 items-start';
      const ta = document.createElement('textarea');
      ta.className = 'w-full p-2 border rounded-xl focus-ring';
      ta.rows = 2;
      ta.value = text;
      const move = document.createElement('button');
      move.className = 'px-2 py-1 rounded bg-slate-100 text-xs border';
      move.textContent = '←→';
      move.onclick = () => {
        if (wrapper.parentElement.id === 'needed-list') {
          unneededList.appendChild(wrapper);
        } else {
          neededList.appendChild(wrapper);
        }
        autoSave();
      };
      wrapper.appendChild(ta);
      wrapper.appendChild(move);
      return wrapper;
    }

    document.getElementById('to-phase5').addEventListener('click', () => {
      // prepare urgency inputs for items in neededList
      const items = Array.from(neededList.querySelectorAll('textarea')).map(ta => ta.value.trim()).filter(Boolean);
      const ul = document.getElementById('urgency-list');
      ul.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 items-center';
        const label = document.createElement('div');
        label.textContent = it;
        const u = document.createElement('input');
        u.type = 'number'; u.min = 0; u.max = 5; u.value = 3; u.className = 'p-2 border rounded';
        const imp = document.createElement('input');
        imp.type = 'number'; imp.min = 0; imp.max = 5; imp.value = 3; imp.className = 'p-2 border rounded';
        row.appendChild(label); row.appendChild(u); row.appendChild(imp);
        ul.appendChild(row);
      });
      showPhase('phase5');
      autoSave();
    });

    // Phase5 -> Phase6 (score)
    document.getElementById('score-and-to-6').addEventListener('click', () => {
      const rows = Array.from(document.getElementById('urgency-list').children);
      const scored = rows.map(r => {
        const label = r.children[0].textContent;
        const u = Number(r.children[1].value || 0);
        const imp = Number(r.children[2].value || 0);
        return { label, score: u + imp, u, imp };
      }).sort((a,b) => b.score - a.score);
      // top3
      const top3 = scored.slice(0,3);
      const top3List = document.getElementById('top3-list');
      top3List.innerHTML = '';
      top3.forEach((t, i) => {
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center';
        const ta = document.createElement('textarea');
        ta.className = 'w-full p-2 border rounded-xl focus-ring';
        ta.rows = 2;
        ta.value = t.label;
        row.appendChild(ta);
        top3List.appendChild(row);
      });
      showPhase('phase6');
      autoSave();
    });

    document.getElementById('to-phase7').addEventListener('click', () => {
      // put top3 into reorderable area
      const arr = Array.from(document.getElementById('top3-list').querySelectorAll('textarea')).map(ta => ta.value);
      const ps = document.getElementById('priority-sort');
      ps.innerHTML = '';
      arr.forEach((val, idx) => {
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center';
        const up = document.createElement('button'); up.textContent = '↑'; up.className='px-2 py-1 border rounded';
        const down = document.createElement('button'); down.textContent = '↓'; down.className='px-2 py-1 border rounded';
        const ta = document.createElement('textarea'); ta.className='w-full p-2 border rounded-xl'; ta.rows=2; ta.value = val;
        up.onclick = () => { const p = row.previousElementSibling; if(p) ps.insertBefore(row, p); autoSave(); };
        down.onclick = () => { const n = row.nextElementSibling; if(n) ps.insertBefore(n, row); autoSave(); };
        row.appendChild(up); row.appendChild(down); row.appendChild(ta);
        ps.appendChild(row);
      });
      showPhase('phase7');
      autoSave();
    });

    document.getElementById('to-phase8').addEventListener('click', () => {
      // fill structure fields with content from priority-sort 1/2/3
      const vals = Array.from(document.getElementById('priority-sort').querySelectorAll('textarea')).map(ta => ta.value);
      document.getElementById('structure-claim').value = vals[0] || '';
      document.getElementById('structure-reason').value = vals[1] || '';
      document.getElementById('structure-ask').value = vals[2] || '';
      showPhase('phase8');
      autoSave();
    });

    document.getElementById('to-phase9').addEventListener('click', () => {
      // simple template: claim + reason + ask
      const claim = document.getElementById('structure-claim').value.trim();
      const reason = document.getElementById('structure-reason').value.trim();
      const ask = document.getElementById('structure-ask').value.trim();
      const draft = `${claim}\n\n理由：${reason}\n\nお願い：${ask}\n\n（話してくれてありがとうございます。どう思いますか？）`;
      document.getElementById('final-draft').value = draft;
      showPhase('phase9');
      autoSave();
    });

    document.getElementById('preview-btn').addEventListener('click', () => {
      const v = document.getElementById('final-draft').value;
      document.getElementById('preview-area').textContent = v;
      showPhase('phase10');
      autoSave();
    });

    document.getElementById('copy-btn').addEventListener('click', async () => {
      const v = document.getElementById('final-draft').value;
      try {
        await navigator.clipboard.writeText(v);
        alert('コピーしました');
      } catch (e) {
        alert('コピーに失敗しました：' + e.message);
      }
    });

    document.getElementById('to-phase11').addEventListener('click', () => {
      document.getElementById('final-output').value = document.getElementById('final-draft').value;
      showPhase('phase11');
      autoSave();
    });

    document.getElementById('print-preview').addEventListener('click', () => window.print());
    document.getElementById('done-close').addEventListener('click', () => { alert('完了。必要ならコピーや保存を行ってください。'); });

    // Export to PDF & Image: global area to snapshot main container
    const exportTargetSelector = 'main.container-max';

    async function exportAsImage(){
      const el = document.querySelector(exportTargetSelector);
      if(!el) return alert('エリアが見つかりません');
      const canvas = await html2canvas(el, { scale: 2, useCORS: true });
      const dataUrl = canvas.toDataURL('image/png');
      // store into IndexedDB snapshot also (base64)
      const snapshot = {
        id: 'snapshot-' + new Date().toISOString(),
        type: 'image',
        createdAt: new Date().toISOString(),
        dataUrl
      };
      await saveSnapshot(snapshot);
      // trigger download
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `🧠3M_snapshot_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function exportAsPDF(){
      const el = document.querySelector(exportTargetSelector);
      if(!el) return alert('エリアが見つかりません');
      const canvas = await html2canvas(el, { scale: 2, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      // A4 width calculation
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      // scale to fit
      const imgProps = pdf.getImageProperties(imgData);
      const imgRatio = imgProps.width / imgProps.height;
      const pdfWidth = pageWidth - 20; // margins
      const pdfHeight = pdfWidth / imgRatio;
      pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
      const blob = pdf.output('blob');
      const url = URL.createObjectURL(blob);
      // save metadata to IndexedDB (store as blob -> convert to base64 for compatibility)
      const reader = new FileReader();
      reader.onload = async function(e){
        const dataUrl = e.target.result;
        await saveSnapshot({
          id: 'snapshot-' + new Date().toISOString(),
          type: 'pdf',
          createdAt: new Date().toISOString(),
          dataUrl
        });
      };
      reader.readAsDataURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `🧠3M_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    document.getElementById('export-img').addEventListener('click', exportAsImage);
    document.getElementById('export-pdf').addEventListener('click', exportAsPDF);

    /* ---------------------------
       Auto-save & safety detection
       - detect high-risk words and show safety banner
       ---------------------------*/
    const HIGH_RISK_WORDS = ['死にたい','消えたい','死に','自殺','自ら命','殺す']; // extendable
    async function autoSave(){
      try {
        const state = collectFullState();
        const snapshot = {
          id: 'autosave-' + new Date().toISOString(),
          createdAt: new Date().toISOString(),
          type: 'autosave',
          state
        };
        await saveSnapshot(snapshot);
      } catch(e){ console.warn('autosave failed', e); }
      checkSafety();
    }

    function collectFullState() {
      // aggregate all textarea values for storage
      const allTextareas = Array.from(document.querySelectorAll('textarea'));
      const data = {};
      allTextareas.forEach(ta => {
        // use unique ids where available
        const key = ta.id || ('ta-' + Math.random().toString(36).slice(2,8));
        data[key] = ta.value;
      });
      return {
        urlHash: location.hash || '',
        savedAt: new Date().toISOString(),
        fields: data
      };
    }

    function checkSafety(){
      const textAll = Object.values(collectFullState().fields).join(' ');
      const found = HIGH_RISK_WORDS.filter(w => textAll.includes(w));
      const banner = document.getElementById('safety-banner');
      if (found.length > 0) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }

    // Periodic autosave
    setInterval(autoSave, 10_000); // every 10s

    // call autoSave on input changes
    document.addEventListener('input', (e) => {
      if (e.target && e.target.tagName === 'TEXTAREA') {
        autoSave();
      }
    });

    // initial show phase1
    showPhase('phase1');

    // wired UI: save-local button checks DB
    document.getElementById('save-local-btn').addEventListener('click', async () => {
      try {
        await openDB();
        alert('IndexedDB が利用可能です。自動保存が有効になっています。');
      } catch(e) {
        alert('IndexedDB にアクセスできません：' + e.message);
      }
    });

    // Print guide behavior
    document.getElementById('print-guide').addEventListener('click', () => {
      const guide = `支援機関の連絡用メモ\n\nいのちの電話：https://www.inochinodenwa.org/?page_id=267\n救急：119\n警察：110\n\nこのメモを印刷して支援機関に渡してください。`;
      const w = window.open('', '_blank');
      w.document.write('<pre style="font-size:16px;white-space:pre-wrap;">' + guide + '</pre>');
      w.print();
    });

    // safety banner print
    document.getElementById('safety-print').addEventListener('click', () => {
      const w = window.open('', '_blank');
      const html = `<h3>緊急支援案内</h3><p>いのちの電話：<a href="https://www.inochinodenwa.org/?page_id=267">https://www.inochinodenwa.org/?page_id=267</a></p><p>救急：119</p><p>警察：110</p>`;
      w.document.write(html);
      w.print();
    });

    // safety call button inside banner
    document.getElementById('safety-call').addEventListener('click', () => {
      // this is already a tel: link; just also auto focus
      window.location.href = document.getElementById('safety-call').href;
    });

    // small helper: saving current UI as a snapshot quickly
    async function quickSnapshot(){
      const snapshot = {
        id: 'quick-' + new Date().toISOString(),
        createdAt: new Date().toISOString(),
        state: collectFullState()
      };
      await saveSnapshot(snapshot);
      alert('瞬間保存しました');
    }

    // wire quick save to export buttons too
    document.getElementById('export-img').addEventListener('click', quickSnapshot);
    document.getElementById('export-pdf').addEventListener('click', quickSnapshot);

    // allow pressing enter in certain contexts? keep default behavior.
    // finalize: ensure history hash navigation supports HTMX push hints (developer-visible)
    // (HTMX is included and hx-push-url="true" is applied to anchors above as explicit integration points.)
  </script>

  <!-- END -->
</body>
</html>
