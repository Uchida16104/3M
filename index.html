<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🧠 3M — I Message to You About My Mind.</title>
  <style>
    :root{font-family: system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    body{padding:20px;max-width:900px;margin:0 auto;background:#f7f9fb;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{margin-top:0;color:#444}
    textarea,input[type=text]{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ccd;border-radius:8px}
    .card{background:white;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    ul{padding-left:18px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button{background:#1565d8;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    .small{font-size:13px;color:#666}
    .item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .item .controls{display:flex;flex-direction:column;gap:6px}
    .draggable{cursor:grab}
    .final{white-space:pre-wrap;background:#0b1220;color:#e8f0ff;padding:12px;border-radius:8px}
    .danger{color:#b00020}
  </style>
</head>
<body>
  <h1>🧠 3M — I Message to You About My Mind.</h1>
  <p class="lead">考えがまとまらないときに、話す内容を段階的に整理して相手に伝えるためのツールです。下のフェーズに沿って進めてください。</p>

  <!-- フェーズ1 -->
  <section class="card" id="phase1">
    <h2>フェーズ1 — ありのまま入力</h2>
    <p class="small">思ったことをそのまま書き出します（長文可）。</p>
    <textarea id="rawText" rows="6" placeholder="ここに思っていることを自由に書いてください..."></textarea>
    <div style="margin-top:10px"><button id="toPhase2">5つに分解する → フェーズ2</button></div>
  </section>

  <!-- フェーズ2 -->
  <section class="card" id="phase2" style="display:none">
    <h2>フェーズ2 — 5つの要素に分解</h2>
    <p class="small">入力を自動で文や句に分割します。編集して1要素ずつ丁寧に整えてください（空欄は追加できます）。</p>
    <ul id="elementsList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo1" class="secondary">戻る</button>
      <button id="toPhase3">優先度チェック → フェーズ3</button>
    </div>
  </section>

  <!-- フェーズ3 -->
  <section class="card" id="phase3" style="display:none">
    <h2>フェーズ3 — 緊急度と優先順位で上位3つに絞る</h2>
    <p class="small">それぞれの要素について、緊急性（0-5）と重要性（0-5）を入力してください。自動的に合計スコアで上位3つが選ばれます。手動でピン留めも可能です。</p>
    <ul id="priorityList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo2" class="secondary">戻る</button>
      <button id="toPhase4">3つに絞る → フェーズ4</button>
    </div>
  </section>

  <!-- フェーズ4 -->
  <section class="card" id="phase4" style="display:none">
    <h2>フェーズ4 — 3つの要素に優先順位を付ける</h2>
    <p class="small">上下ボタンで順序を調整してください（上が伝える順序の優先度高）。</p>
    <ul id="orderedList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo3" class="secondary">戻る</button>
      <button id="toPhase5">文章を組み立てる → フェーズ5</button>
    </div>
  </section>

  <!-- フェーズ5 -->
  <section class="card" id="phase5" style="display:none">
    <h2>フェーズ5 — 相手に伝える文章を作る</h2>
    <p class="small">選ばれた3つを短く、具体的な一言ずつにまとめます。相手に伝えるときの冒頭（目的）と最後（お願い／確認）も用意します。</p>
    <div>
      <label class="small">冒頭（目的）</label>
      <input type="text" id="intro" placeholder="例：今日は○○について話したくて来ました。">
    </div>
    <ul id="finalInputs"></ul>
    <div style="margin-top:8px">
      <label class="small">締め（お願い／確認）</label>
      <input type="text" id="closing" placeholder="例：これについてどう思いますか？／助けてほしいです。">
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo4" class="secondary">戻る</button>
      <button id="toPhase6">完成 → フェーズ6</button>
    </div>
  </section>

  <!-- フェーズ6 -->
  <section class="card" id="phase6" style="display:none">
    <h2>フェーズ6 — 完成</h2>
    <p class="small">下が相手に伝えるための最終文章です。編集もできます。</p>
    <div class="final" id="finalMessage" contenteditable="false"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="copyBtn">コピー</button>
      <button id="editBtn" class="secondary">編集する</button>
      <button id="resetBtn" class="secondary">最初からやり直す</button>
    </div>
  </section>

  <script>
    // ユーティリティ: 文の分割（日本語・英語対応）
    function splitIntoPieces(text, maxPieces){
      if(!text) return Array.from({length:maxPieces},()=>"");
      // まず行で分割
      let pieces = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      // さらに文末句読点で分割
      pieces = pieces.flatMap(p => p.split(/(?<=[。．.!?？])\s*/));
      pieces = pieces.map(s=>s.trim()).filter(Boolean);
      // If still more than maxPieces, join short ones
      if(pieces.length > maxPieces){
        // try to merge from end
        while(pieces.length > maxPieces){
          let a = pieces.splice(pieces.length-2,2).join(' ');
          pieces.push(a);
        }
      }
      // pad
      while(pieces.length < maxPieces) pieces.push("");
      return pieces.slice(0,maxPieces);
    }

    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // Phase 1 -> 2
    qs('#toPhase2').addEventListener('click', ()=>{
      const raw = qs('#rawText').value.trim();
      const arr = splitIntoPieces(raw,5);
      const ul = qs('#elementsList'); ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `\n          <div style="flex:1">\n            <label class="small">要素 ${i+1}</label>\n            <input type="text" data-index="${i}" class="elementInput" value="${escapeHtml(t)}" />\n          </div>\n          <div class="controls">\n            <button class="secondary" data-action="add" data-index="${i}">＋</button>\n            <button class="secondary" data-action="del" data-index="${i}">－</button>\n          </div>\n        `;
        ul.appendChild(li);
      });
      qs('#phase1').style.display='none'; qs('#phase2').style.display='block';
    });

    qs('#backTo1').addEventListener('click', ()=>{qs('#phase2').style.display='none';qs('#phase1').style.display='block';});

    // allow add/delete element fields
    qs('#elementsList').addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const action = b.dataset.action; const idx = Number(b.dataset.index);
      const inputs = qsa('.elementInput').map(x=>x.value);
      if(action==='add') inputs.splice(idx+1,0,'');
      if(action==='del') inputs.splice(idx,1);
      // normalize to 5 slots
      while(inputs.length < 5) inputs.push('');
      while(inputs.length > 5) inputs.pop();
      // rebuild
      const ul = qs('#elementsList'); ul.innerHTML='';
      inputs.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item'; li.innerHTML=`\n          <div style="flex:1">\n            <label class="small">要素 ${i+1}</label>\n            <input type="text" data-index="${i}" class="elementInput" value="${escapeHtml(t)}" />\n          </div>\n          <div class="controls">\n            <button class="secondary" data-action="add" data-index="${i}">＋</button>\n            <button class="secondary" data-action="del" data-index="${i}">－</button>\n          </div>`;
        ul.appendChild(li);
      });
    });

    // Phase2 -> Phase3
    qs('#toPhase3').addEventListener('click', ()=>{
      const elems = qsa('.elementInput').map(i=>i.value.trim()).filter(Boolean);
      // ensure we still have 5 slots (including empty)
      const full = qsa('.elementInput').map(i=>i.value.trim());
      const ul = qs('#priorityList'); ul.innerHTML='';
      full.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `\n          <div style="flex:1">\n            <label class="small">要素 ${i+1}</label>\n            <input type="text" class="ptext" data-i="${i}" value="${escapeHtml(t)}" />\n          </div>\n          <div style="width:220px">\n            <label class="small">緊急性 (0-5)</label>\n            <input type="number" class="urg" min="0" max="5" value="0" />\n            <label class="small">重要性 (0-5)</label>\n            <input type="number" class="imp" min="0" max="5" value="0" />\n            <div style="margin-top:6px"><input type="checkbox" class="pin" /> ピン留め（必ず残す）</div>\n          </div>\n        `;
        ul.appendChild(li);
      });
      qs('#phase2').style.display='none'; qs('#phase3').style.display='block';
    });

    qs('#backTo2').addEventListener('click', ()=>{qs('#phase3').style.display='none';qs('#phase2').style.display='block';});

    // Phase3 -> Phase4 (select top3)
    qs('#toPhase4').addEventListener('click', ()=>{
      const items = qsa('#priorityList .item').map(li=>{
        const text = li.querySelector('.ptext').value.trim();
        const urg = Number(li.querySelector('.urg').value)||0;
        const imp = Number(li.querySelector('.imp').value)||0;
        const pin = li.querySelector('.pin').checked;
        return {text,urg,imp,pin,score:urg+imp};
      }).filter(x=>x.text);
      // if none, block
      if(items.length===0){alert('要素が1つもありません。フェーズ2に戻って要素を入力してください。'); return;}
      // sort
      items.sort((a,b)=> (b.score - a.score) || (b.imp - a.imp));
      // make sure pinned ones included
      const pinned = items.filter(i=>i.pin);
      let top = items.slice(0,3);
      // ensure pinned included
      pinned.forEach(p=>{ if(!top.includes(p)) { top.pop(); top.push(p); } });
      // unique and trim
      top = Array.from(new Set(top)).slice(0,3);
      // if less than 3, pad with empty
      while(top.length<3) top.push({text:'',urg:0,imp:0,score:0});

      // render orderedList
      const ul = qs('#orderedList'); ul.innerHTML='';
      top.forEach((it,idx)=>{
        const li = document.createElement('li'); li.className='item draggable';
        li.innerHTML = `\n          <div style="flex:1">\n            <label class="small">優先 ${idx+1}</label>\n            <input type="text" class="ordtext" data-idx="${idx}" value="${escapeHtml(it.text)}" />\n          </div>\n          <div class="controls">\n            <button class="secondary" data-action="up" data-idx="${idx}">↑</button>\n            <button class="secondary" data-action="down" data-idx="${idx}">↓</button>\n          </div>\n        `;
        ul.appendChild(li);
      });

      qs('#phase3').style.display='none'; qs('#phase4').style.display='block';
    });

    qs('#backTo3').addEventListener('click', ()=>{qs('#phase4').style.display='none';qs('#phase3').style.display='block';});

    // reorder up/down
    qs('#orderedList').addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const action = b.dataset.action; const idx = Number(b.dataset.idx);
      const inputs = qsa('.ordtext').map(i=>i.value);
      if(action==='up' && idx>0){ [inputs[idx-1],inputs[idx]] = [inputs[idx],inputs[idx-1]]; }
      if(action==='down' && idx < inputs.length-1){ [inputs[idx+1],inputs[idx]] = [inputs[idx],inputs[idx+1]]; }
      // rerender
      const ul = qs('#orderedList'); ul.innerHTML='';
      inputs.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item draggable'; li.innerHTML = `\n          <div style="flex:1">\n            <label class="small">優先 ${i+1}</label>\n            <input type="text" class="ordtext" data-idx="${i}" value="${escapeHtml(t)}" />\n          </div>\n          <div class="controls">\n            <button class="secondary" data-action="up" data-idx="${i}">↑</button>\n            <button class="secondary" data-action="down" data-idx="${i}">↓</button>\n          </div>`;
        ul.appendChild(li);
      });
    });

    // Phase4 -> Phase5
    qs('#toPhase5').addEventListener('click', ()=>{
      const arr = qsa('.ordtext').map(i=>i.value.trim()).filter(Boolean);
      if(arr.length===0){ alert('優先する要素がありません。戻って要素を整理してください。'); return; }
      const ul = qs('#finalInputs'); ul.innerHTML='';
      arr.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item'; li.innerHTML = `\n          <div style="flex:1">\n            <label class="small">伝える文 ${i+1}（短く具体的に）</label>\n            <textarea rows="2" class="finalPiece">${escapeHtml(t)}</textarea>\n          </div>`;
        ul.appendChild(li);
      });
      qs('#phase4').style.display='none'; qs('#phase5').style.display='block';
    });

    qs('#backTo4').addEventListener('click', ()=>{qs('#phase5').style.display='none';qs('#phase4').style.display='block';});

    // Phase5 -> Phase6
    qs('#toPhase6').addEventListener('click', ()=>{
      const intro = qs('#intro').value.trim();
      const closing = qs('#closing').value.trim();
      const pieces = qsa('.finalPiece').map(t=>t.value.trim()).filter(Boolean);
      const final = buildFinalMessage(intro,pieces,closing);
      qs('#finalMessage').textContent = final;
      qs('#phase5').style.display='none'; qs('#phase6').style.display='block';
    });

    qs('#backTo3'); // noop

    // copy
    qs('#copyBtn').addEventListener('click', ()=>{
      const txt = qs('#finalMessage').textContent;
      navigator.clipboard?.writeText(txt).then(()=>alert('文章をコピーしました。'));    
    });
    qs('#editBtn').addEventListener('click', ()=>{ qs('#finalMessage').contentEditable = true; qs('#finalMessage').focus(); });
    qs('#resetBtn').addEventListener('click', ()=>{ if(confirm('最初からやり直しますか？')) location.reload(); });

    // helpers
    function buildFinalMessage(intro,pieces,closing){
      const lines = [];
      if(intro) lines.push(intro);
      pieces.forEach((p,i)=>{
        // short prefix like "1.", but keep concise
        lines.push((i+1) + '. ' + p);
      });
      if(closing) lines.push(closing);
      return lines.join('\n');
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // Warn: if certain keywords appear (suicide), show resource hint
    function containsSelfHarmKeywords(text){
      if(!text) return false;
      const keywords = ['死にたい','自殺','希死','消えたい','首を','殺して','終わりにしたい','死んで'];
      const t = text.replace(/\s+/g,'');
      return keywords.some(k=>t.includes(k));
    }

    // Monitor rawText for high-risk words and show a subtle warning banner
    const banner = document.createElement('div'); banner.style.padding='10px'; banner.style.borderRadius='8px'; banner.style.marginTop='10px';
    document.body.insertBefore(banner, document.body.firstChild.nextSibling);
    banner.style.display='none';

    qs('#rawText').addEventListener('input', ()=>{
      const v = qs('#rawText').value;
      if(containsSelfHarmKeywords(v)){
        banner.style.display='block'; banner.innerHTML = '<strong class="danger">もし今すぐに危険を感じているなら、いますぐ最寄りの緊急連絡（119）または警察（110）へ連絡してください。専門の相談も利用できます。ページ下部の支援情報を確認してください。</strong>';
      } else { banner.style.display='none'; }
    });

    // add a small footer with resources (static list)
    const footer = document.createElement('div'); footer.className='card'; footer.style.marginTop='20px'; footer.innerHTML = `
      <h3>支援・相談窓口（例）</h3>
      <p class="small">緊急でない場合や話を聴いてほしい場合は下の窓口も利用できます。 <span class="small">（地域によって窓口や番号は異なります）</span></p>
      <ul class="small">
        <li>TELL Lifeline（英語）: +81-3-5774-0992（ウェブでLifelineの時間を確認してください）</li>
        <li>いのちの電話（地域窓口）: 各地域で24時間相談を提供する場合があります（自治体の案内をご確認ください）</li>
        <li>緊急なら: 119（救急） / 110（警察）</li>
      </ul>
    `;
    document.body.appendChild(footer);

    const pdfBtn = document.createElement('button');
    pdfBtn.textContent = '🖨️ PDFとして保存';
    pdfBtn.style.marginLeft = '8px';
    pdfBtn.id = 'pdfBtn';
    qs('#phase6').querySelector('div[style*="gap:8px"]').appendChild(pdfBtn);

    // jsPDF + html2canvasをCDNから動的ロード
    async function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function ensureLibs(){
      if(!window.html2canvas){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      }
      if(!window.jspdf){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      }
    }

    pdfBtn.addEventListener('click', async ()=>{
      try {
        pdfBtn.disabled = true;
        pdfBtn.textContent = 'PDF生成中...';

        await ensureLibs();

        const { jsPDF } = window.jspdf;

        // カード風に装飾された要素を作成してキャプチャ
        const card = document.createElement('div');
        card.style.padding = '20px';
        card.style.background = 'white';
        card.style.borderRadius = '12px';
        card.style.boxShadow = '0 6px 18px rgba(20,30,60,0.08)';
        card.style.width = '700px';
        card.style.fontFamily = 'system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif';
        card.innerHTML = `
          <h2 style="text-align:center; color:#1565d8; margin-bottom:10px;">🧠 3M — My Message About My Mind</h2>
          <div style="white-space:pre-wrap; color:#111; line-height:1.7;">${escapeHtml(qs('#finalMessage').textContent)}</div>
          <hr style="margin:20px 0;">
          <p style="font-size:12px; text-align:center; color:#666;">Generated safely by 3M — Mental Message Maker</p>
        `;
        document.body.appendChild(card);

        const canvas = await html2canvas(card, {scale:2});
        const imgData = canvas.toDataURL('image/png');

        const pdf = new jsPDF({orientation:'p', unit:'px', format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgWidth = pageWidth - 40;
        const imgHeight = canvas.height * imgWidth / canvas.width;

        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
        pdf.save('3M_Message.pdf');

        document.body.removeChild(card);
        pdfBtn.textContent = '🖨️ PDFとして保存';
        pdfBtn.disabled = false;
      } catch(err){
        console.error(err);
        alert('PDF生成中にエラーが発生しました。再度お試しください。');
        pdfBtn.textContent = '🖨️ PDFとして保存';
        pdfBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
