<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🧠3M — I Message to You About My Mind</title>

  <!-- Tailwind (CDN) with on-the-fly customization for colors / accessibility -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* Tailwind runtime configuration:
       - Adds accessible color palette tweaks
       - Enlarges default focus outlines for keyboard users
       - Keeps minimal changes to structure to respect original design */
    tailwind.config = {
      darkMode: false,
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f7fbfb',
              100: '#eef6f6',
              200: '#cfecec',
              300: '#9fd9d9',
              400: '#4fbaba',
              500: '#169999',
              600: '#167a7a',
              700: '#125f5f',
              800: '#0e4848',
              900: '#082f2f'
            },
            accent: {
              50: '#fff6f0',
              100: '#ffead9',
              200: '#ffd0b3',
              300: '#ffb080',
              400: '#ff8a44',
              500: '#ff661a',
              600: '#e65100',
              700: '#b43c00',
              800: '#862d00',
              900: '#5b2000'
            }
          },
          ringWidth: {
            DEFAULT: '4px'
          }
        }
      },
      plugins: [
        function ({ addUtilities }) {
          addUtilities({
            '.focus-ring': {
              outline: 'none',
              boxShadow: '0 0 0 4px rgba(22,153,153,0.12)'
            }
          })
        }
      ]
    }
  </script>

  <!-- HTMX (no version specified, per request) -->
  <script src="https://unpkg.com/htmx.org"></script>

  <!-- Utility libs for export/save: html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="" crossorigin="anonymous"></script>

  <meta name="description" content="🧠3M — I Message to You About My Mind. 思考整理・対話支援ツール。">
  <style>
    /* Small visual polish consistent with original layout but improved spacing/readability */
    html,body { height: 100%; }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    textarea { resize: vertical; min-height: 3rem; line-height: 1.5; }
    /* visually-hidden helper */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }
  </style>
</head>
<body class="bg-brand-50 text-slate-900 leading-relaxed">

  <!-- Emergency banner (hidden until high-risk word detected) -->
  <div id="emergencyBanner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-[min(1000px,95%)]">
    <div class="bg-accent-500 text-white rounded-lg shadow-lg p-4 flex items-center gap-4">
      <div class="flex-1">
        <strong class="block text-lg">緊急のサポートが必要な可能性があります</strong>
        <div class="text-sm">「死にたい」「消えたい」等の表現が検出されました。すぐに支援機関へご連絡ください。</div>
      </div>
      <div class="flex gap-2">
        <!-- Immediate contact buttons (support agency call / print) -->
        <a id="callSupportBtn" class="inline-flex items-center px-4 py-2 bg-white text-accent-600 rounded-md font-semibold focus-ring" href="#" role="button">支援機関に電話</a>
        <button id="printSupportBtn" class="inline-flex items-center px-4 py-2 bg-transparent border border-white text-white rounded-md hover:bg-white/10 focus-ring">印刷</button>
      </div>
    </div>
  </div>

  <!-- Top header -->
  <header class="bg-white/80 backdrop-blur sticky top-0 z-40 border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-md bg-brand-500 flex items-center justify-center text-white font-bold">🧠3M</div>
        <div>
          <h1 class="text-lg font-semibold">🧠3M — I Message to You About My Mind</h1>
          <p class="text-sm text-slate-600">自分の心を整理して、安全に伝える支援ツール</p>
        </div>
      </div>

      <nav class="flex items-center gap-2">
        <!-- Internal navigation via hash (id) + HTMX hx-push-url attribute included explicitly for coders -->
        <!-- hx-get points to the same page with fragment — this will replace #main content on network-enabled hosts.
             We also listen to hashchange in JS to allow purely-local transitions without network calls. -->
        <a href="#mind" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#mind" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Mind</a>
        <a href="#message" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#message" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Message</a>
        <a href="#move" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#move" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Move</a>
        <a href="#about" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#about" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">About</a>
        <button id="saveLocalBtn" class="ml-2 px-3 py-2 bg-brand-500 text-white rounded-md hover:brightness-95 focus-ring">自動保存 / エクスポート</button>
      </nav>
    </div>
  </header>

  <!-- Main content area -->
  <main id="main" class="mx-auto max-w-6xl px-4 py-8 space-y-8">

    <!-- Intro / Overview (kept same content/structure per instruction) -->
    <section id="mind" class="bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">概要</h2>
      <p class="text-slate-700 mb-4">
        🧠3M（読み：「スリーエム」 / I Message to You About My Mind）は、
        「自分の気持ちを整理して、相手に安全に伝える」ことをサポートする自己表現支援アプリです。
      </p>

      <!-- PHASE 1: Raw input -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-slate-700">フェーズ1：ありのまま入力</label>
        <textarea id="rawInput"
                  class="w-full border border-slate-200 rounded-md p-3 focus:ring focus-ring"
                  placeholder="思ったこと・感じたことをそのまま書いてください。"></textarea>
        <div class="flex gap-2">
          <button id="splitBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">要素に分解（、。で区切る）</button>
          <button id="clearBtn" class="px-4 py-2 border rounded-md">クリア</button>
        </div>
        <p class="text-xs text-slate-500">※ 全ての入力欄は textarea を使用しています。</p>
      </div>
    </section>

    <!-- PHASE 2: Elements list (dynamically generated) -->
    <section id="message" class="hidden bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">フェーズ2：要素分解</h2>
      <p class="text-slate-700 mb-4">「、」「。」で区切って自動的に要素化します。要素は追加・編集・削除可能です。</p>

      <ul id="elementsList" class="space-y-2"></ul>

      <div class="mt-4 flex gap-2">
        <button id="toFiveBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">次へ：5要素に絞る</button>
        <button id="addElementBtn" class="px-4 py-2 border rounded-md">要素を追加</button>
      </div>
    </section>

    <!-- PHASE 3..11 UI -->
    <section id="move" class="hidden bg-white rounded-lg shadow p-6 space-y-4">
      <h2 class="text-2xl font-bold">フェーズ：Message → Move（整理と送信準備）</h2>

      <!-- 3: 5 elements selection -->
      <div>
        <h3 class="font-semibold">フェーズ3：5要素に絞る</h3>
        <p class="text-sm text-slate-600">要素リストから重要なものを最大5つ選んでください。</p>
        <ul id="pickFive" class="mt-2 space-y-2"></ul>
      </div>

      <!-- 4: Necessary / Unnecessary -->
      <div>
        <h3 class="font-semibold">フェーズ4：必要・不要の仕分け</h3>
        <p class="text-sm text-slate-600">選ばれた要素を「必要」「不要」に仕分けします。</p>
        <div id="needUnneed" class="mt-2 grid grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium">必要</h4>
            <ul id="needed" class="mt-2 space-y-1"></ul>
          </div>
          <div>
            <h4 class="font-medium">不要</h4>
            <ul id="unneeded" class="mt-2 space-y-1"></ul>
          </div>
        </div>
      </div>

      <!-- 5: Urgency / Importance -->
      <div>
        <h3 class="font-semibold">フェーズ5：緊急度と重要度の分類</h3>
        <p class="text-sm text-slate-600">残った要素に緊急度（0-5）と重要度（0-5）をつけます。</p>
        <div id="priorityTable" class="mt-2 space-y-2"></div>
      </div>

      <!-- 6: Top 3 -->
      <div>
        <h3 class="font-semibold">フェーズ6：上位3つに絞る</h3>
        <p class="text-sm text-slate-600">自動スコアで上位3つを抽出します。</p>
        <ol id="topThree" class="list-decimal ml-5 mt-2 space-y-1"></ol>
        <div class="mt-2">
          <button id="rankBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">スコアを計算して上位3つを表示</button>
        </div>
      </div>

      <!-- 7: Ordering -->
      <div>
        <h3 class="font-semibold">フェーズ7：優先順位づけ</h3>
        <p class="text-sm text-slate-600">上位3つをドラッグで並べ替え、伝える順番を決めます。</p>
        <ul id="orderList" class="mt-2 space-y-2"></ul>
      </div>

      <!-- 8: Structure -->
      <div>
        <h3 class="font-semibold">フェーズ8：構成を組み立てる</h3>
        <p class="text-sm text-slate-600">「結論 → 理由 → 希望」の型で各項目を補足します。</p>
        <div id="structureArea" class="mt-2 space-y-2"></div>
      </div>

      <!-- 9: Compose -->
      <div>
        <h3 class="font-semibold">フェーズ9：文章化</h3>
        <p class="text-sm text-slate-600">下のエリアで最終メッセージの文面を作成します（すべて textarea）。</p>
        <textarea id="finalDraft" class="w-full border border-slate-200 rounded-md p-3 focus-ring" placeholder="最終メッセージをここに作成してください。"></textarea>
      </div>

      <!-- 10: Review -->
      <div>
        <h3 class="font-semibold">フェーズ10：確認・修正</h3>
        <p class="text-sm text-slate-600">誤解を招かないかを確認し、必要なら修正してください。</p>
        <div class="flex gap-2 mt-2">
          <button id="validateBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">自動チェック（感情・攻撃性・高リスクワード）</button>
          <button id="previewBtn" class="px-4 py-2 border rounded-md">プレビュー</button>
        </div>
      </div>

      <!-- 11: Complete -->
      <div>
        <h3 class="font-semibold">フェーズ11：完成</h3>
        <p class="text-sm text-slate-600">完成したらコピー・印刷・画像保存・PDF保存が可能です。</p>
        <div class="flex gap-2 mt-2">
          <button id="copyBtn" class="px-4 py-2 border rounded-md focus-ring">コピー</button>
          <button id="downloadPDFBtn" class="px-4 py-2 bg-accent-500 text-white rounded-md focus-ring">PDFとして保存</button>
          <button id="downloadIMGBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">画像として保存</button>
        </div>
      </div>
    </section>

    <!-- About / README style content (kept same as requested) -->
    <section id="about" class="hidden bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">About / README</h2>
      <div class="prose max-w-none">
        <h3>コンセプト</h3>
        <p>“I Message to You about My Mind.” 自分の心の中を「Iメッセージ」で安全に伝える。</p>

        <h3>3つのM</h3>
        <ol>
          <li>Mind — 自分の気持ちをありのままに書き出す</li>
          <li>Message — 思考を5つ → 3つに整理し、優先度をつける</li>
          <li>Move — 伝える言葉としてまとめ、行動に移す</li>
        </ol>

        <h3>フェーズ構成（11ステップ）</h3>
        <p>（ここでは最終的に11フェーズの流れを採用しています。UIで順に進めてください。）</p>

        <h3>セーフティー機能</h3>
        <ul>
          <li>高リスクワードの自動検出と緊急バナー表示（ローカル）</li>
          <li>「支援機関への連絡」ボタン（電話発信 / 印刷ガイド）を即時発火</li>
          <li>オフラインでも動作するローカル保存（IndexedDB）、エクスポート機能（PDF/画像）</li>
        </ul>

        <h3>支援・相談窓口（リンク）</h3>
        <ul>
          <li>いのちの電話： <a href="https://www.inochinodenwa.org/?page_id=267" class="text-blue-600 underline" target="_blank" rel="noopener">https://www.inochinodenwa.org/?page_id=267</a></li>
          <li>救急： <a href="tel:119" class="text-blue-600 underline">119</a></li>
          <li>警察： <a href="tel:110" class="text-blue-600 underline">110</a></li>
        </ul>

        <h3>技術構成</h3>
        <ul>
          <li>HTML / CSS (Tailwind) / JavaScript / HTMX</li>
          <li>IndexedDB によるローカル自動保存（拡張済み：画像保存を追加）</li>
          <li>エクスポート：PDF（jsPDF） / 画像（html2canvas）</li>
        </ul>

        <h3>ライセンス</h3>
        <p>MIT License（リポジトリに準拠）</p>

        <h3>クレジット</h3>
        <p>Original: Uchida16104 — I Message to You About My Mind.</p>
      </div>
    </section>

    <!-- Footer with accessibility links and credits -->
    <footer class="text-sm text-slate-600 py-8">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <div>
          <div>© 🧠3M — I Message to You About My Mind.</div>
          <div class="mt-1">想定ユーザー：精神疾患を持つ方・支援者など</div>
        </div>
        <div class="flex gap-4">
          <a href="#about" class="underline" hx-get="index.html#about" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">README</a>
          <a href="https://github.com/Uchida16104/🧠3M" class="underline" target="_blank" rel="noopener">GitHub</a>
        </div>
      </div>
    </footer>
  </main>

  <!-- Hidden templates & helpers -->
  <template id="elementRowTemplate">
    <li class="flex gap-2 items-start bg-slate-50 p-3 rounded-md border border-slate-100">
      <textarea class="flex-1 border-none bg-transparent text-slate-800" placeholder="要素の内容"></textarea>
      <div class="flex flex-col gap-1">
        <button class="move-up px-2 py-1 bg-white border rounded text-sm">↑</button>
        <button class="move-down px-2 py-1 bg-white border rounded text-sm">↓</button>
        <button class="mark-del px-2 py-1 bg-red-50 border border-red-200 rounded text-sm text-red-600">削除</button>
      </div>
    </li>
  </template>

  <script>
    /* === Core behaviors ===
       - Parsing into elements (フェーズ2): splits by Japanese comma（、） and period（。） and by English punctuation as fallback.
       - All inputs are textarea by requirement.
       - HTMX hints included: hx-push-url attributes exist on nav anchors; additionally we handle hashchange locally
       - IndexedDB auto-save (autosave every X seconds + on changes) with ability to export PDF and image.
       - Safety scanning for high-risk words shows emergency banner and wires support buttons (phone & print)
       - Minimal DOM changes from original repo; preserves README/sections content structure.
    */

    // Simple helper: split text by punctuation into array of trimmed non-empty pieces
    function splitIntoPieces(text) {
      if (!text) return [];
      // split on Japanese punctuation and also standard punctuation
      const parts = text.split(/、|。|,|\.|\n/).map(s => s.trim()).filter(Boolean);
      return parts;
    }

    // Basic IndexedDB wrapper (promises)
    const DB_NAME = '🧠3M-data-v1';
    const STORE_NAME = 'entries';
    const dbOpen = () => new Promise((resolve, reject) => {
      const r = indexedDB.open(DB_NAME, 1);
      r.onupgradeneeded = () => {
        r.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
      };
      r.onsuccess = () => resolve(r.result);
      r.onerror = () => reject(r.error);
    });

    async function saveToDB(id, data) {
      const db = await dbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ id, data, updated: Date.now() });
        tx.oncomplete = () => res();
        tx.onerror = () => rej(tx.error);
      });
    }
    async function loadFromDB(id) {
      const db = await dbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get(id);
        req.onsuccess = () => res(req.result ? req.result.data : null);
        req.onerror = () => rej(req.error);
      });
    }

    // --- UI wiring ---
    const rawInput = document.getElementById('rawInput');
    const splitBtn = document.getElementById('splitBtn');
    const elementsList = document.getElementById('elementsList');
    const elementTemplate = document.getElementById('elementRowTemplate');
    const messageSection = document.getElementById('message');
    const mindSection = document.getElementById('mind');
    const moveSection = document.getElementById('move');
    const aboutSection = document.getElementById('about');

    // Safety
    const emergencyBanner = document.getElementById('emergencyBanner');
    const callSupportBtn = document.getElementById('callSupportBtn');
    const printSupportBtn = document.getElementById('printSupportBtn');
    // Prefill support actions
    // "支援機関の連絡ボタン" — immediate phone link to いのちの電話 is not centralized; we provide in-site options:
    callSupportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      // we open the national lifeline link (inochinodenwa) in a new tab and also offer tel fallback prompt.
      window.open('https://www.inochinodenwa.org/?page_id=267', '_blank');
    });
    printSupportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      window.print();
    });

    // High-risk words (Japanese examples). Expandable.
    const HIGH_RISK_WORDS = ['死にたい', '消えたい', '自殺', '死にます', '消えたいです', 'もういない', 'もうだめ', '死にたいです'];

    function detectHighRisk(text) {
      if (!text) return false;
      const t = text.toLowerCase();
      return HIGH_RISK_WORDS.some(w => t.includes(w));
    }

    function updateEmergencyBannerIfNeeded() {
      // Check all textareas for high-risk words
      const areas = Array.from(document.querySelectorAll('textarea'));
      const found = areas.some(a => detectHighRisk(a.value));
      if (found) {
        emergencyBanner.classList.remove('hidden');
      } else {
        emergencyBanner.classList.add('hidden');
      }
    }

    // convert element template node to actual element
    function createElementRow(text = '') {
      const tpl = elementTemplate.content.cloneNode(true);
      const li = tpl.querySelector('li');
      const ta = li.querySelector('textarea');
      ta.value = text;
      // wire up buttons
      li.querySelector('.move-up').addEventListener('click', () => {
        const prev = li.previousElementSibling;
        if (prev) li.parentNode.insertBefore(li, prev);
      });
      li.querySelector('.move-down').addEventListener('click', () => {
        const next = li.nextElementSibling;
        if (next) li.parentNode.insertBefore(next, li);
      });
      li.querySelector('.mark-del').addEventListener('click', () => {
        li.remove();
        updateEmergencyBannerIfNeeded();
      });
      ta.addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });
      return li;
    }

    splitBtn.addEventListener('click', () => {
      const pieces = splitIntoPieces(rawInput.value);
      // clear existing list
      elementsList.innerHTML = '';
      pieces.forEach(p => elementsList.appendChild(createElementRow(p)));
      // show message section and hide mind section
      messageSection.classList.remove('hidden');
      // scroll into view
      messageSection.scrollIntoView({ behavior: 'smooth' });
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    document.getElementById('addElementBtn').addEventListener('click', () => {
      elementsList.appendChild(createElementRow(''));
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      rawInput.value = '';
      elementsList.innerHTML = '';
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    // Proceed to 5-element selection
    document.getElementById('toFiveBtn').addEventListener('click', () => {
      // collect all elements
      const elems = Array.from(elementsList.querySelectorAll('textarea')).map(t => t.value.trim()).filter(Boolean);
      if (elems.length === 0) {
        alert('要素がありません。まずはフェーズ1で入力してください。');
        return;
      }
      // Build pickFive list
      const pickFive = document.getElementById('pickFive');
      pickFive.innerHTML = '';
      elems.forEach((e, idx) => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border border-slate-200 rounded-md p-2';
        ta.value = e;
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = idx < 5; // prefer first five
        chk.title = '5要素に含める';
        li.appendChild(chk);
        li.appendChild(ta);
        pickFive.appendChild(li);
      });

      // show next section (move)
      moveSection.classList.remove('hidden');
      moveSection.scrollIntoView({ behavior: 'smooth' });
      scheduleAutoSave();
    });

    // Utility to read selected five
    function getSelectedFive() {
      const items = Array.from(document.querySelectorAll('#pickFive > li'));
      return items.map(li => {
        const chk = li.querySelector('input[type="checkbox"]');
        const ta = li.querySelector('textarea');
        return { chosen: chk.checked, text: ta.value.trim() };
      }).filter(x => x.chosen).map(x => x.text).slice(0, 5);
    }

    // Phase 4: split into needed/unneeded columns
    function updateNeedUnneed() {
      const selected = getSelectedFive();
      const needed = document.getElementById('needed');
      const unneeded = document.getElementById('unneeded');
      needed.innerHTML = '';
      unneeded.innerHTML = '';
      selected.forEach(text => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border border-slate-200 rounded-md p-2';
        ta.value = text;
        // toggle button
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 border rounded text-sm';
        btn.textContent = '不要へ';
        btn.addEventListener('click', () => {
          if (btn.textContent === '不要へ') {
            unneeded.appendChild(li);
            btn.textContent = '必要へ';
          } else {
            needed.appendChild(li);
            btn.textContent = '不要へ';
          }
          scheduleAutoSave();
        });
        li.appendChild(ta);
        li.appendChild(btn);
        needed.appendChild(li);
      });
    }
    document.getElementById('pickFive').addEventListener('change', updateNeedUnneed);
    // Also wire proceed on entering moveSection: when rankBtn clicked, perform scoring

    function collectNeededItems() {
      return Array.from(document.querySelectorAll('#needed textarea')).map(t => t.value.trim()).filter(Boolean);
    }

    // Phase 5 UI: allow quick scoring for each needed item
    function renderPriorityTable() {
      const container = document.getElementById('priorityTable');
      container.innerHTML = '';
      const list = collectNeededItems();
      if (list.length === 0) {
        container.textContent = '（必要な項目がありません。フェーズ4で「必要」を選んでください）';
        return;
      }
      list.forEach((text, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        const label = document.createElement('div');
        label.textContent = text;
        label.className = 'flex-1';
        const urg = document.createElement('input');
        urg.type = 'number'; urg.min = 0; urg.max = 5; urg.value = 3; urg.className = 'w-16 border rounded p-1';
        const imp = document.createElement('input');
        imp.type = 'number'; imp.min = 0; imp.max = 5; imp.value = 3; imp.className = 'w-16 border rounded p-1';
        row.appendChild(label);
        row.appendChild(document.createTextNode('緊急'));
        row.appendChild(urg);
        row.appendChild(document.createTextNode('重要'));
        row.appendChild(imp);
        container.appendChild(row);
      });
    }

    document.getElementById('rankBtn').addEventListener('click', () => {
      // ensure needUnneed is populated
      updateNeedUnneed();
      renderPriorityTable();
      // compute scores
      const rows = Array.from(document.querySelectorAll('#priorityTable > div'));
      const scored = rows.map((r) => {
        const label = r.querySelector('div').textContent;
        const inputs = r.querySelectorAll('input[type="number"]');
        const urg = Number(inputs[0].value) || 0;
        const imp = Number(inputs[1].value) || 0;
        return { label, score: urg + imp, urg, imp };
      }).sort((a,b) => b.score - a.score);
      // show top 3
      const topThree = document.getElementById('topThree');
      topThree.innerHTML = '';
      scored.slice(0,3).forEach(s => {
        const li = document.createElement('li');
        li.textContent = `${s.label} （score:${s.score}）`;
        topThree.appendChild(li);
      });
      // fill orderList for drag ordering
      const orderList = document.getElementById('orderList');
      orderList.innerHTML = '';
      scored.slice(0,3).forEach(s => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2 bg-slate-50 p-2 rounded border';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border-none bg-transparent';
        ta.value = s.label;
        const up = document.createElement('button');
        up.textContent = '↑'; up.className = 'px-2 py-1 border rounded';
        const down = document.createElement('button');
        down.textContent = '↓'; down.className = 'px-2 py-1 border rounded';
        up.addEventListener('click', () => {
          const prev = li.previousElementSibling;
          if (prev) orderList.insertBefore(li, prev);
        });
        down.addEventListener('click', () => {
          const next = li.nextElementSibling;
          if (next) orderList.insertBefore(next, li);
        });
        li.appendChild(ta);
        li.appendChild(up);
        li.appendChild(down);
        orderList.appendChild(li);
      });
      scheduleAutoSave();
    });

    // Structure area: build from orderList
    function renderStructureArea() {
      const container = document.getElementById('structureArea');
      container.innerHTML = '';
      const items = Array.from(document.querySelectorAll('#orderList textarea')).map(t => t.value.trim()).filter(Boolean);
      items.forEach(it => {
        const block = document.createElement('div');
        block.className = 'border p-3 rounded bg-slate-50';
        const title = document.createElement('div');
        title.className = 'font-medium mb-2';
        title.textContent = it;
        const conclusion = document.createElement('textarea');
        conclusion.placeholder = '結論（短く）';
        conclusion.className = 'w-full border rounded p-2 mb-2';
        const reason = document.createElement('textarea');
        reason.placeholder = '理由（具体的）';
        reason.className = 'w-full border rounded p-2 mb-2';
        const hope = document.createElement('textarea');
        hope.placeholder = '希望・お願い';
        hope.className = 'w-full border rounded p-2';
        block.appendChild(title);
        block.appendChild(conclusion);
        block.appendChild(reason);
        block.appendChild(hope);
        container.appendChild(block);
      });
    }

    // When preview or generate final draft, compose from structureArea
    function composeFinalDraft() {
      const blocks = Array.from(document.querySelectorAll('#structureArea > div'));
      const composed = blocks.map(block => {
        const title = block.querySelector('.font-medium').textContent;
        const concl = block.querySelectorAll('textarea')[0].value.trim();
        const reason = block.querySelectorAll('textarea')[1].value.trim();
        const hope = block.querySelectorAll('textarea')[2].value.trim();
        // Build short paragraph
        let paragraph = '';
        if (concl) paragraph += concl;
        else paragraph += title;
        if (reason) paragraph += '。' + reason;
        if (hope) paragraph += '。' + hope;
        return paragraph;
      }).filter(Boolean).join('\n\n');
      document.getElementById('finalDraft').value = composed;
      scheduleAutoSave();
    }

    document.getElementById('previewBtn').addEventListener('click', () => {
      renderStructureArea();
      composeFinalDraft();
      document.getElementById('finalDraft').scrollIntoView({behavior: 'smooth'});
    });

    // Validation: check for high-risk words and also for aggressive language (simple heuristics)
    document.getElementById('validateBtn').addEventListener('click', () => {
      const text = document.getElementById('finalDraft').value;
      if (detectHighRisk(text)) {
        alert('高リスク表現が検出されました。支援機関に連絡してください。');
        emergencyBanner.classList.remove('hidden');
        return;
      }
      // Simple aggressive check: exclamation marks or all-caps (works for en)
      const aggressive = /!{2,}|（激しい表現）/.test(text);
      if (aggressive) {
        if (!confirm('強い表現が含まれています。送信すると相手が驚く可能性があります。続けますか？')) return;
      }
      alert('チェック完了：明確に見えます。必要なら修正してください。');
    });

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const t = document.getElementById('finalDraft').value;
      try {
        await navigator.clipboard.writeText(t);
        alert('コピーしました。対話やメモに貼り付けてください。');
      } catch (e) {
        alert('コピーに失敗しました。手動で選択してコピーしてください。');
      }
    });

    // Export: image & PDF
    document.getElementById('downloadIMGBtn').addEventListener('click', async () => {
      // capture the finalDraft area (render as image)
      const node = document.getElementById('finalDraft');
      // create a clone to style nicely for capture
      const clone = node.cloneNode(true);
      clone.style.width = '800px';
      clone.style.padding = '20px';
      clone.style.background = 'white';
      document.body.appendChild(clone);
      const canvas = await html2canvas(clone, {scale:2, backgroundColor: '#ffffff'});
      document.body.removeChild(clone);
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '🧠3M_message.png';
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/png');
    });

    document.getElementById('downloadPDFBtn').addEventListener('click', async () => {
      // Use html2canvas + jsPDF to produce PDF from finalDraft area
      const node = document.getElementById('finalDraft');
      const clone = node.cloneNode(true);
      clone.style.width = '800px';
      clone.style.padding = '20px';
      clone.style.background = 'white';
      document.body.appendChild(clone);
      const canvas = await html2canvas(clone, {scale:2, backgroundColor:'#ffffff'});
      document.body.removeChild(clone);
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('🧠3M_message.pdf');
    });

    // --- Auto Save Logic (IndexedDB) ---
    const AUTOSAVE_KEY = '🧠3M-autosave';
    let autosaveTimer = null;
    function scheduleAutoSave() {
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => autoSave(), 700);
    }
    async function autoSave() {
      // gather state
      const state = {
        rawInput: rawInput.value,
        elements: Array.from(elementsList.querySelectorAll('textarea')).map(t => t.value),
        pickedFive: Array.from(document.querySelectorAll('#pickFive textarea')).map(t => t.value),
        needed: collectNeededItems(),
        priorityTable: Array.from(document.querySelectorAll('#priorityTable div')).map(r => {
          const label = r.querySelector('div').textContent;
          const urg = r.querySelectorAll('input[type="number"]')[0].value;
          const imp = r.querySelectorAll('input[type="number"]')[1].value;
          return { label, urg, imp };
        }),
        order: Array.from(document.querySelectorAll('#orderList textarea')).map(t => t.value),
        structure: Array.from(document.querySelectorAll('#structureArea textarea')).map(t => t.value),
        finalDraft: document.getElementById('finalDraft').value,
        updated: Date.now()
      };
      try {
        await saveToDB(AUTOSAVE_KEY, state);
        // small visual indicator: update save button text briefly
        const sbtn = document.getElementById('saveLocalBtn');
        sbtn.textContent = '保存済み';
        setTimeout(()=> sbtn.textContent = '自動保存 / エクスポート', 1000);
      } catch (e) {
        console.error('Autosave failed', e);
      }
    }

    // Manual save/export button: open a small menu
    document.getElementById('saveLocalBtn').addEventListener('click', async () => {
      // quick save plus offer to download JSON
      await autoSave();
      const data = await loadFromDB(AUTOSAVE_KEY);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '🧠3M_autosave.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // On page load: restore
    (async function init() {
      // restore state if exists
      try {
        const data = await loadFromDB(AUTOSAVE_KEY);
        if (data) {
          rawInput.value = data.rawInput || '';
          if (data.elements && data.elements.length) {
            elementsList.innerHTML = '';
            data.elements.forEach(e => elementsList.appendChild(createElementRow(e)));
            messageSection.classList.remove('hidden');
          }
          // restore other areas in a minimal way
          if (data.finalDraft) {
            document.getElementById('finalDraft').value = data.finalDraft;
          }
        }
      } catch (e) {
        console.warn('Could not restore autosave', e);
      }
      // wire up update check
      rawInput.addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });
      // hash change handling: show/hide sections based on hash (local-only behaviour)
      function showSectionForHash() {
        const h = location.hash || '#mind';
        // hide all
        [mindSection, messageSection, moveSection, aboutSection].forEach(s => s.classList.add('hidden'));
        if (h.startsWith('#mind')) mindSection.classList.remove('hidden');
        else if (h.startsWith('#message')) messageSection.classList.remove('hidden');
        else if (h.startsWith('#move')) moveSection.classList.remove('hidden');
        else if (h.startsWith('#about')) aboutSection.classList.remove('hidden');
        else mindSection.classList.remove('hidden');
      }
      window.addEventListener('hashchange', showSectionForHash);
      showSectionForHash();
      updateEmergencyBannerIfNeeded();

      // Wire simple interactions to keep UI fluid
      document.getElementById('pickFive').addEventListener('input', scheduleAutoSave);
      document.getElementById('needed').addEventListener('input', scheduleAutoSave);
      document.getElementById('finalDraft').addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });

      // Attach compose flow when structure area changes
      document.getElementById('structureArea').addEventListener('input', () => {
        composeFinalDraft();
      });

      // quick initial save to create DB
      scheduleAutoSave();
    })();

    // connect some keyboard accessibility: Ctrl+Enter in finalDraft triggers copy
    document.getElementById('finalDraft').addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('copyBtn').click();
      }
    });

    // make links to emergency services easy (footer links are present — ensure call actions)
    // Additionally, provide an immediate print & call option in the emergency banner wired earlier.

  </script>
</body>
</html>
