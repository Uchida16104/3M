<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§ 3M â€” I Message to You About My Mind</title>

  <!-- Tailwind (CDN) with on-the-fly customization for colors / accessibility -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* Tailwind runtime configuration:
       - Adds accessible color palette tweaks
       - Enlarges default focus outlines for keyboard users
       - Keeps minimal changes to structure to respect original design */
    tailwind.config = {
      darkMode: false,
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f7fbfb',
              100: '#eef6f6',
              200: '#cfecec',
              300: '#9fd9d9',
              400: '#4fbaba',
              500: '#169999',
              600: '#167a7a',
              700: '#125f5f',
              800: '#0e4848',
              900: '#082f2f'
            },
            accent: {
              50: '#fff6f0',
              100: '#ffead9',
              200: '#ffd0b3',
              300: '#ffb080',
              400: '#ff8a44',
              500: '#ff661a',
              600: '#e65100',
              700: '#b43c00',
              800: '#862d00',
              900: '#5b2000'
            }
          },
          ringWidth: {
            DEFAULT: '4px'
          }
        }
      },
      plugins: [
        function ({ addUtilities }) {
          addUtilities({
            '.focus-ring': {
              outline: 'none',
              boxShadow: '0 0 0 4px rgba(22,153,153,0.12)'
            }
          })
        }
      ]
    }
  </script>

  <!-- HTMX (no version specified, per request) -->
  <script src="https://unpkg.com/htmx.org"></script>

  <!-- Utility libs for export/save: html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="" crossorigin="anonymous"></script>

  <meta name="description" content="ğŸ§ 3M â€” I Message to You About My Mind. æ€è€ƒæ•´ç†ãƒ»å¯¾è©±æ”¯æ´ãƒ„ãƒ¼ãƒ«ã€‚">
  <style>
    /* Small visual polish consistent with original layout but improved spacing/readability */
    html,body { height: 100%; }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    textarea { resize: vertical; min-height: 3rem; line-height: 1.5; }
    /* visually-hidden helper */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }
  </style>
</head>
<body class="bg-brand-50 text-slate-900 leading-relaxed">

  <!-- Emergency banner (hidden until high-risk word detected) -->
  <div id="emergencyBanner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-[min(1000px,95%)]">
    <div class="bg-accent-500 text-white rounded-lg shadow-lg p-4 flex items-center gap-4">
      <div class="flex-1">
        <strong class="block text-lg">ç·Šæ€¥ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</strong>
        <div class="text-sm">ã€Œæ­»ã«ãŸã„ã€ã€Œæ¶ˆãˆãŸã„ã€ç­‰ã®è¡¨ç¾ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã™ãã«æ”¯æ´æ©Ÿé–¢ã¸ã”é€£çµ¡ãã ã•ã„ã€‚</div>
      </div>
      <div class="flex gap-2">
        <!-- Immediate contact buttons (support agency call / print) -->
        <a id="callSupportBtn" class="inline-flex items-center px-4 py-2 bg-white text-accent-600 rounded-md font-semibold focus-ring" href="#" role="button">æ”¯æ´æ©Ÿé–¢ã«é›»è©±</a>
        <button id="printSupportBtn" class="inline-flex items-center px-4 py-2 bg-transparent border border-white text-white rounded-md hover:bg-white/10 focus-ring">å°åˆ·</button>
      </div>
    </div>
  </div>

  <!-- Top header -->
  <header class="bg-white/80 backdrop-blur sticky top-0 z-40 border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-md bg-brand-500 flex items-center justify-center text-white font-bold">ğŸ§ 3M</div>
        <div>
          <h1 class="text-lg font-semibold">ğŸ§ 3M â€” I Message to You About My Mind</h1>
          <p class="text-sm text-slate-600">è‡ªåˆ†ã®å¿ƒã‚’æ•´ç†ã—ã¦ã€å®‰å…¨ã«ä¼ãˆã‚‹æ”¯æ´ãƒ„ãƒ¼ãƒ«</p>
        </div>
      </div>

      <nav class="flex items-center gap-2">
        <!-- Internal navigation via hash (id) + HTMX hx-push-url attribute included explicitly for coders -->
        <!-- hx-get points to the same page with fragment â€” this will replace #main content on network-enabled hosts.
             We also listen to hashchange in JS to allow purely-local transitions without network calls. -->
        <a href="#mind" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#mind" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Mind</a>
        <a href="#message" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#message" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Message</a>
        <a href="#move" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#move" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">Move</a>
        <a href="#about" class="px-3 py-2 rounded-md hover:bg-slate-100 focus-ring" hx-get="index.html#about" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">About</a>
        <button id="saveLocalBtn" class="ml-2 px-3 py-2 bg-brand-500 text-white rounded-md hover:brightness-95 focus-ring">è‡ªå‹•ä¿å­˜ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </nav>
    </div>
  </header>

  <!-- Main content area -->
  <main id="main" class="mx-auto max-w-6xl px-4 py-8 space-y-8">

    <!-- Intro / Overview (kept same content/structure per instruction) -->
    <section id="mind" class="bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">æ¦‚è¦</h2>
      <p class="text-slate-700 mb-4">
        ğŸ§ 3Mï¼ˆèª­ã¿ï¼šã€Œã‚¹ãƒªãƒ¼ã‚¨ãƒ ã€ / I Message to You About My Mindï¼‰ã¯ã€
        ã€Œè‡ªåˆ†ã®æ°—æŒã¡ã‚’æ•´ç†ã—ã¦ã€ç›¸æ‰‹ã«å®‰å…¨ã«ä¼ãˆã‚‹ã€ã“ã¨ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹è‡ªå·±è¡¨ç¾æ”¯æ´ã‚¢ãƒ—ãƒªã§ã™ã€‚
      </p>

      <!-- PHASE 1: Raw input -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-slate-700">ãƒ•ã‚§ãƒ¼ã‚º1ï¼šã‚ã‚Šã®ã¾ã¾å…¥åŠ›</label>
        <textarea id="rawInput"
                  class="w-full border border-slate-200 rounded-md p-3 focus:ring focus-ring"
                  placeholder="æ€ã£ãŸã“ã¨ãƒ»æ„Ÿã˜ãŸã“ã¨ã‚’ãã®ã¾ã¾æ›¸ã„ã¦ãã ã•ã„ã€‚"></textarea>
        <div class="flex gap-2">
          <button id="splitBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">è¦ç´ ã«åˆ†è§£ï¼ˆã€ã€‚ã§åŒºåˆ‡ã‚‹ï¼‰</button>
          <button id="clearBtn" class="px-4 py-2 border rounded-md">ã‚¯ãƒªã‚¢</button>
        </div>
        <p class="text-xs text-slate-500">â€» å…¨ã¦ã®å…¥åŠ›æ¬„ã¯ textarea ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
      </div>
    </section>

    <!-- PHASE 2: Elements list (dynamically generated) -->
    <section id="message" class="hidden bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">ãƒ•ã‚§ãƒ¼ã‚º2ï¼šè¦ç´ åˆ†è§£</h2>
      <p class="text-slate-700 mb-4">ã€Œã€ã€ã€Œã€‚ã€ã§åŒºåˆ‡ã£ã¦è‡ªå‹•çš„ã«è¦ç´ åŒ–ã—ã¾ã™ã€‚è¦ç´ ã¯è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤å¯èƒ½ã§ã™ã€‚</p>

      <ul id="elementsList" class="space-y-2"></ul>

      <div class="mt-4 flex gap-2">
        <button id="toFiveBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">æ¬¡ã¸ï¼š5è¦ç´ ã«çµã‚‹</button>
        <button id="addElementBtn" class="px-4 py-2 border rounded-md">è¦ç´ ã‚’è¿½åŠ </button>
      </div>
    </section>

    <!-- PHASE 3..11 UI -->
    <section id="move" class="hidden bg-white rounded-lg shadow p-6 space-y-4">
      <h2 class="text-2xl font-bold">ãƒ•ã‚§ãƒ¼ã‚ºï¼šMessage â†’ Moveï¼ˆæ•´ç†ã¨é€ä¿¡æº–å‚™ï¼‰</h2>

      <!-- 3: 5 elements selection -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º3ï¼š5è¦ç´ ã«çµã‚‹</h3>
        <p class="text-sm text-slate-600">è¦ç´ ãƒªã‚¹ãƒˆã‹ã‚‰é‡è¦ãªã‚‚ã®ã‚’æœ€å¤§5ã¤é¸ã‚“ã§ãã ã•ã„ã€‚</p>
        <ul id="pickFive" class="mt-2 space-y-2"></ul>
      </div>

      <!-- 4: Necessary / Unnecessary -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º4ï¼šå¿…è¦ãƒ»ä¸è¦ã®ä»•åˆ†ã‘</h3>
        <p class="text-sm text-slate-600">é¸ã°ã‚ŒãŸè¦ç´ ã‚’ã€Œå¿…è¦ã€ã€Œä¸è¦ã€ã«ä»•åˆ†ã‘ã—ã¾ã™ã€‚</p>
        <div id="needUnneed" class="mt-2 grid grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium">å¿…è¦</h4>
            <ul id="needed" class="mt-2 space-y-1"></ul>
          </div>
          <div>
            <h4 class="font-medium">ä¸è¦</h4>
            <ul id="unneeded" class="mt-2 space-y-1"></ul>
          </div>
        </div>
      </div>

      <!-- 5: Urgency / Importance -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º5ï¼šç·Šæ€¥åº¦ã¨é‡è¦åº¦ã®åˆ†é¡</h3>
        <p class="text-sm text-slate-600">æ®‹ã£ãŸè¦ç´ ã«ç·Šæ€¥åº¦ï¼ˆ0-5ï¼‰ã¨é‡è¦åº¦ï¼ˆ0-5ï¼‰ã‚’ã¤ã‘ã¾ã™ã€‚</p>
        <div id="priorityTable" class="mt-2 space-y-2"></div>
      </div>

      <!-- 6: Top 3 -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º6ï¼šä¸Šä½3ã¤ã«çµã‚‹</h3>
        <p class="text-sm text-slate-600">è‡ªå‹•ã‚¹ã‚³ã‚¢ã§ä¸Šä½3ã¤ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
        <ol id="topThree" class="list-decimal ml-5 mt-2 space-y-1"></ol>
        <div class="mt-2">
          <button id="rankBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¦ä¸Šä½3ã¤ã‚’è¡¨ç¤º</button>
        </div>
      </div>

      <!-- 7: Ordering -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º7ï¼šå„ªå…ˆé †ä½ã¥ã‘</h3>
        <p class="text-sm text-slate-600">ä¸Šä½3ã¤ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆã€ä¼ãˆã‚‹é †ç•ªã‚’æ±ºã‚ã¾ã™ã€‚</p>
        <ul id="orderList" class="mt-2 space-y-2"></ul>
      </div>

      <!-- 8: Structure -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º8ï¼šæ§‹æˆã‚’çµ„ã¿ç«‹ã¦ã‚‹</h3>
        <p class="text-sm text-slate-600">ã€Œçµè«– â†’ ç†ç”± â†’ å¸Œæœ›ã€ã®å‹ã§å„é …ç›®ã‚’è£œè¶³ã—ã¾ã™ã€‚</p>
        <div id="structureArea" class="mt-2 space-y-2"></div>
      </div>

      <!-- 9: Compose -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º9ï¼šæ–‡ç« åŒ–</h3>
        <p class="text-sm text-slate-600">ä¸‹ã®ã‚¨ãƒªã‚¢ã§æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ–‡é¢ã‚’ä½œæˆã—ã¾ã™ï¼ˆã™ã¹ã¦ textareaï¼‰ã€‚</p>
        <textarea id="finalDraft" class="w-full border border-slate-200 rounded-md p-3 focus-ring" placeholder="æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã“ã“ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚"></textarea>
      </div>

      <!-- 10: Review -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º10ï¼šç¢ºèªãƒ»ä¿®æ­£</h3>
        <p class="text-sm text-slate-600">èª¤è§£ã‚’æ‹›ã‹ãªã„ã‹ã‚’ç¢ºèªã—ã€å¿…è¦ãªã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</p>
        <div class="flex gap-2 mt-2">
          <button id="validateBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæ„Ÿæƒ…ãƒ»æ”»æ’ƒæ€§ãƒ»é«˜ãƒªã‚¹ã‚¯ãƒ¯ãƒ¼ãƒ‰ï¼‰</button>
          <button id="previewBtn" class="px-4 py-2 border rounded-md">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>
      </div>

      <!-- 11: Complete -->
      <div>
        <h3 class="font-semibold">ãƒ•ã‚§ãƒ¼ã‚º11ï¼šå®Œæˆ</h3>
        <p class="text-sm text-slate-600">å®Œæˆã—ãŸã‚‰ã‚³ãƒ”ãƒ¼ãƒ»å°åˆ·ãƒ»ç”»åƒä¿å­˜ãƒ»PDFä¿å­˜ãŒå¯èƒ½ã§ã™ã€‚</p>
        <div class="flex gap-2 mt-2">
          <button id="copyBtn" class="px-4 py-2 border rounded-md focus-ring">ã‚³ãƒ”ãƒ¼</button>
          <button id="downloadPDFBtn" class="px-4 py-2 bg-accent-500 text-white rounded-md focus-ring">PDFã¨ã—ã¦ä¿å­˜</button>
          <button id="downloadIMGBtn" class="px-4 py-2 bg-brand-500 text-white rounded-md focus-ring">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
        </div>
      </div>
    </section>

    <!-- About / README style content (kept same as requested) -->
    <section id="about" class="hidden bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-2">About / README</h2>
      <div class="prose max-w-none">
        <h3>ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</h3>
        <p>â€œI Message to You about My Mind.â€ è‡ªåˆ†ã®å¿ƒã®ä¸­ã‚’ã€ŒIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã§å®‰å…¨ã«ä¼ãˆã‚‹ã€‚</p>

        <h3>3ã¤ã®M</h3>
        <ol>
          <li>Mind â€” è‡ªåˆ†ã®æ°—æŒã¡ã‚’ã‚ã‚Šã®ã¾ã¾ã«æ›¸ãå‡ºã™</li>
          <li>Message â€” æ€è€ƒã‚’5ã¤ â†’ 3ã¤ã«æ•´ç†ã—ã€å„ªå…ˆåº¦ã‚’ã¤ã‘ã‚‹</li>
          <li>Move â€” ä¼ãˆã‚‹è¨€è‘‰ã¨ã—ã¦ã¾ã¨ã‚ã€è¡Œå‹•ã«ç§»ã™</li>
        </ol>

        <h3>ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆï¼ˆ11ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h3>
        <p>ï¼ˆã“ã“ã§ã¯æœ€çµ‚çš„ã«11ãƒ•ã‚§ãƒ¼ã‚ºã®æµã‚Œã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚UIã§é †ã«é€²ã‚ã¦ãã ã•ã„ã€‚ï¼‰</p>

        <h3>ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¼æ©Ÿèƒ½</h3>
        <ul>
          <li>é«˜ãƒªã‚¹ã‚¯ãƒ¯ãƒ¼ãƒ‰ã®è‡ªå‹•æ¤œå‡ºã¨ç·Šæ€¥ãƒãƒŠãƒ¼è¡¨ç¤ºï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</li>
          <li>ã€Œæ”¯æ´æ©Ÿé–¢ã¸ã®é€£çµ¡ã€ãƒœã‚¿ãƒ³ï¼ˆé›»è©±ç™ºä¿¡ / å°åˆ·ã‚¬ã‚¤ãƒ‰ï¼‰ã‚’å³æ™‚ç™ºç«</li>
          <li>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆIndexedDBï¼‰ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆPDF/ç”»åƒï¼‰</li>
        </ul>

        <h3>æ”¯æ´ãƒ»ç›¸è«‡çª“å£ï¼ˆãƒªãƒ³ã‚¯ï¼‰</h3>
        <ul>
          <li>ã„ã®ã¡ã®é›»è©±ï¼š <a href="https://www.inochinodenwa.org/?page_id=267" class="text-blue-600 underline" target="_blank" rel="noopener">https://www.inochinodenwa.org/?page_id=267</a></li>
          <li>æ•‘æ€¥ï¼š <a href="tel:119" class="text-blue-600 underline">119</a></li>
          <li>è­¦å¯Ÿï¼š <a href="tel:110" class="text-blue-600 underline">110</a></li>
        </ul>

        <h3>æŠ€è¡“æ§‹æˆ</h3>
        <ul>
          <li>HTML / CSS (Tailwind) / JavaScript / HTMX</li>
          <li>IndexedDB ã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«è‡ªå‹•ä¿å­˜ï¼ˆæ‹¡å¼µæ¸ˆã¿ï¼šç”»åƒä¿å­˜ã‚’è¿½åŠ ï¼‰</li>
          <li>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼šPDFï¼ˆjsPDFï¼‰ / ç”»åƒï¼ˆhtml2canvasï¼‰</li>
        </ul>

        <h3>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h3>
        <p>MIT Licenseï¼ˆãƒªãƒã‚¸ãƒˆãƒªã«æº–æ‹ ï¼‰</p>

        <h3>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h3>
        <p>Original: Uchida16104 â€” I Message to You About My Mind.</p>
      </div>
    </section>

    <!-- Footer with accessibility links and credits -->
    <footer class="text-sm text-slate-600 py-8">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <div>
          <div>Â© ğŸ§ 3M â€” I Message to You About My Mind.</div>
          <div class="mt-1">æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç²¾ç¥ç–¾æ‚£ã‚’æŒã¤æ–¹ãƒ»æ”¯æ´è€…ãªã©</div>
        </div>
        <div class="flex gap-4">
          <a href="#about" class="underline" hx-get="index.html#about" hx-target="#main" hx-swap="innerHTML" hx-push-url="true">README</a>
          <a href="https://github.com/Uchida16104/ğŸ§ 3M" class="underline" target="_blank" rel="noopener">GitHub</a>
        </div>
      </div>
    </footer>
  </main>

  <!-- Hidden templates & helpers -->
  <template id="elementRowTemplate">
    <li class="flex gap-2 items-start bg-slate-50 p-3 rounded-md border border-slate-100">
      <textarea class="flex-1 border-none bg-transparent text-slate-800" placeholder="è¦ç´ ã®å†…å®¹"></textarea>
      <div class="flex flex-col gap-1">
        <button class="move-up px-2 py-1 bg-white border rounded text-sm">â†‘</button>
        <button class="move-down px-2 py-1 bg-white border rounded text-sm">â†“</button>
        <button class="mark-del px-2 py-1 bg-red-50 border border-red-200 rounded text-sm text-red-600">å‰Šé™¤</button>
      </div>
    </li>
  </template>

  <script>
    /* === Core behaviors ===
       - Parsing into elements (ãƒ•ã‚§ãƒ¼ã‚º2): splits by Japanese commaï¼ˆã€ï¼‰ and periodï¼ˆã€‚ï¼‰ and by English punctuation as fallback.
       - All inputs are textarea by requirement.
       - HTMX hints included: hx-push-url attributes exist on nav anchors; additionally we handle hashchange locally
       - IndexedDB auto-save (autosave every X seconds + on changes) with ability to export PDF and image.
       - Safety scanning for high-risk words shows emergency banner and wires support buttons (phone & print)
       - Minimal DOM changes from original repo; preserves README/sections content structure.
    */

    // Simple helper: split text by punctuation into array of trimmed non-empty pieces
    function splitIntoPieces(text) {
      if (!text) return [];
      // split on Japanese punctuation and also standard punctuation
      const parts = text.split(/ã€|ã€‚|,|\.|\n/).map(s => s.trim()).filter(Boolean);
      return parts;
    }

    // Basic IndexedDB wrapper (promises)
    const DB_NAME = 'ğŸ§ 3M-data-v1';
    const STORE_NAME = 'entries';
    const dbOpen = () => new Promise((resolve, reject) => {
      const r = indexedDB.open(DB_NAME, 1);
      r.onupgradeneeded = () => {
        r.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
      };
      r.onsuccess = () => resolve(r.result);
      r.onerror = () => reject(r.error);
    });

    async function saveToDB(id, data) {
      const db = await dbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ id, data, updated: Date.now() });
        tx.oncomplete = () => res();
        tx.onerror = () => rej(tx.error);
      });
    }
    async function loadFromDB(id) {
      const db = await dbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get(id);
        req.onsuccess = () => res(req.result ? req.result.data : null);
        req.onerror = () => rej(req.error);
      });
    }

    // --- UI wiring ---
    const rawInput = document.getElementById('rawInput');
    const splitBtn = document.getElementById('splitBtn');
    const elementsList = document.getElementById('elementsList');
    const elementTemplate = document.getElementById('elementRowTemplate');
    const messageSection = document.getElementById('message');
    const mindSection = document.getElementById('mind');
    const moveSection = document.getElementById('move');
    const aboutSection = document.getElementById('about');

    // Safety
    const emergencyBanner = document.getElementById('emergencyBanner');
    const callSupportBtn = document.getElementById('callSupportBtn');
    const printSupportBtn = document.getElementById('printSupportBtn');
    // Prefill support actions
    // "æ”¯æ´æ©Ÿé–¢ã®é€£çµ¡ãƒœã‚¿ãƒ³" â€” immediate phone link to ã„ã®ã¡ã®é›»è©± is not centralized; we provide in-site options:
    callSupportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      // we open the national lifeline link (inochinodenwa) in a new tab and also offer tel fallback prompt.
      window.open('https://www.inochinodenwa.org/?page_id=267', '_blank');
    });
    printSupportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      window.print();
    });

    // High-risk words (Japanese examples). Expandable.
    const HIGH_RISK_WORDS = ['æ­»ã«ãŸã„', 'æ¶ˆãˆãŸã„', 'è‡ªæ®º', 'æ­»ã«ã¾ã™', 'æ¶ˆãˆãŸã„ã§ã™', 'ã‚‚ã†ã„ãªã„', 'ã‚‚ã†ã ã‚', 'æ­»ã«ãŸã„ã§ã™'];

    function detectHighRisk(text) {
      if (!text) return false;
      const t = text.toLowerCase();
      return HIGH_RISK_WORDS.some(w => t.includes(w));
    }

    function updateEmergencyBannerIfNeeded() {
      // Check all textareas for high-risk words
      const areas = Array.from(document.querySelectorAll('textarea'));
      const found = areas.some(a => detectHighRisk(a.value));
      if (found) {
        emergencyBanner.classList.remove('hidden');
      } else {
        emergencyBanner.classList.add('hidden');
      }
    }

    // convert element template node to actual element
    function createElementRow(text = '') {
      const tpl = elementTemplate.content.cloneNode(true);
      const li = tpl.querySelector('li');
      const ta = li.querySelector('textarea');
      ta.value = text;
      // wire up buttons
      li.querySelector('.move-up').addEventListener('click', () => {
        const prev = li.previousElementSibling;
        if (prev) li.parentNode.insertBefore(li, prev);
      });
      li.querySelector('.move-down').addEventListener('click', () => {
        const next = li.nextElementSibling;
        if (next) li.parentNode.insertBefore(next, li);
      });
      li.querySelector('.mark-del').addEventListener('click', () => {
        li.remove();
        updateEmergencyBannerIfNeeded();
      });
      ta.addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });
      return li;
    }

    splitBtn.addEventListener('click', () => {
      const pieces = splitIntoPieces(rawInput.value);
      // clear existing list
      elementsList.innerHTML = '';
      pieces.forEach(p => elementsList.appendChild(createElementRow(p)));
      // show message section and hide mind section
      messageSection.classList.remove('hidden');
      // scroll into view
      messageSection.scrollIntoView({ behavior: 'smooth' });
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    document.getElementById('addElementBtn').addEventListener('click', () => {
      elementsList.appendChild(createElementRow(''));
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      rawInput.value = '';
      elementsList.innerHTML = '';
      updateEmergencyBannerIfNeeded();
      scheduleAutoSave();
    });

    // Proceed to 5-element selection
    document.getElementById('toFiveBtn').addEventListener('click', () => {
      // collect all elements
      const elems = Array.from(elementsList.querySelectorAll('textarea')).map(t => t.value.trim()).filter(Boolean);
      if (elems.length === 0) {
        alert('è¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ãƒ•ã‚§ãƒ¼ã‚º1ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      // Build pickFive list
      const pickFive = document.getElementById('pickFive');
      pickFive.innerHTML = '';
      elems.forEach((e, idx) => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border border-slate-200 rounded-md p-2';
        ta.value = e;
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = idx < 5; // prefer first five
        chk.title = '5è¦ç´ ã«å«ã‚ã‚‹';
        li.appendChild(chk);
        li.appendChild(ta);
        pickFive.appendChild(li);
      });

      // show next section (move)
      moveSection.classList.remove('hidden');
      moveSection.scrollIntoView({ behavior: 'smooth' });
      scheduleAutoSave();
    });

    // Utility to read selected five
    function getSelectedFive() {
      const items = Array.from(document.querySelectorAll('#pickFive > li'));
      return items.map(li => {
        const chk = li.querySelector('input[type="checkbox"]');
        const ta = li.querySelector('textarea');
        return { chosen: chk.checked, text: ta.value.trim() };
      }).filter(x => x.chosen).map(x => x.text).slice(0, 5);
    }

    // Phase 4: split into needed/unneeded columns
    function updateNeedUnneed() {
      const selected = getSelectedFive();
      const needed = document.getElementById('needed');
      const unneeded = document.getElementById('unneeded');
      needed.innerHTML = '';
      unneeded.innerHTML = '';
      selected.forEach(text => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border border-slate-200 rounded-md p-2';
        ta.value = text;
        // toggle button
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 border rounded text-sm';
        btn.textContent = 'ä¸è¦ã¸';
        btn.addEventListener('click', () => {
          if (btn.textContent === 'ä¸è¦ã¸') {
            unneeded.appendChild(li);
            btn.textContent = 'å¿…è¦ã¸';
          } else {
            needed.appendChild(li);
            btn.textContent = 'ä¸è¦ã¸';
          }
          scheduleAutoSave();
        });
        li.appendChild(ta);
        li.appendChild(btn);
        needed.appendChild(li);
      });
    }
    document.getElementById('pickFive').addEventListener('change', updateNeedUnneed);
    // Also wire proceed on entering moveSection: when rankBtn clicked, perform scoring

    function collectNeededItems() {
      return Array.from(document.querySelectorAll('#needed textarea')).map(t => t.value.trim()).filter(Boolean);
    }

    // Phase 5 UI: allow quick scoring for each needed item
    function renderPriorityTable() {
      const container = document.getElementById('priorityTable');
      container.innerHTML = '';
      const list = collectNeededItems();
      if (list.length === 0) {
        container.textContent = 'ï¼ˆå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚§ãƒ¼ã‚º4ã§ã€Œå¿…è¦ã€ã‚’é¸ã‚“ã§ãã ã•ã„ï¼‰';
        return;
      }
      list.forEach((text, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        const label = document.createElement('div');
        label.textContent = text;
        label.className = 'flex-1';
        const urg = document.createElement('input');
        urg.type = 'number'; urg.min = 0; urg.max = 5; urg.value = 3; urg.className = 'w-16 border rounded p-1';
        const imp = document.createElement('input');
        imp.type = 'number'; imp.min = 0; imp.max = 5; imp.value = 3; imp.className = 'w-16 border rounded p-1';
        row.appendChild(label);
        row.appendChild(document.createTextNode('ç·Šæ€¥'));
        row.appendChild(urg);
        row.appendChild(document.createTextNode('é‡è¦'));
        row.appendChild(imp);
        container.appendChild(row);
      });
    }

    document.getElementById('rankBtn').addEventListener('click', () => {
      // ensure needUnneed is populated
      updateNeedUnneed();
      renderPriorityTable();
      // compute scores
      const rows = Array.from(document.querySelectorAll('#priorityTable > div'));
      const scored = rows.map((r) => {
        const label = r.querySelector('div').textContent;
        const inputs = r.querySelectorAll('input[type="number"]');
        const urg = Number(inputs[0].value) || 0;
        const imp = Number(inputs[1].value) || 0;
        return { label, score: urg + imp, urg, imp };
      }).sort((a,b) => b.score - a.score);
      // show top 3
      const topThree = document.getElementById('topThree');
      topThree.innerHTML = '';
      scored.slice(0,3).forEach(s => {
        const li = document.createElement('li');
        li.textContent = `${s.label} ï¼ˆscore:${s.score}ï¼‰`;
        topThree.appendChild(li);
      });
      // fill orderList for drag ordering
      const orderList = document.getElementById('orderList');
      orderList.innerHTML = '';
      scored.slice(0,3).forEach(s => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2 bg-slate-50 p-2 rounded border';
        const ta = document.createElement('textarea');
        ta.className = 'flex-1 border-none bg-transparent';
        ta.value = s.label;
        const up = document.createElement('button');
        up.textContent = 'â†‘'; up.className = 'px-2 py-1 border rounded';
        const down = document.createElement('button');
        down.textContent = 'â†“'; down.className = 'px-2 py-1 border rounded';
        up.addEventListener('click', () => {
          const prev = li.previousElementSibling;
          if (prev) orderList.insertBefore(li, prev);
        });
        down.addEventListener('click', () => {
          const next = li.nextElementSibling;
          if (next) orderList.insertBefore(next, li);
        });
        li.appendChild(ta);
        li.appendChild(up);
        li.appendChild(down);
        orderList.appendChild(li);
      });
      scheduleAutoSave();
    });

    // Structure area: build from orderList
    function renderStructureArea() {
      const container = document.getElementById('structureArea');
      container.innerHTML = '';
      const items = Array.from(document.querySelectorAll('#orderList textarea')).map(t => t.value.trim()).filter(Boolean);
      items.forEach(it => {
        const block = document.createElement('div');
        block.className = 'border p-3 rounded bg-slate-50';
        const title = document.createElement('div');
        title.className = 'font-medium mb-2';
        title.textContent = it;
        const conclusion = document.createElement('textarea');
        conclusion.placeholder = 'çµè«–ï¼ˆçŸ­ãï¼‰';
        conclusion.className = 'w-full border rounded p-2 mb-2';
        const reason = document.createElement('textarea');
        reason.placeholder = 'ç†ç”±ï¼ˆå…·ä½“çš„ï¼‰';
        reason.className = 'w-full border rounded p-2 mb-2';
        const hope = document.createElement('textarea');
        hope.placeholder = 'å¸Œæœ›ãƒ»ãŠé¡˜ã„';
        hope.className = 'w-full border rounded p-2';
        block.appendChild(title);
        block.appendChild(conclusion);
        block.appendChild(reason);
        block.appendChild(hope);
        container.appendChild(block);
      });
    }

    // When preview or generate final draft, compose from structureArea
    function composeFinalDraft() {
      const blocks = Array.from(document.querySelectorAll('#structureArea > div'));
      const composed = blocks.map(block => {
        const title = block.querySelector('.font-medium').textContent;
        const concl = block.querySelectorAll('textarea')[0].value.trim();
        const reason = block.querySelectorAll('textarea')[1].value.trim();
        const hope = block.querySelectorAll('textarea')[2].value.trim();
        // Build short paragraph
        let paragraph = '';
        if (concl) paragraph += concl;
        else paragraph += title;
        if (reason) paragraph += 'ã€‚' + reason;
        if (hope) paragraph += 'ã€‚' + hope;
        return paragraph;
      }).filter(Boolean).join('\n\n');
      document.getElementById('finalDraft').value = composed;
      scheduleAutoSave();
    }

    document.getElementById('previewBtn').addEventListener('click', () => {
      renderStructureArea();
      composeFinalDraft();
      document.getElementById('finalDraft').scrollIntoView({behavior: 'smooth'});
    });

    // Validation: check for high-risk words and also for aggressive language (simple heuristics)
    document.getElementById('validateBtn').addEventListener('click', () => {
      const text = document.getElementById('finalDraft').value;
      if (detectHighRisk(text)) {
        alert('é«˜ãƒªã‚¹ã‚¯è¡¨ç¾ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ”¯æ´æ©Ÿé–¢ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
        emergencyBanner.classList.remove('hidden');
        return;
      }
      // Simple aggressive check: exclamation marks or all-caps (works for en)
      const aggressive = /!{2,}|ï¼ˆæ¿€ã—ã„è¡¨ç¾ï¼‰/.test(text);
      if (aggressive) {
        if (!confirm('å¼·ã„è¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚é€ä¿¡ã™ã‚‹ã¨ç›¸æ‰‹ãŒé©šãå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ')) return;
      }
      alert('ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼šæ˜ç¢ºã«è¦‹ãˆã¾ã™ã€‚å¿…è¦ãªã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
    });

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const t = document.getElementById('finalDraft').value;
      try {
        await navigator.clipboard.writeText(t);
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚å¯¾è©±ã‚„ãƒ¡ãƒ¢ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
      } catch (e) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    // Export: image & PDF
    document.getElementById('downloadIMGBtn').addEventListener('click', async () => {
      // capture the finalDraft area (render as image)
      const node = document.getElementById('finalDraft');
      // create a clone to style nicely for capture
      const clone = node.cloneNode(true);
      clone.style.width = '800px';
      clone.style.padding = '20px';
      clone.style.background = 'white';
      document.body.appendChild(clone);
      const canvas = await html2canvas(clone, {scale:2, backgroundColor: '#ffffff'});
      document.body.removeChild(clone);
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ğŸ§ 3M_message.png';
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/png');
    });

    document.getElementById('downloadPDFBtn').addEventListener('click', async () => {
      // Use html2canvas + jsPDF to produce PDF from finalDraft area
      const node = document.getElementById('finalDraft');
      const clone = node.cloneNode(true);
      clone.style.width = '800px';
      clone.style.padding = '20px';
      clone.style.background = 'white';
      document.body.appendChild(clone);
      const canvas = await html2canvas(clone, {scale:2, backgroundColor:'#ffffff'});
      document.body.removeChild(clone);
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('ğŸ§ 3M_message.pdf');
    });

    // --- Auto Save Logic (IndexedDB) ---
    const AUTOSAVE_KEY = 'ğŸ§ 3M-autosave';
    let autosaveTimer = null;
    function scheduleAutoSave() {
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => autoSave(), 700);
    }
    async function autoSave() {
      // gather state
      const state = {
        rawInput: rawInput.value,
        elements: Array.from(elementsList.querySelectorAll('textarea')).map(t => t.value),
        pickedFive: Array.from(document.querySelectorAll('#pickFive textarea')).map(t => t.value),
        needed: collectNeededItems(),
        priorityTable: Array.from(document.querySelectorAll('#priorityTable div')).map(r => {
          const label = r.querySelector('div').textContent;
          const urg = r.querySelectorAll('input[type="number"]')[0].value;
          const imp = r.querySelectorAll('input[type="number"]')[1].value;
          return { label, urg, imp };
        }),
        order: Array.from(document.querySelectorAll('#orderList textarea')).map(t => t.value),
        structure: Array.from(document.querySelectorAll('#structureArea textarea')).map(t => t.value),
        finalDraft: document.getElementById('finalDraft').value,
        updated: Date.now()
      };
      try {
        await saveToDB(AUTOSAVE_KEY, state);
        // small visual indicator: update save button text briefly
        const sbtn = document.getElementById('saveLocalBtn');
        sbtn.textContent = 'ä¿å­˜æ¸ˆã¿';
        setTimeout(()=> sbtn.textContent = 'è‡ªå‹•ä¿å­˜ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 1000);
      } catch (e) {
        console.error('Autosave failed', e);
      }
    }

    // Manual save/export button: open a small menu
    document.getElementById('saveLocalBtn').addEventListener('click', async () => {
      // quick save plus offer to download JSON
      await autoSave();
      const data = await loadFromDB(AUTOSAVE_KEY);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ğŸ§ 3M_autosave.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // On page load: restore
    (async function init() {
      // restore state if exists
      try {
        const data = await loadFromDB(AUTOSAVE_KEY);
        if (data) {
          rawInput.value = data.rawInput || '';
          if (data.elements && data.elements.length) {
            elementsList.innerHTML = '';
            data.elements.forEach(e => elementsList.appendChild(createElementRow(e)));
            messageSection.classList.remove('hidden');
          }
          // restore other areas in a minimal way
          if (data.finalDraft) {
            document.getElementById('finalDraft').value = data.finalDraft;
          }
        }
      } catch (e) {
        console.warn('Could not restore autosave', e);
      }
      // wire up update check
      rawInput.addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });
      // hash change handling: show/hide sections based on hash (local-only behaviour)
      function showSectionForHash() {
        const h = location.hash || '#mind';
        // hide all
        [mindSection, messageSection, moveSection, aboutSection].forEach(s => s.classList.add('hidden'));
        if (h.startsWith('#mind')) mindSection.classList.remove('hidden');
        else if (h.startsWith('#message')) messageSection.classList.remove('hidden');
        else if (h.startsWith('#move')) moveSection.classList.remove('hidden');
        else if (h.startsWith('#about')) aboutSection.classList.remove('hidden');
        else mindSection.classList.remove('hidden');
      }
      window.addEventListener('hashchange', showSectionForHash);
      showSectionForHash();
      updateEmergencyBannerIfNeeded();

      // Wire simple interactions to keep UI fluid
      document.getElementById('pickFive').addEventListener('input', scheduleAutoSave);
      document.getElementById('needed').addEventListener('input', scheduleAutoSave);
      document.getElementById('finalDraft').addEventListener('input', () => {
        updateEmergencyBannerIfNeeded();
        scheduleAutoSave();
      });

      // Attach compose flow when structure area changes
      document.getElementById('structureArea').addEventListener('input', () => {
        composeFinalDraft();
      });

      // quick initial save to create DB
      scheduleAutoSave();
    })();

    // connect some keyboard accessibility: Ctrl+Enter in finalDraft triggers copy
    document.getElementById('finalDraft').addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('copyBtn').click();
      }
    });

    // make links to emergency services easy (footer links are present â€” ensure call actions)
    // Additionally, provide an immediate print & call option in the emergency banner wired earlier.

  </script>
</body>
</html>
