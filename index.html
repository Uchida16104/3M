<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3M — I Message to You About My Mind.</title>

  <!-- Tailwind CDN (with runtime config for custom colors / accessibility) -->
  <script>
    /* Tailwind runtime config: customize palette & accessibility-friendly contrasts */
    tailwindConfig = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  '#f8fbfb',
              100: '#eaf7f7',
              200: '#cbeee9',
              300: '#a9e4dd',
              400: '#65d3c9',
              500: '#2bbfaf', /* primary */
              600: '#249e98',
              700: '#1e7a72',
              800: '#17554a',
              900: '#0f332e'
            },
            accent: {
              50:  '#fff8f3',
              100: '#fff1e6',
              200: '#ffe3cc',
              300: '#ffd1ad',
              400: '#ffb67a',
              500: '#ff9748',
              600: '#e57e33',
              700: '#b85f27',
              800: '#8a431d',
              900: '#5d2a14'
            },
            safety: {
              green: '#0b7a4d',
              warn:  '#b76a00',
              danger: '#b91c1c'
            }
          },
          fontFamily: {
            system: ['"Noto Sans JP"', 'ui-sans-serif', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- HTMX (as requested, no version specified) -->
  <script src="https://unpkg.com/htmx.org"></script>

  <!-- jsPDF for PDF export, html2canvas for image export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="" crossorigin="anonymous"></script>

  <style>
    /* Small extra styling to improve readability */
    body { font-family: system, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f7fafc, #ffffff); }
    .max-w-screen-md { max-width: 920px; }
    textarea { resize: vertical; min-height: 3rem; line-height:1.5; }
    /* Simple focus styles for accessibility */
    :focus { outline: 3px solid rgba(43,191,175,0.18); outline-offset: 2px; }
    /* Section hide/show */
    .page { display: none; }
    .page[aria-hidden="false"] { display: block; }
    /* Emergency banner */
    .emergency-banner { border-left: 4px solid #b91c1c; background: #fff5f5; }
    /* small utility */
    .muted { color: #6b7280; }
  </style>
</head>
<body class="antialiased text-slate-800">

  <div class="py-8 px-4">
    <div class="mx-auto max-w-screen-md bg-white rounded-2xl shadow-lg p-6">
      <header class="mb-6">
        <h1 class="text-2xl font-bold text-brand-700">3M — I Message to You About My Mind.</h1>
        <p class="text-sm muted mt-1">自分の心の中を「Iメッセージ」で安全に伝える</p>
      </header>

      <!-- Emergency banner (hidden unless high-risk detected) -->
      <div id="emergency" class="emergency-banner rounded-md p-4 mb-4 hidden" role="alert" aria-live="polite">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-6.364 6.364-6.364-6.364M12 20v-8" /></svg>
          </div>
          <div>
            <div class="font-semibold text-red-700">高リスクワードが検出されました</div>
            <div class="text-sm muted">すぐに支援が必要な場合は下の連絡先へご連絡ください。</div>
            <div class="mt-3 flex flex-wrap gap-2">
              <a class="inline-flex items-center px-3 py-2 rounded bg-safety-danger text-white text-sm" href="tel:119">救急：119</a>
              <a class="inline-flex items-center px-3 py-2 rounded bg-safety-danger text-white text-sm" href="tel:110">警察：110</a>
              <a class="inline-flex items-center px-3 py-2 rounded bg-safety-green text-white text-sm" href="https://www.inochinodenwa.org/?page_id=267" target="_blank" rel="noopener">いのちの電話 — 地域・連絡先</a>
              <button id="printSupport" class="inline-flex items-center px-3 py-2 rounded bg-brand-500 text-white text-sm">印刷用案内を表示</button>
              <a id="supportCallButton" class="inline-flex items-center px-3 py-2 rounded bg-accent-500 text-white text-sm" href="tel:03-5774-0992">支援機関へ電話（TELL Lifeline）</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main nav -->
      <nav class="mb-6 flex gap-2 flex-wrap">
        <!-- Note: we include hx-push-url="true" explicitly on nav anchors (per request).
             We also add hx-trigger and hx-swap="none" so HTMX makes a lightweight request.
             For offline single-file SPA behaviour we intercept clicks with JS to show sections and use history.pushState
             HTMX attributes remain present so a coder can see htmx used and hx-push-url present. -->
        <a href="#home" class="px-3 py-2 rounded bg-brand-500 text-white text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">Home</a>
        <a href="#mind" class="px-3 py-2 rounded bg-white border text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">Mind</a>
        <a href="#message" class="px-3 py-2 rounded bg-white border text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">Message</a>
        <a href="#move" class="px-3 py-2 rounded bg-white border text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">Move</a>
        <a href="#safety" class="px-3 py-2 rounded bg-white border text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">Safety</a>
        <a href="#about" class="px-3 py-2 rounded bg-white border text-sm" hx-push-url="true" hx-trigger="click" hx-swap="none">About / Readme</a>
        <div class="ml-auto flex gap-2">
          <button id="saveBtn" class="px-3 py-2 rounded bg-accent-500 text-white text-sm">保存（IndexedDB）</button>
          <button id="pdfBtn" class="px-3 py-2 rounded bg-brand-600 text-white text-sm">PDF保存</button>
          <button id="imgBtn" class="px-3 py-2 rounded bg-brand-600 text-white text-sm">画像保存</button>
        </div>
      </nav>

      <main>
        <!-- Home / Intro page -->
        <section id="home" class="page" aria-hidden="true" aria-labelledby="homeLabel">
          <h2 id="homeLabel" class="text-xl font-semibold mb-2">3M — Overview</h2>
          <p class="mb-4 muted">「自分の気持ちを整理して、相手に安全に伝える」ことをサポートする自己表現支援ツールです。</p>

          <div class="space-y-4">
            <div class="rounded-md p-4 bg-slate-50">
              <p class="text-sm">このアプリは、思考整理のフェーズに沿って進めます。すべての入力欄は <strong>textarea</strong> で統一されています。</p>
            </div>

            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <div class="p-4 border rounded">
                <h3 class="font-semibold">使い方（短縮）</h3>
                <ol class="list-decimal pl-5 mt-2 text-sm muted">
                  <li>Mind（ありのまま入力）→</li>
                  <li>要素分解（「、」「。」で自動分割）→</li>
                  <li>5要素に絞る →</li>
                  <li>必要/不要判定 →</li>
                  <li>緊急度/重要度分類 →</li>
                  <li>上位3つに絞る →</li>
                  <li>優先順位づけ → 構成 → 文章化 → 完成</li>
                </ol>
              </div>

              <div class="p-4 border rounded">
                <h3 class="font-semibold">サポート連絡</h3>
                <p class="text-sm mt-2 muted">急ぎの支援が必要なときのリンク：</p>
                <ul class="mt-2 space-y-1 text-sm">
                  <li><a class="text-brand-700 underline" href="https://www.inochinodenwa.org/?page_id=267" target="_blank">いのちの電話（地域別一覧）</a></li>
                  <li><a class="text-brand-700 underline" href="tel:119">救急：119</a></li>
                  <li><a class="text-brand-700 underline" href="tel:110">警察：110</a></li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Mind page: raw input -->
        <section id="mind" class="page" aria-hidden="true" aria-labelledby="mindLabel">
          <h2 id="mindLabel" class="text-xl font-semibold mb-2">Mind — ありのまま入力</h2>
          <p class="muted mb-3">思ったこと・感じたことを判断せずに書き出してください。句読点（、。）で自動的に分割されます。</p>

          <div class="space-y-3">
            <label class="block">
              <span class="text-sm font-medium">自由入力（textarea）</span>
              <textarea id="mindInput" class="mt-1 w-full border rounded p-3" placeholder="例：昨日から眠れない、上司の言葉が気になる、でも話すのが怖い"></textarea>
            </label>

            <div class="flex gap-2">
              <button id="splitBtn" class="px-4 py-2 rounded bg-brand-500 text-white">要素分解（句読点で自動分割）</button>
              <button id="clearMind" class="px-4 py-2 rounded bg-white border">クリア</button>
              <div class="ml-auto text-sm muted self-end">自動保存: <span id="autosaveState">未保存</span></div>
            </div>

            <div>
              <h3 class="font-semibold">分解された要素</h3>
              <ul id="pieces" class="mt-2 space-y-2"></ul>
              <div class="text-sm muted mt-2">各要素は編集可能な<textarea>です。追加・削除もできます。</div>
            </div>
          </div>
        </section>

        <!-- Message page: pick 5 / score -->
        <section id="message" class="page" aria-hidden="true" aria-labelledby="messageLabel">
          <h2 id="messageLabel" class="text-xl font-semibold mb-2">Message — 5要素に絞る / スコアで上位抽出</h2>
          <p class="muted mb-3">フェーズ2で分解した要素から5つを選択し、緊急度・重要度をつけます。ここでもすべて<textarea>のみを使用します。</p>

          <div id="fiveContainer" class="space-y-3">
            <!-- JS will populate up to 5 selected items with textareas for editing and score inputs -->
          </div>

          <div class="mt-3 flex gap-2">
            <button id="autoPickBtn" class="px-4 py-2 rounded bg-accent-500 text-white">自動で上位5をピック（スコアベース）</button>
            <button id="confirm5Btn" class="px-4 py-2 rounded bg-brand-500 text-white">5つを確定</button>
          </div>

          <div class="mt-4">
            <h3 class="font-semibold">備考</h3>
            <p class="text-sm muted">緊急度・重要度は0〜5で入力してください。自動選定は合計スコアでソートします。</p>
          </div>
        </section>

        <!-- Move page: finalize 3 and compose -->
        <section id="move" class="page" aria-hidden="true" aria-labelledby="moveLabel">
          <h2 id="moveLabel" class="text-xl font-semibold mb-2">Move — 3つに絞り、優先順位づけ、文章化</h2>
          <p class="muted mb-3">選んだ要素を3つに絞り、順序を決め、最終メッセージを作成します。</p>

          <div id="top3Container" class="space-y-4"></div>

          <div class="mt-3">
            <h3 class="font-semibold">最終メッセージ（編集可能）</h3>
            <textarea id="finalMessage" class="mt-2 w-full border rounded p-3" placeholder="最終的に伝えるメッセージをここにまとめます。"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="copyBtn" class="px-3 py-2 rounded bg-brand-500 text-white">コピー</button>
              <button id="sendBtn" class="px-3 py-2 rounded bg-accent-500 text-white">送信イメージ（ダミー）</button>
            </div>
          </div>
        </section>

        <!-- Safety page (detailed) -->
        <section id="safety" class="page" aria-hidden="true" aria-labelledby="safetyLabel">
          <h2 id="safetyLabel" class="text-xl font-semibold mb-2">Safety — セーフティ機能</h2>
          <p class="muted mb-3">ローカルでの高リスクワード検出、即時連絡ボタン、印刷用案内を提供します。</p>

          <div class="space-y-4">
            <div class="rounded p-4 border">
              <h3 class="font-semibold">緊急連絡先</h3>
              <ul class="mt-2 text-sm">
                <li><a class="underline text-brand-700" href="https://www.inochinodenwa.org/?page_id=267" target="_blank">いのちの電話（地域別）</a></li>
                <li><a class="underline text-brand-700" href="tel:119">救急：119</a></li>
                <li><a class="underline text-brand-700" href="tel:110">警察：110</a></li>
              </ul>
            </div>

            <div class="rounded p-4 border">
              <h3 class="font-semibold">支援機関の即時発火ボタン（使いやすい）</h3>
              <div class="mt-3 flex gap-2">
                <a class="px-3 py-2 rounded bg-safety-green text-white" href="tel:03-5774-0992">TELL Lifeline（電話）</a>
                <button id="printSupport2" class="px-3 py-2 rounded bg-brand-500 text-white">支援機関案内を印刷</button>
              </div>
            </div>

            <div class="rounded p-4 border">
              <h3 class="font-semibold">ローカル検出ルール（高リスクワード）</h3>
              <p class="text-sm muted mt-2">以下は検出ワードの例です。管理者は配列（JS）で自由に編集できます。</p>
              <pre class="text-xs bg-slate-50 p-2 rounded mt-2">["死にたい","消えたい","もう終わりにしたい","消したい","死にたいです"]</pre>
            </div>
          </div>
        </section>

        <!-- About / README page (must preserve content & design) -->
        <section id="about" class="page" aria-hidden="true" aria-labelledby="aboutLabel">
          <h2 id="aboutLabel" class="text-xl font-semibold mb-2">About / README（概要・コンセプト等）</h2>

          <article class="prose max-w-none">
            <h3>概要</h3>
            <p>3M（読み：「スリーエム」 / I Message to You About My Mind）は、「自分の気持ちを整理して、相手に安全に伝える」ことをサポートする6つのフェーズ構成の自己表現支援アプリです。</p>

            <h3>コンセプト</h3>
            <blockquote>“I Message to You about My Mind.” 自分の心の中を「Iメッセージ」で安全に伝える。</blockquote>

            <h3>3つのM</h3>
            <ol>
              <li><strong>Mind</strong> — 自分の気持ちをありのままに書き出す</li>
              <li><strong>Message</strong> — 思考を5つ → 3つに整理し、優先度をつける</li>
              <li><strong>Move</strong> — 伝える言葉としてまとめ、行動に移す</li>
            </ol>

            <h3>フェーズ構成（6ステップ）</h3>
            <ol>
              <li>感情や考えをありのまま書き出す &lt;textarea&gt;</li>
              <li>文章を5つの要素に分解する &lt;li&gt;, &lt;input&gt;</li>
              <li>緊急度と重要度で上位3つに絞る &lt;li&gt;, &lt;input type="number"&gt;</li>
              <li>3つの要素に優先順位をつける &lt;li&gt;, &lt;input&gt;</li>
              <li>伝える文章を組み立てる &lt;textarea&gt;</li>
              <li>最終メッセージを完成・コピー &lt;div contenteditable&gt;</li>
            </ol>

            <h3>セーフティ機能</h3>
            <p>「死にたい」「消えたい」などの高リスクワードを自動検出し、ページ上部に緊急支援の案内を表示します。連絡先例：119 / 110 / いのちの電話（全国各地）</p>

            <h3>技術構成</h3>
            <p>HTML / CSS / JavaScript / HTMX のみで構成された単一ページアプリ。オフラインでも動作可能。ローカル保存・サーバー通信なし（プライバシー保護）。主要機能：テキスト分割、スコア計算・自動ソート、コピー機能、自殺関連ワード検知、編集可能な最終出力。</p>

            <h3>使用例</h3>
            <p>「最近、寝つきが悪くて、職場でうまく話せない」 → 3Mで整理した結果：...</p>

            <h3>想定ユーザー・ライセンス・クレジット</h3>
            <p>（READMEの内容をそのまま残す）</p>
          </article>
        </section>
      </main>

      <footer class="mt-6 text-sm muted">
        <div class="flex justify-between items-center">
          <div>MIT License — 3M by Uchida16104</div>
          <div><a href="https://github.com/Uchida16104/3M" target="_blank" class="underline">Source on GitHub</a></div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Hidden printable support template -->
  <div id="printTemplate" class="hidden">
    <div style="font-family: system-ui; padding: 20px;">
      <h2>支援機関連絡先</h2>
      <p>いのちの電話（全国）： https://www.inochinodenwa.org/?page_id=267</p>
      <p>救急：119</p>
      <p>警察：110</p>
      <p>TELL Lifeline（英語対応）：03-5774-0992</p>
    </div>
  </div>

  <!-- Application JavaScript -->
  <script>
    (function () {
      // --- Utility: query helpers ---
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      // --- Pages management (id-based single-file pages) ---
      const pages = ['home','mind','message','move','safety','about'];
      function showPage(id, push = true) {
        pages.forEach(p => {
          const el = document.getElementById(p);
          if (!el) return;
          const is = (p === id);
          el.setAttribute('aria-hidden', (!is).toString());
        });
        // Update history (we push fragment so index.html#id is visible)
        if (push) {
          const newUrl = location.pathname + '#' + id;
          history.pushState({page:id}, '', newUrl);
        }
        // Run any page-specific refresh
        if (id === 'mind') { $('#mindInput')?.focus(); }
      }

      // Init: show page by hash or default to home
      function initPageFromHash() {
        const h = (location.hash||'#home').replace(/^#/, '');
        showPage(pages.includes(h) ? h : 'home', false);
      }
      window.addEventListener('popstate', (e) => {
        const id = (e.state && e.state.page) || (location.hash||'#home').replace(/^#/, '');
        showPage(id, false);
      });

      // Intercept clicks on anchors that have fragments: use single-file nav and still show HTMX attr presence
      document.addEventListener('click', (ev) => {
        const a = ev.target.closest('a[href^="#"]');
        if (!a) return;
        ev.preventDefault();
        const frag = a.getAttribute('href').replace(/^#/, '') || 'home';
        showPage(frag, true);
      });

      // --- HTMX note: anchors include hx-push-url="true" attribute to show explicit HTMX usage as requested ---
      // (We use our own client-side routing so the app is fully offline-friendly in a single file.)

      // --- IndexedDB simple wrapper for autosave/restore ---
      const DB_NAME = '3m-db';
      const DB_STORE = 'drafts';
      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(DB_STORE)) {
              db.createObjectStore(DB_STORE);
            }
          };
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = (e) => reject(e.target.error);
        });
      }
      async function idbPut(key, value) {
        const db = await openDB();
        return new Promise((res, rej) => {
          const tx = db.transaction(DB_STORE, 'readwrite');
          tx.objectStore(DB_STORE).put(value, key);
          tx.oncomplete = () => res();
          tx.onerror = (e) => rej(e.target.error);
        });
      }
      async function idbGet(key) {
        const db = await openDB();
        return new Promise((res, rej) => {
          const tx = db.transaction(DB_STORE, 'readonly');
          const r = tx.objectStore(DB_STORE).get(key);
          r.onsuccess = () => res(r.result);
          r.onerror = (e) => rej(e.target.error);
        });
      }
      async function idbDelete(key) {
        const db = await openDB();
        return new Promise((res, rej) => {
          const tx = db.transaction(DB_STORE, 'readwrite');
          tx.objectStore(DB_STORE).delete(key);
          tx.oncomplete = () => res();
          tx.onerror = (e) => rej(e.target.error);
        });
      }

      // --- Autosave / Data model ---
      const state = {
        mindRaw: '',
        pieces: [],      // array of {id, text}
        selected5: [],  // array of objects {id,text,urgency,importance}
        top3: [],       // array of objects {id,text,rank}
        finalMessage: ''
      };

      function updateAutosaveLabel(msg) {
        $('#autosaveState').textContent = msg || '未保存';
      }

      async function saveAllToIDB() {
        await idbPut('3m-data', JSON.stringify(state));
        updateAutosaveLabel(new Date().toLocaleTimeString());
      }

      async function restoreFromIDB() {
        try {
          const raw = await idbGet('3m-data');
          if (!raw) return;
          const obj = JSON.parse(raw);
          Object.assign(state, obj);
          // populate UI from state
          $('#mindInput').value = state.mindRaw || '';
          renderPieces();
          renderFive();
          renderTop3();
          $('#finalMessage').value = state.finalMessage || '';
          updateAutosaveLabel('復元済み');
        } catch (e) {
          console.warn('restore failed', e);
        }
      }

      // --- Splitting algorithm by Japanese punctuation (、。) and full stops (.) and newlines ---
      function splitIntoPieces(text) {
        if (!text) return [];
        // Replace multiple whitespace
        const normalized = text.replace(/\r/g,'').trim();
        // Split by Japanese punctuation or English dot followed by space or linebreak.
        // Keep each as element and trim.
        const rawPieces = normalized.split(/(?<=[、。．.!?])\s*|\n+/).map(s => s.trim()).filter(Boolean);
        // If splitting didn't produce anything, fallback to entire text
        if (rawPieces.length === 0 && normalized) rawPieces.push(normalized);
        // make id keys
        return rawPieces.map((t,i)=>({id:'p'+Date.now().toString(36)+i, text:t}));
      }

      // --- Rendering pieces to UI (each as a textarea) ---
      function renderPieces() {
        const ul = $('#pieces');
        ul.innerHTML = '';
        state.pieces.forEach(piece => {
          const li = document.createElement('li');
          li.className = 'p-2 border rounded bg-slate-50';
          const ta = document.createElement('textarea');
          ta.value = piece.text;
          ta.className = 'w-full p-2 rounded';
          ta.addEventListener('input', () => {
            piece.text = ta.value;
            triggerChecks();
          });
          const controls = document.createElement('div');
          controls.className = 'mt-2 flex gap-2';
          const addBtn = document.createElement('button');
          addBtn.textContent = '＋追加';
          addBtn.className = 'px-2 py-1 rounded bg-white border text-sm';
          addBtn.addEventListener('click', () => {
            const newPiece = {id:'p'+Date.now().toString(36), text:''};
            state.pieces.splice(state.pieces.indexOf(piece)+1,0,newPiece);
            renderPieces();
            triggerChecks();
          });
          const delBtn = document.createElement('button');
          delBtn.textContent = '削除';
          delBtn.className = 'px-2 py-1 rounded bg-accent-500 text-white text-sm';
          delBtn.addEventListener('click', () => {
            state.pieces = state.pieces.filter(p=>p!==piece);
            renderPieces();
            triggerChecks();
          });
          const pickBtn = document.createElement('button');
          pickBtn.textContent = '5へ追加';
          pickBtn.className = 'px-2 py-1 rounded bg-brand-500 text-white text-sm';
          pickBtn.addEventListener('click', () => {
            if (state.selected5.length >= 5) { alert('既に5つあります'); return; }
            state.selected5.push({id:piece.id, text: piece.text||'', urgency:0, importance:0});
            renderFive();
            triggerChecks();
          });
          controls.appendChild(addBtn);
          controls.appendChild(delBtn);
          controls.appendChild(pickBtn);
          li.appendChild(ta);
          li.appendChild(controls);
          ul.appendChild(li);
        });
        // allow adding new piece
        const addNew = document.createElement('div');
        addNew.className = 'mt-2';
        const addBtnAll = document.createElement('button');
        addBtnAll.textContent = '新しい要素を追加';
        addBtnAll.className = 'px-3 py-2 rounded bg-brand-500 text-white text-sm';
        addBtnAll.addEventListener('click', () => {
          state.pieces.push({id:'p'+Date.now().toString(36), text:''});
          renderPieces();
        });
        addNew.appendChild(addBtnAll);
        ul.appendChild(addNew);
      }

      // Render selected 5 container
      function renderFive() {
        const cont = $('#fiveContainer');
        cont.innerHTML = '';
        state.selected5.forEach((it, idx) => {
          const card = document.createElement('div');
          card.className = 'p-3 border rounded bg-slate-50';
          const ta = document.createElement('textarea');
          ta.value = it.text;
          ta.className = 'w-full p-2 rounded';
          ta.addEventListener('input', () => {
            it.text = ta.value;
            triggerChecks();
          });
          const row = document.createElement('div');
          row.className = 'mt-2 flex gap-2 items-center';
          // urgency textarea (we use textarea as requested)
          const uLabel = document.createElement('label');
          uLabel.className = 'text-sm';
          uLabel.innerHTML = '緊急度（0〜5）<br/>';
          const uTa = document.createElement('textarea');
          uTa.value = it.urgency;
          uTa.className = 'w-24 p-1 rounded';
          uTa.addEventListener('input', () => {
            it.urgency = Math.max(0,Math.min(5,parseInt(uTa.value||0)||0));
            uTa.value = it.urgency;
            triggerChecks();
          });
          const iLabel = document.createElement('label');
          iLabel.className = 'text-sm';
          iLabel.innerHTML = '重要度（0〜5）<br/>';
          const iTa = document.createElement('textarea');
          iTa.value = it.importance;
          iTa.className = 'w-24 p-1 rounded';
          iTa.addEventListener('input', () => {
            it.importance = Math.max(0,Math.min(5,parseInt(iTa.value||0)||0));
            iTa.value = it.importance;
            triggerChecks();
          });
          const del = document.createElement('button');
          del.textContent = '削除';
          del.className = 'px-2 py-1 rounded bg-accent-500 text-white text-sm ml-auto';
          del.addEventListener('click', () => {
            state.selected5 = state.selected5.filter(x=>x!==it);
            renderFive();
            triggerChecks();
          });
          row.appendChild(uLabel); row.appendChild(uTa);
          row.appendChild(iLabel); row.appendChild(iTa);
          row.appendChild(del);
          card.appendChild(ta);
          card.appendChild(row);
          cont.appendChild(card);
        });
        if (state.selected5.length === 0) {
          cont.innerHTML = '<p class="text-sm muted">右上の Mind ページから要素を5つ追加してください。</p>';
        }
      }

      // pick top 5 by combined score from existing pieces if selected5 empty
      function autoPickTop5FromPieces() {
        const candidates = state.pieces.map(p => ({id:p.id, text:p.text, urgency:0,importance:0}));
        // naive: choose first 5 non-empty
        const chosen = candidates.filter(c=>c.text && c.text.trim()).slice(0,5);
        // if less than 5, fill blanks
        while (chosen.length < 5) {
          chosen.push({id:'auto'+Date.now().toString(36)+(chosen.length), text:'', urgency:0,importance:0});
        }
        state.selected5 = chosen;
        renderFive();
        triggerChecks();
      }

      // Confirm top 5 to be used in next phase -> we allow user to continue
      function confirm5() {
        // ensure length 5
        if (state.selected5.length < 1) { alert('少なくとも1項目を選んでください'); return; }
        // sort by combined descending (urgency+importance)
        state.selected5.sort((a,b)=>(b.urgency+b.importance)-(a.urgency+a.importance));
        // move to message->move pages
        showPage('move');
        // create top3 initial from first 3
        state.top3 = state.selected5.slice(0,3).map((s,i)=>({id:s.id, text:s.text, rank:i+1}));
        renderTop3();
        triggerChecks();
      }

      // Render top3 container with reorder (priority) controls (textarea-based)
      function renderTop3() {
        const c = $('#top3Container');
        c.innerHTML = '';
        if (!state.top3 || state.top3.length === 0) {
          c.innerHTML = '<p class="text-sm muted">上位3つがここに表示されます。Message ページで5つを確定してください。</p>';
          return;
        }
        state.top3.forEach((t, idx) => {
          const card = document.createElement('div');
          card.className = 'p-3 border rounded bg-slate-50 flex flex-col gap-2';
          const label = document.createElement('div');
          label.className = 'flex items-center gap-2';
          const rank = document.createElement('div');
          rank.className = 'w-8 h-8 flex items-center justify-center rounded-full bg-brand-500 text-white font-semibold';
          rank.textContent = t.rank;
          const ta = document.createElement('textarea');
          ta.value = t.text;
          ta.className = 'w-full p-2 rounded';
          ta.addEventListener('input', ()=> {
            t.text = ta.value;
            triggerChecks();
          });
          const controls = document.createElement('div');
          controls.className = 'flex gap-2 mt-2';
          const up = document.createElement('button');
          up.textContent = '上へ';
          up.className = 'px-2 py-1 rounded bg-white border text-sm';
          up.disabled = (idx === 0);
          up.addEventListener('click', ()=> {
            if (idx === 0) return;
            const a = state.top3[idx-1]; state.top3[idx-1] = state.top3[idx]; state.top3[idx] = a;
            // reassign ranks
            state.top3.forEach((s,i)=>s.rank=i+1);
            renderTop3();
            triggerChecks();
          });
          const down = document.createElement('button');
          down.textContent = '下へ';
          down.className = 'px-2 py-1 rounded bg-white border text-sm';
          down.disabled = (idx === state.top3.length-1);
          down.addEventListener('click', ()=> {
            if (idx === state.top3.length-1) return;
            const a = state.top3[idx+1]; state.top3[idx+1] = state.top3[idx]; state.top3[idx] = a;
            state.top3.forEach((s,i)=>s.rank=i+1);
            renderTop3();
            triggerChecks();
          });
          const remove = document.createElement('button');
          remove.textContent = '削除';
          remove.className = 'px-2 py-1 rounded bg-accent-500 text-white text-sm ml-auto';
          remove.addEventListener('click', ()=> {
            state.top3 = state.top3.filter(x=>x!==t);
            state.top3.forEach((s,i)=>s.rank=i+1);
            renderTop3();
            triggerChecks();
          });
          controls.appendChild(up); controls.appendChild(down); controls.appendChild(remove);
          label.appendChild(rank);
          label.appendChild(document.createElement('div'));
          card.appendChild(label);
          card.appendChild(ta);
          card.appendChild(controls);
          c.appendChild(card);
        });

        // Compose initial final message skeleton if empty
        if (!state.finalMessage || state.finalMessage.trim() === '') {
          const lines = [
            '（話の目的）',
            ...state.top3.map((t,i)=>`${i+1}. ${t.text}`),
            '（お願い・確認）'
          ];
          state.finalMessage = lines.join('\n\n');
          $('#finalMessage').value = state.finalMessage;
        } else {
          $('#finalMessage').value = state.finalMessage;
        }
      }

      // copy final message to clipboard
      async function copyFinal() {
        try {
          await navigator.clipboard.writeText($('#finalMessage').value || '');
          alert('メッセージをクリップボードにコピーしました');
        } catch (e) {
          alert('コピーに失敗しました: ' + e.message);
        }
      }

      // --- PDF / Image export ---
      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        // We'll capture the main container
        const container = document.querySelector('main');
        const canvas = await html2canvas(container, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save('3m_export.pdf');
      }

      async function exportPNG() {
        const container = document.querySelector('main');
        const canvas = await html2canvas(container, { scale: 2 });
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = '3m_export.png';
        a.click();
      }

      // --- Safety checks (naive word detection) ---
      const highRiskWords = ["死にたい","消えたい","もう終わりにしたい","消したい","死にたいです","死にたい。","死にたい。"];
      function checkHighRisk(text) {
        if (!text) return false;
        const lowered = text.toLowerCase();
        return highRiskWords.some(w => lowered.includes(w) || text.includes(w));
      }

      function triggerChecks() {
        // update state from UI fields
        state.mindRaw = $('#mindInput') ? $('#mindInput').value : state.mindRaw;
        state.finalMessage = $('#finalMessage') ? $('#finalMessage').value : state.finalMessage;
        // composite text for scanning
        const composite = [state.mindRaw, state.selected5.map(x=>x.text).join(' '), state.finalMessage].join(' ');
        const risk = checkHighRisk(composite);
        if (risk) {
          $('#emergency').classList.remove('hidden');
        } else {
          $('#emergency').classList.add('hidden');
        }
        // autosave (debounce simple)
        if (triggerChecks.saveTimeout) clearTimeout(triggerChecks.saveTimeout);
        triggerChecks.saveTimeout = setTimeout(async () => {
          // update pieces & other fields into state
          state.mindRaw = $('#mindInput')?.value || state.mindRaw;
          state.finalMessage = $('#finalMessage')?.value || state.finalMessage;
          await saveAllToIDB();
        }, 600);
      }

      // --- Bind UI events ---
      document.getElementById('splitBtn').addEventListener('click', () => {
        const txt = $('#mindInput').value;
        const pieces = splitIntoPieces(txt);
        // Merge with existing pieces (append)
        // If existing pieces empty, replace
        if (!state.pieces || state.pieces.length === 0) state.pieces = pieces;
        else state.pieces = state.pieces.concat(pieces);
        state.mindRaw = txt;
        renderPieces();
        triggerChecks();
      });

      document.getElementById('clearMind').addEventListener('click', () => {
        if (!confirm('Mindの入力をクリアしますか？')) return;
        $('#mindInput').value = '';
        state.mindRaw = '';
        state.pieces = [];
        renderPieces();
        triggerChecks();
      });

      document.getElementById('autoPickBtn').addEventListener('click', ()=> {
        autoPickTop5FromPieces();
      });

      document.getElementById('confirm5Btn').addEventListener('click', ()=> confirm5());

      document.getElementById('copyBtn').addEventListener('click', ()=> copyFinal());

      document.getElementById('saveBtn').addEventListener('click', async ()=> {
        await saveAllToIDB();
        alert('ローカルに保存しました（IndexedDB）');
      });

      document.getElementById('pdfBtn').addEventListener('click', ()=> exportPDF());
      document.getElementById('imgBtn').addEventListener('click', ()=> exportPNG());

      // print support button
      $('#printSupport').addEventListener('click', ()=> {
        const w = window.open('', '_blank');
        w.document.write('<html><head><title>支援機関案内</title></head><body>');
        w.document.write(document.getElementById('printTemplate').innerHTML);
        w.document.write('</body></html>');
        w.document.close();
        w.print();
      });
      $('#printSupport2').addEventListener('click', ()=> {
        $('#printSupport').click();
      });

      // Support call button uses tel: links (already in DOM). But allow overriding
      $('#supportCallButton').addEventListener('click', (ev)=> {
        // fallback: open tel or show alert
        // (default <a href> will handle actual call in mobile)
      });

      // restore existing data on load
      window.addEventListener('load', async () => {
        initPageFromHash();
        await restoreFromIDB();
        // Render UI
        renderPieces();
        renderFive();
        renderTop3();
        // initial run checks
        triggerChecks();
      });

      // expose some debug helpers
      window._3m_state = state;
      window._3m_save = saveAllToIDB;
      window._3m_restore = restoreFromIDB;

      // Small UX: when finalMessage changes, update state
      $('#finalMessage').addEventListener('input', ()=> {
        state.finalMessage = $('#finalMessage').value;
        triggerChecks();
      });

      // When user clicks send (dummy), show confirm & clear top3 if requested
      $('#sendBtn').addEventListener('click', ()=> {
        alert('（デモ）「送信」操作をシミュレーションしました。実際の送信は実装されていません。');
      });

    })();
  </script>

</body>
</html>
