<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" sizes="32x32" href="./3M.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./3M.png">
  <link rel="apple-touch-icon" href="./3M.png" sizes="180x180">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="./3M.png">

  <title>ğŸ§  3M â€” I Message to You About My Mind.</title>

  <!-- HTMXï¼ˆè¦ä»¶ï¼šunpkg ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰ -->
  <script src="https://unpkg.com/htmx.org"></script>

  <style>
    :root{font-family: system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    body{padding:20px;max-width:900px;margin:0 auto;background:#f7f9fb;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{margin-top:0;color:#444}
    textarea,input[type=text]{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ccd;border-radius:8px}
    .card{background:white;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    ul{padding-left:18px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button, a.button{background:#1565d8;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
    .secondary{background:#eee;color:#111}
    .small{font-size:13px;color:#666}
    .item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .item .controls{display:flex;flex-direction:column;gap:6px}
    .draggable{cursor:grab}
    .final{white-space:pre-wrap;background:#0b1220;color:#e8f0ff;padding:12px;border-radius:8px}
    .danger{color:#b00020}
    .hidden{display:none !important}
    button[data-action="add"] {
      background: #16a085;
      color: white;
    }
    button[data-action="del"] {
      background: #e74c3c;
      color: white;
    }
    button[data-action="up"] {
      background: #f1c40f;
      color: #111;
    }
    button[data-action="down"] {
      background: #2980b9;
      color: white;
    }
    .progressWrap { margin-top:10px; height:10px; background:#e6eef8; border-radius:999px; overflow:hidden; }
    .progressBar { height:100%; width:0%; background:linear-gradient(90deg,#1565d8,#4fc3f7); transition:width .25s ease; }
    .progressLabel { font-size:12px; color:#666; margin-top:6px; }

    /* new: responsive & small UI for tags and inline selector */
    .inlineRow { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .bracketSelect { display:inline-flex; align-items:center; gap:6px; }
    .bracketSelect select { padding:8px;border-radius:8px;border:1px solid #ccd;background:white; appearance: none; -webkit-appearance:none; }
    .nameInput { max-width:320px; min-width:160px; }
    .recipientTags { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .tag { background:#eef6ff; color:#083d77; padding:6px 8px; border-radius:999px; display:inline-flex; gap:8px; align-items:center; font-size:13px; }
    .tag button { background:transparent; border:none; cursor:pointer; font-weight:700; color:#083d77; padding:0 4px; }
    .tagInput { border:1px dashed #cbd6e6; min-width:180px; padding:6px 8px; border-radius:8px; }
    @media (max-width:640px){
      body{padding:12px}
      .card{padding:12px}
      .bracketSelect select{padding:6px}
    }
  </style>
</head>
<body>
  <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
  <p class="lead">è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªã„ã¨ãã«ã€è©±ã™å†…å®¹ã‚’æ®µéšçš„ã«æ•´ç†ã—ã¦ç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«æ²¿ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚</p>
  <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºã®é€²æ—è¡¨ç¤ºï¼‰ -->
  <div id="progressContainer" class="card" style="padding:10px 14px;margin-top:6px;">
    <div class="progressWrap" aria-hidden="true"><div id="progressBar" class="progressBar"></div></div>
    <div id="progressLabel" class="progressLabel">ãƒ•ã‚§ãƒ¼ã‚º 1 / 6</div>
  </div>
  <!-- ãƒ•ã‚§ãƒ¼ã‚º1 -->
  <section class="card" id="phase1">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º1 â€” ã‚ã‚Šã®ã¾ã¾å…¥åŠ›</h2>
    <p class="small">æ€ã£ãŸã“ã¨ã‚’ãã®ã¾ã¾æ›¸ãå‡ºã—ã¾ã™ï¼ˆé•·æ–‡å¯ï¼‰ã€‚</p>
    <textarea id="rawText" rows="6" placeholder="ã“ã“ã«æ€ã£ã¦ã„ã‚‹ã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„...&#10;ã€ä¾‹æ–‡ï¼šå ±å‘Šã€‘ä½œæ¥­é…å»¶ã«ã¤ã„ã¦&#10;ï¼ˆçµè«–ï¼‰&#10;æœ¬æ—¥ã®è³‡æ–™ä½œæˆã¯å®Œäº†ã§ãã¾ã›ã‚“ã€‚&#10;ï¼ˆäº‹å®Ÿï¼‰&#10;åˆå‰ä¸­ã«æƒ³å®šå¤–ã®ä¿®æ­£æŒ‡ç¤ºãŒ3ä»¶å…¥ã‚Šã€ä½œæ¥­æ™‚é–“ãŒä¸è¶³ã—ã¾ã—ãŸã€‚&#10;ï¼ˆå½±éŸ¿ï¼‰&#10;æœ¬æ—¥ä¸­ã®æå‡ºãŒã§ããªã„ãŸã‚ã€æ˜æ—¥ã®ä¼šè­°è³‡æ–™ã«åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚&#10;ï¼ˆè¦æœ›ï¼‰&#10;æå‡ºæœŸé™ã‚’æ˜æ—¥ã®12æ™‚ã¾ã§å»¶ã°ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ã€‚"></textarea>
    <div style="margin-top:10px">
      <!-- hx-push-url ã¯è¦ä»¶ã©ãŠã‚Šä»˜ä¸ã€‚å®Ÿéš›ã®è¡¨ç¤ºã¯ JS ã® navigatePhase ã§è¡Œã† -->
      <button id="toPhase2" hx-push-url="true" data-phase="phase2" class="btn-next">5ã¤ã«åˆ†è§£ã™ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º2</button>
    </div>
  </section>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º2 -->
  <section class="card hidden" id="phase2">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º2 â€” 5ã¤ã®è¦ç´ ã«åˆ†è§£</h2>
    <p class="small">å…¥åŠ›ã‚’è‡ªå‹•ã§æ–‡ã‚„å¥ã«åˆ†å‰²ã—ã¾ã™ã€‚ç·¨é›†ã—ã¦1è¦ç´ ãšã¤ä¸å¯§ã«æ•´ãˆã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚</p>
    <ul id="elementsList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="backTo1" class="secondary" hx-push-url="true" data-phase="phase1">æˆ»ã‚‹</button>
      <button id="toPhase3" hx-push-url="true" data-phase="phase3" class="btn-next">å„ªå…ˆåº¦ãƒã‚§ãƒƒã‚¯ â†’ ãƒ•ã‚§ãƒ¼ã‚º3</button>
    </div>
  </section>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º3 -->
  <section class="card hidden" id="phase3">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º3 â€” ç·Šæ€¥åº¦ã¨å„ªå…ˆé †ä½ã§ä¸Šä½3ã¤ã«çµã‚‹</h2>
    <p class="small">ãã‚Œãã‚Œã®è¦ç´ ã«ã¤ã„ã¦ã€ç·Šæ€¥æ€§ï¼ˆ0-5ï¼‰ã¨é‡è¦æ€§ï¼ˆ0-5ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è‡ªå‹•çš„ã«åˆè¨ˆã‚¹ã‚³ã‚¢ã§ä¸Šä½3ã¤ãŒé¸ã°ã‚Œã¾ã™ã€‚æ‰‹å‹•ã§ãƒ”ãƒ³ç•™ã‚ã‚‚å¯èƒ½ã§ã™ã€‚</p>
    <ul id="priorityList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo2" class="secondary" hx-push-url="true" data-phase="phase2">æˆ»ã‚‹</button>
      <button id="toPhase4" hx-push-url="true" data-phase="phase4" class="btn-next">3ã¤ã«çµã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º4</button>
    </div>
  </section>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º4 -->
  <section class="card hidden" id="phase4">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º4 â€” 3ã¤ã®è¦ç´ ã«å„ªå…ˆé †ä½ã‚’ä»˜ã‘ã‚‹</h2>
    <p class="small">ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§é †åºã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆä¸ŠãŒä¼ãˆã‚‹é †åºã®å„ªå…ˆåº¦é«˜ï¼‰ã€‚</p>
    <ul id="orderedList"></ul>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="backTo3" class="secondary" hx-push-url="true" data-phase="phase3">æˆ»ã‚‹</button>
      <button id="toPhase5" hx-push-url="true" data-phase="phase5" class="btn-next">æ–‡ç« ã‚’çµ„ã¿ç«‹ã¦ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º5</button>
    </div>
  </section>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º5 -->
  <section class="card hidden" id="phase5">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º5 â€” ç›¸æ‰‹ã«ä¼ãˆã‚‹æ–‡ç« ã‚’ä½œã‚‹</h2>
    <p class="small">é¸ã°ã‚ŒãŸ3ã¤ã‚’çŸ­ãã€å…·ä½“çš„ãªä¸€è¨€ãšã¤ã«ã¾ã¨ã‚ã¾ã™ã€‚ç›¸æ‰‹ã«ä¼ãˆã‚‹ã¨ãã®å†’é ­ï¼ˆç›®çš„ï¼‰ã¨æœ€å¾Œï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰ã‚‚ç”¨æ„ã—ã¾ã™ã€‚</p>
    <div class="inlineRow" style="margin-bottom:8px;">
      <div class="bracketSelect" aria-hidden="true">
        <label class="small" for="typeSelect">åˆ†é¡</label>
        <span style="font-size:13px;">ã€</span>
        <select id="typeSelect" aria-label="åˆ†é¡(å ±å‘Š/é€£çµ¡/ç›¸è«‡/ç·Šæ€¥)"><!-- è¡¨ç¤ºã¯ã€ã€‘ä»˜ã -->
          <option value="å ±å‘Š">å ±å‘Š</option>
          <option value="é€£çµ¡">é€£çµ¡</option>
          <option value="ç›¸è«‡">ç›¸è«‡</option>
          <option value="ç·Šæ€¥">ç·Šæ€¥</option>
          <option value="ä¸æ˜">ä¸æ˜</option>
        </select>
        <span style="font-size:13px;">ã€‘</span>
      </div>

      <div style="flex:1">
        <label class="small">æ°å</label>
        <input type="text" id="personName" class="nameInput" rows="1" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"></input>
      </div>
    </div>

    <div style="margin-top:6px">
      <label class="small">å†’é ­ï¼ˆç›®çš„ï¼ä»¶åï¼‰</label>
      <textarea id="intro" rows="1" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯â—‹â—‹ã«ã¤ã„ã¦è©±ã—ãŸãã¦æ¥ã¾ã—ãŸã€‚"></textarea>
    </div>

    <ul id="finalInputs"></ul>
    <div style="margin-top:8px">
      <label class="small">ç· ã‚ï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰</label>
      <textarea id="closing" rows="1" placeholder="ä¾‹ï¼šã“ã‚Œã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿï¼åŠ©ã‘ã¦ã»ã—ã„ã§ã™ã€‚"></textarea>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="backTo4" class="secondary" hx-push-url="true" data-phase="phase4">æˆ»ã‚‹</button>
      <button id="toPhase6" hx-push-url="true" data-phase="phase6" class="btn-next">å®Œæˆ â†’ ãƒ•ã‚§ãƒ¼ã‚º6</button>
    </div>
  </section>

  <!-- ãƒ•ã‚§ãƒ¼ã‚º6 -->
  <section class="card hidden" id="phase6">
    <h2>ãƒ•ã‚§ãƒ¼ã‚º6 â€” å®Œæˆ</h2>
    <p class="small">ä¸‹ãŒç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®æœ€çµ‚æ–‡ç« ã§ã™ã€‚ç·¨é›†ã‚‚ã§ãã¾ã™ã€‚</p>
    <div class="final" id="finalMessage" contenteditable="false"></div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
      <button id="editBtn" class="secondary">ç·¨é›†ã™ã‚‹</button>
      <button id="resetBtn" class="secondary">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
      <!-- PDFãƒœã‚¿ãƒ³ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç”Ÿæˆã—ã¦è¿½åŠ ï¼ˆå‹•çš„ãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰ -->
    </div>

    <!-- recipients and mail controls -->
    <div style="display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap">
      <div style="flex:1; min-width:220px;">
        <label class="small">é€ä¿¡å…ˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰</label>
        <div class="recipientTags" id="recipientTags" aria-live="polite" style="margin-top:6px;">
          <!-- tags go here -->
          <input id="tagInput" class="tagInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ Enter ã¾ãŸã¯ã‚«ãƒ³ãƒã§è¿½åŠ " />
        </div>
        <div class="small" style="margin-top:6px;color:#666">è¤‡æ•°å¯ã€‚å‰Šé™¤ã¯ã‚¿ã‚°ã® Ã— ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <!-- PDF and Send buttons are placed together -->
        <!-- PDF button will be inserted by JS with id=pdfBtn -->
        <button id="sendMailBtn" style="background:#2e7d32;">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆ</button>
      </div>
    </div>

  </section>

  <script>
    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆDOMã‚¯ã‚¨ãƒªï¼‰ ---
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // phases å®šç¾©
    const phases = ['phase1','phase2','phase3','phase4','phase5','phase6'];

    // --- ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºåˆ¶å¾¡ ---
    function showPhase(phaseId, options = {}) {
      qsa('section[id^="phase"]').forEach(s => {
        if (s.id === phaseId) s.classList.remove('hidden');
        else s.classList.add('hidden');
      });

      const frag = '#' + phaseId;
      try {
        if (window.htmx && typeof htmx.pushUrl === 'function') {
          htmx.pushUrl(location.pathname + frag);
        } else {
          history.replaceState(null, '', location.pathname + frag);
        }
      } catch (e) {
        try { history.replaceState(null, '', location.pathname + frag); } catch (_){ }
      }

      const idx = phases.indexOf(phaseId);
      const total = phases.length;
      const pct = Math.round(((idx+1) / total) * 100);
      const bar = qs('#progressBar'); if(bar) bar.style.width = pct + '%';
      const label = qs('#progressLabel'); if(label) label.textContent = `ãƒ•ã‚§ãƒ¼ã‚º ${idx+1} / ${total}`;

      if (options && typeof options.after === 'function') options.after();
    }

    (function initPhaseFromFragment(){
      const frag = location.hash ? location.hash.replace('#','') : 'phase1';
      const valid = !!qs('#' + frag);
      showPhase(valid ? frag : 'phase1');
    })();

    qsa('button[data-phase]').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev && ev.preventDefault && ev.preventDefault();
        const target = btn.getAttribute('data-phase');
        if (!target) return;
        showPhase(target);
      });
    });

    // --- ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function splitIntoPieces(text, maxPieces){
      if(!text) return Array.from({length:maxPieces},()=>"");
      let pieces = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      pieces = pieces.flatMap(p => p.split(/(?<=[ã€‚ï¼.!?ï¼Ÿ])\s*/));
      pieces = pieces.map(s=>s.trim()).filter(Boolean);
      if(pieces.length > maxPieces){
        while(pieces.length > maxPieces){
          let a = pieces.splice(pieces.length-2,2).join(' ');
          pieces.push(a);
        }
      }
      while(pieces.length < maxPieces) pieces.push("");
      return pieces.slice(0,maxPieces);
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // --- Phase1 -> Phase2 ---
    qs('#toPhase2').addEventListener('click', ()=>{
      const raw = qs('#rawText').value.trim();
      const arr = splitIntoPieces(raw,5);
      const ul = qs('#elementsList'); ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <textarea data-index="${i}" class="elementInput" rows="2"></textarea>
          </div>
          <div class="controls">
            <button class="secondary" data-action="add" data-index="${i}">ï¼‹</button>
            <button class="secondary" data-action="del" data-index="${i}">ï¼</button>
          </div>
        `;
        ul.appendChild(li);
        const input = li.querySelector('.elementInput'); if(input) input.value = t;
      });
      showPhase('phase2');
    });

    qs('#backTo1').addEventListener('click', ()=>{ showPhase('phase1'); });

    // add/delete element fields
    qs('#elementsList').addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const action = b.dataset.action; const idx = Number(b.dataset.index);
      const inputs = qsa('.elementInput').map(x=>x.value);
      if(action==='add') inputs.splice(idx+1,0,'');
      if(action==='del') inputs.splice(idx,1);
      while(inputs.length < 5) inputs.push('');
      while(inputs.length > 5) inputs.pop();
      const ul = qs('#elementsList'); ul.innerHTML='';
      inputs.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item'; li.innerHTML=`
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <textarea data-index="${i}" class="elementInput" rows="2"></textarea>
          </div>
          <div class="controls">
            <button class="secondary" data-action="add" data-index="${i}">ï¼‹</button>
            <button class="secondary" data-action="del" data-index="${i}">ï¼</button>
          </div>`;
        ul.appendChild(li);
        const input = li.querySelector('.elementInput'); if(input) input.value = t;
      });
    });

    // Phase2 -> Phase3
    qs('#toPhase3').addEventListener('click', ()=>{
      const full = qsa('.elementInput').map(i=>i.value.trim());
      const ul = qs('#priorityList'); ul.innerHTML='';
      full.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <textarea class="ptext" data-i="${i}" rows="2"></textarea>
          </div>
          <div style="width:220px">
            <label class="small">ç·Šæ€¥æ€§ (0-5)</label>
            <input type="number" class="urg" min="0" max="5" value="0" />
            <label class="small">é‡è¦æ€§ (0-5)</label>
            <input type="number" class="imp" min="0" max="5" value="0" />
            <div style="margin-top:6px"><input type="checkbox" class="pin" /> ãƒ”ãƒ³ç•™ã‚ï¼ˆå¿…ãšæ®‹ã™ï¼‰</div>
          </div>
        `;
        ul.appendChild(li);
        const textInput = li.querySelector('.ptext'); if(textInput) textInput.value = t;
      });
      showPhase('phase3');
    });

    qs('#backTo2').addEventListener('click', ()=>{ showPhase('phase2'); });

    // Phase3 -> Phase4 (select top3)
    qs('#toPhase4').addEventListener('click', ()=>{
      const items = qsa('#priorityList .item').map(li=>{
        const textEl = li.querySelector('.ptext');
        const text = textEl ? textEl.value.trim() : '';
        const urg = Number(li.querySelector('.urg').value)||0;
        const imp = Number(li.querySelector('.imp').value)||0;
        const pin = li.querySelector('.pin').checked;
        return {text,urg,imp,pin,score:urg+imp};
      }).filter(x=>x.text);
      if(items.length===0){ alert('è¦ç´ ãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚§ãƒ¼ã‚º2ã«æˆ»ã£ã¦è¦ç´ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      items.sort((a,b)=> (b.score - a.score) || (b.imp - a.imp));
      const pinned = items.filter(i=>i.pin);
      let top = items.slice(0,3);
      pinned.forEach(p=>{ if(!top.includes(p)) { top.pop(); top.push(p); } });
      top = Array.from(new Set(top)).slice(0,3);
      while(top.length<3) top.push({text:'',urg:0,imp:0,score:0});

      const ul = qs('#orderedList'); ul.innerHTML='';
      top.forEach((it,idx)=>{
        const li = document.createElement('li'); li.className='item draggable';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">å„ªå…ˆ ${idx+1}</label>
            <textarea class="ordtext" data-idx="${idx}" rows="2"></textarea>
          </div>
          <div class="controls">
            <button class="secondary" data-action="up" data-idx="${idx}">â†‘</button>
            <button class="secondary" data-action="down" data-idx="${idx}">â†“</button>
          </div>
        `;
        ul.appendChild(li);
        const ordInput = li.querySelector('.ordtext'); if(ordInput) ordInput.value = it.text;
      });

      showPhase('phase4');
    });

    qs('#backTo3').addEventListener('click', ()=>{ showPhase('phase3'); });

    // reorder up/down
    qs('#orderedList').addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const action = b.dataset.action; const idx = Number(b.dataset.idx);
      const inputs = qsa('.ordtext').map(i=>i.value);
      if(action==='up' && idx>0){ [inputs[idx-1],inputs[idx]] = [inputs[idx],inputs[idx-1]]; }
      if(action==='down' && idx < inputs.length-1){ [inputs[idx+1],inputs[idx]] = [inputs[idx],inputs[idx+1]]; }
      const ul = qs('#orderedList'); ul.innerHTML='';
      inputs.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item draggable'; li.innerHTML = `
          <div style="flex:1">
            <label class="small">å„ªå…ˆ ${i+1}</label>
            <textarea class="ordtext" data-idx="${i}" rows="2"></textarea>
          </div>
          <div class="controls">
            <button class="secondary" data-action="up" data-idx="${i}">â†‘</button>
            <button class="secondary" data-action="down" data-idx="${i}">â†“</button>
          </div>`;
        ul.appendChild(li);
        const ordInput = li.querySelector('.ordtext'); if(ordInput) ordInput.value = t;
      });
    });

    // Phase4 -> Phase5
    qs('#toPhase5').addEventListener('click', ()=>{
      const arr = qsa('.ordtext').map(i=>i.value.trim()).filter(Boolean);
      if(arr.length===0){ alert('å„ªå…ˆã™ã‚‹è¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æˆ»ã£ã¦è¦ç´ ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚'); return; }
      const ul = qs('#finalInputs'); ul.innerHTML='';
      arr.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item'; li.innerHTML = `
          <div style="flex:1">
            <label class="small">ä¼ãˆã‚‹æ–‡ ${i+1}ï¼ˆçŸ­ãå…·ä½“çš„ã«ï¼‰</label>
            <textarea rows="2" class="finalPiece"></textarea>
          </div>`;
        ul.appendChild(li);
        const ta = li.querySelector('.finalPiece'); if(ta) ta.value = t;
      });
      showPhase('phase5');
    });

    qs('#backTo4').addEventListener('click', ()=>{ showPhase('phase4'); });

    // Phase5 -> Phase6 (build final message & prefill person name)
    qs('#toPhase6').addEventListener('click', ()=>{
      const intro = qs('#intro').value.trim();
      const closing = qs('#closing').value.trim();
      const name = qs('#personName').value.trim();
      const pieces = qsa('.finalPiece').map(t=>t.value.trim()).filter(Boolean);
      const final = buildFinalMessage(intro,pieces,closing);
      // append name at end separated by newline for email body usage when sending
      qs('#finalMessage').textContent = final + (name ? ("\n\n" + name) : "");
      showPhase('phase6');
      // ensure recipient input cleared placeholder is focused
      qs('#tagInput').focus();
    });

    // copy
    qs('#copyBtn').addEventListener('click', ()=>{
      const txt = qs('#finalMessage').textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(txt).then(()=> alert('æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'), ()=> alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); alert('æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'); } catch(e){ alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        document.body.removeChild(ta);
      }
    });
    qs('#editBtn').addEventListener('click', ()=>{ qs('#finalMessage').contentEditable = true; qs('#finalMessage').focus(); });
    qs('#resetBtn').addEventListener('click', ()=>{ if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) { location.hash = '#phase1'; showPhase('phase1'); } });

    function buildFinalMessage(intro,pieces,closing){
      const lines = [];
      if(intro) lines.push(intro);
      pieces.forEach((p,i)=>{ lines.push((i+1) + '. ' + p); });
      if(closing) lines.push(closing);
      return lines.join('\n');
    }

    // Warn: self-harm keywords
    function containsSelfHarmKeywords(text){
      if(!text) return false;
      const keywords = ['æ­»ã«ãŸã„','è‡ªæ®º','å¸Œæ­»','æ¶ˆãˆãŸã„','é¦–ã‚’','æ®ºã—ã¦','çµ‚ã‚ã‚Šã«ã—ãŸã„','æ­»ã‚“ã§'];
      const t = text.replace(/\s+/g,'');
      return keywords.some(k=>t.includes(k));
    }

    const banner = document.createElement('div'); banner.style.padding='10px'; banner.style.borderRadius='8px'; banner.style.marginTop='10px';
    document.body.insertBefore(banner, document.body.firstChild.nextSibling);
    banner.style.display='none';

    qs('#rawText').addEventListener('input', ()=>{
      const v = qs('#rawText').value;
      if(containsSelfHarmKeywords(v)){
        banner.style.display='block'; banner.innerHTML = '<strong class="danger">ã‚‚ã—ä»Šã™ãã«å±é™ºã‚’æ„Ÿã˜ã¦ã„ã‚‹ãªã‚‰ã€ã„ã¾ã™ãæœ€å¯„ã‚Šã®ç·Šæ€¥é€£çµ¡ï¼ˆ119ï¼‰ã¾ãŸã¯è­¦å¯Ÿï¼ˆ110ï¼‰ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚å°‚é–€ã®ç›¸è«‡ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®æ”¯æ´æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>';
      } else { banner.style.display='none'; }
    });

    // footer resources
    const footer = document.createElement('div'); footer.className='card'; footer.style.marginTop='20px'; footer.innerHTML = `
      <h3>æ”¯æ´ãƒ»ç›¸è«‡çª“å£ï¼ˆä¾‹ï¼‰</h3>
      <p class="small">ç·Šæ€¥ã§ãªã„å ´åˆã‚„è©±ã‚’è´ã„ã¦ã»ã—ã„å ´åˆã¯ä¸‹ã®çª“å£ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ <span class="small">ï¼ˆåœ°åŸŸã«ã‚ˆã£ã¦çª“å£ã‚„ç•ªå·ã¯ç•°ãªã‚Šã¾ã™ï¼‰</span></p>
      <ul class="small">
        <li>TELL Lifeline: <a href="tel:03-5774-0992" style="text-decoration: none;">03-5774-0992</a></li>
        <li>ã„ã®ã¡ã®é›»è©±ï¼ˆåœ°åŸŸçª“å£ï¼‰: <a href="https://www.inochinodenwa.org/?page_id=267" style="text-decoration: none;">å„åœ°åŸŸã§24æ™‚é–“ç›¸è«‡ã‚’æä¾›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</a></li>
        <li><a href="https://www.mhlw.go.jp/kokoro/support/pdf/ercenter.pdf" style="text-decoration: none;">å¤œé–“ä¼‘æ—¥ç²¾ç¥ç§‘æ•‘æ€¥åŒ»ç™‚æ©Ÿé–¢æ¡ˆå†…çª“å£</a></li>
        <li>ç·Šæ€¥ãªã‚‰:<a href="tel:119" style="text-decoration: none;">119ï¼ˆæ•‘æ€¥ï¼‰</a> / <a href="tel:110" style="text-decoration: none;">110ï¼ˆè­¦å¯Ÿï¼‰</a></li>
      </ul>
      <p class="small">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯<a href="https://github.com/Uchida16104/3M/blob/main/README.md" style="text-decoration: none;">ã“ã¡ã‚‰ï¼ˆREADME.mdï¼‰</a></p>
    `;
    document.body.appendChild(footer);

    // ===== recipients tag input handling =====
    const tagInput = qs('#tagInput');
    const recipientTags = qs('#recipientTags');
    let recipients = []; // array of email strings

    function renderRecipientTags(){
      // remove existing tag nodes except the input
      const inputs = Array.from(recipientTags.children);
      inputs.forEach(child => {
        if(child !== tagInput) recipientTags.removeChild(child);
      });
      // insert tags before the input
      recipients.forEach((r, i) => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.innerHTML = `<span>${escapeHtml(r)}</span><button aria-label="å‰Šé™¤" data-idx="${i}">Ã—</button>`;
        recipientTags.insertBefore(span, tagInput);
      });
    }

    function normalizeAndAddEmails(raw){
      if(!raw) return;
      // split by comma or whitespace
      const parts = raw.split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);
      parts.forEach(p=>{
        const email = p;
        if(validateEmail(email) && !recipients.includes(email)){
          recipients.push(email);
        }
      });
      renderRecipientTags();
      tagInput.value = '';
    }

    function validateEmail(email){
      // simple RFC-like check (not exhaustive) to avoid obviously invalid addresses
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    tagInput.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ',' ){
        ev.preventDefault();
        normalizeAndAddEmails(tagInput.value);
      } else if(ev.key === 'Backspace' && tagInput.value === '' && recipients.length>0){
        // remove last
        recipients.pop();
        renderRecipientTags();
      }
    });
    tagInput.addEventListener('blur', ()=>{ normalizeAndAddEmails(tagInput.value); });

    recipientTags.addEventListener('click', (ev)=>{
      const b = ev.target.closest('button[data-idx]');
      if(!b) return;
      const idx = Number(b.dataset.idx);
      if(!isNaN(idx)){
        recipients.splice(idx,1);
        renderRecipientTags();
      }
    });

    // ===== PDFå‡ºåŠ›æ©Ÿèƒ½ï¼ˆhtml2canvas + jsPDF ã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼‰ =====
    (function addPdfButtonAndHandler(){
      try {
        const pdfBtn = document.createElement('button');
        pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜';
        pdfBtn.style.marginLeft = '8px';
        pdfBtn.id = 'pdfBtn';
        const controls = qs('#phase6').querySelector('div[style*="display:flex;gap:8px"]');
        if (controls) controls.appendChild(pdfBtn);

        async function loadScript(src){
          return new Promise((resolve, reject)=>{
            const s = document.createElement('script');
            s.src = src;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('failed to load ' + src));
            document.head.appendChild(s);
          });
        }

        async function ensureLibs(){
          if(!window.html2canvas){
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
          }
          if(!window.jspdf){
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
          }
        }

        pdfBtn.addEventListener('click', async ()=>{
          try {
            pdfBtn.disabled = true;
            const prev = pdfBtn.textContent;
            pdfBtn.textContent = 'PDFç”Ÿæˆä¸­...';
            await ensureLibs();

            if(!(window.html2canvas && (window.jspdf && (window.jspdf.jsPDF || (window.jspdf.default && window.jspdf.default.jsPDF))))) throw new Error('PDF libraries not available');

            const card = document.createElement('div');
            card.style.padding = '20px';
            card.style.background = 'white';
            card.style.borderRadius = '12px';
            card.style.boxShadow = '0 6px 18px rgba(20,30,60,0.08)';
            card.style.width = '700px';
            card.style.fontFamily = 'system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif';
            card.innerHTML = `
              <h2 style="text-align:center; color:#1565d8; margin-bottom:10px;">ğŸ§  3M â€” I Message to You About My Mind.</h2>
              <div style="white-space:pre-wrap; color:#111; line-height:1.7;">${escapeHtml(qs('#finalMessage').textContent)}</div>
              <hr style="margin:20px 0;">
              <p style="font-size:12px; text-align:center; color:#666;">Generated safely by ğŸ§  3M â€” I Message to You About My Mind.</p>
            `;
            document.body.appendChild(card);

            const canvas = await window.html2canvas(card, {scale:2});
            const imgData = canvas.toDataURL('image/png');

            const jsPDFConstructor = (window.jspdf && (window.jspdf.jsPDF || (window.jspdf.default && window.jspdf.default.jsPDF)));
            const pdf = new jsPDFConstructor({orientation:'p', unit:'px', format:'a4'});
            const pageWidth = pdf.internal.pageSize.getWidth();
            const imgWidth = pageWidth - 40;
            const imgHeight = canvas.height * imgWidth / canvas.width;

            const now = new Date();

            const options = {
              timeZone: "Asia/Tokyo",
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            };

            const formatted = new Intl.DateTimeFormat("ja-JP", options)
              .format(now)
              .replace(/\//g, "-")
              .replace(",", "")
              .replace(" ", "_")
              .replace(/:/g, "-");
            
            pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
            pdf.save('3M-Message_'+formatted+'.pdf');
            document.body.removeChild(card);
            pdfBtn.textContent = prev;
            pdfBtn.disabled = false;
          } catch(err){
            console.error(err);
            alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            pdfBtn.disabled = false;
            pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜';
          }
        });
      } catch(e) {
        console.error('PDF button failed to initialize', e);
      }
    })();

    // ===== Mail send (mailto: draft) =====
    qs('#sendMailBtn').addEventListener('click', ()=>{
      // recipients array, subject built from select + intro, body from finalMessage
      if(recipients.length === 0){
        if(!confirm('é€ä¿¡å…ˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå®›å…ˆç©ºã§é–‹ãã¾ã™ï¼‰')) {
          return;
        }
      }
      // build subject
      const selectVal = qs('#typeSelect').value || '';
      const intro = qs('#intro').value.trim() || '';
      const subject = (selectVal ? ('ã€' + selectVal + 'ã€‘ ') : '') + intro;
      let body = qs('#finalMessage').textContent || '';
      // Ensure name appended: if personName exists and not already appended as separate line, append
      const name = qs('#personName').value.trim();
      if(name && !body.endsWith(name) && !body.includes('\n' + name)) {
        body = body + '\n\n' + name;
      }

      // encode mailto
      const to = recipients.join(',');
      // encode subject and body with encodeURIComponent but preserve newlines as %0D%0A
      function encodeBody(s){
        // turn CRLF into %0D%0A
        return encodeURIComponent(s).replace(/%0A/g, '%0D%0A');
      }

      const mailto = 'mailto:' + encodeURIComponent(to) +
        '?subject=' + encodeURIComponent(subject) +
        '&body=' + encodeBody(body);

      // use window.open to create draft in external mail client
      try {
        window.open(mailto, '_blank');
      } catch(e){
        // fallback: location.href
        location.href = mailto;
      }
    });

    // Optional: handle browser back/forward to show phase from hash
    window.addEventListener('hashchange', ()=>{
      const frag = location.hash ? location.hash.replace('#','') : 'phase1';
      if (qs('#' + frag)) showPhase(frag);
    }, false);

    // Safety: reserved htmx hook (no-op)
    document.body.addEventListener('htmx:beforeRequest', function(evt){});

  </script>
</body>
</html>
