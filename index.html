<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§  3M â€” I Message to You About My Mind.</title>

  <!-- HTMX (from unpkg) -->
  <script src="https://unpkg.com/htmx.org"></script>

  <style>
    :root{font-family: system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    body{padding:20px;max-width:900px;margin:0 auto;background:#f7f9fb;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{margin-top:0;color:#444}
    textarea,input[type=text]{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ccd;border-radius:8px}
    .card{background:white;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    ul{padding-left:18px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button{background:#1565d8;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    .small{font-size:13px;color:#666}
    .item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .item .controls{display:flex;flex-direction:column;gap:6px}
    .draggable{cursor:grab}
    .final{white-space:pre-wrap;background:#0b1220;color:#e8f0ff;padding:12px;border-radius:8px}
    .danger{color:#b00020}
  </style>
</head>
<body>

  <!-- ãƒšãƒ¼ã‚¸å…¨ä½“ã®è¦‹å‡ºã—ãƒ»èª¬æ˜ï¼ˆå¤‰æ›´ç„¡ã—ï¼‰ -->
  <h1>ğŸ§  3M â€” I Message to You About My Mind.</h1>
  <p class="lead">è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªã„ã¨ãã«ã€è©±ã™å†…å®¹ã‚’æ®µéšçš„ã«æ•´ç†ã—ã¦ç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«æ²¿ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚</p>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’å·®ã—æ›¿ãˆã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -->
  <main id="app" class="card" hx-swap-oob="false">
    <!-- åˆæœŸè¡¨ç¤ºã¯ãƒ•ã‚§ãƒ¼ã‚º1ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆåŒãƒšãƒ¼ã‚¸ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼‰ -->
    <div hx-get="index.html #phase1-template" hx-trigger="load" hx-swap="innerHTML"></div>
  </main>

  <!-- ===== ä»¥ä¸‹ã€å„ãƒ•ã‚§ãƒ¼ã‚ºã®ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ç¾¤ï¼ˆåŒãƒšãƒ¼ã‚¸ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å‚ç…§ã•ã‚Œã¾ã™ï¼‰ ===== -->
  <!-- ã“ã‚Œã‚‰ã¯é™çš„ã«åŒãƒšãƒ¼ã‚¸å†…ã«ç½®ã‹ã‚Œã€htmx ã® hx-get ã§å·®ã—æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚ -->
  <div id="phase1-template" style="display:none">
    <section id="phase1" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º1 â€” ã‚ã‚Šã®ã¾ã¾å…¥åŠ›</h2>
      <p class="small">æ€ã£ãŸã“ã¨ã‚’ãã®ã¾ã¾æ›¸ãå‡ºã—ã¾ã™ï¼ˆé•·æ–‡å¯ï¼‰ã€‚</p>
      <textarea id="rawText" rows="6" placeholder="ã“ã“ã«æ€ã£ã¦ã„ã‚‹ã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      <div style="margin-top:10px">
        <!-- htmx ã§åŒãƒšãƒ¼ã‚¸ã®ãƒ•ã‚§ãƒ¼ã‚º2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦ç½®ãæ›ãˆã‚‹ -->
        <button id="toPhase2" hx-get="index.html #phase2-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase2()">5ã¤ã«åˆ†è§£ã™ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º2</button>
      </div>
    </section>
  </div>

  <div id="phase2-template" style="display:none">
    <section id="phase2" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º2 â€” 5ã¤ã®è¦ç´ ã«åˆ†è§£</h2>
      <p class="small">å…¥åŠ›ã‚’è‡ªå‹•ã§æ–‡ã‚„å¥ã«åˆ†å‰²ã—ã¾ã™ã€‚ç·¨é›†ã—ã¦1è¦ç´ ãšã¤ä¸å¯§ã«æ•´ãˆã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚</p>
      <ul id="elementsList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <!-- æˆ»ã‚‹ã¯åŒãƒšãƒ¼ã‚¸ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã§ãƒ•ã‚§ãƒ¼ã‚º1ã‚’å–å¾— -->
        <button id="backTo1" class="secondary" hx-get="index.html #phase1-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase1()">æˆ»ã‚‹</button>
        <button id="toPhase3" hx-get="index.html #phase3-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase3()">å„ªå…ˆåº¦ãƒã‚§ãƒƒã‚¯ â†’ ãƒ•ã‚§ãƒ¼ã‚º3</button>
      </div>
    </section>
  </div>

  <div id="phase3-template" style="display:none">
    <section id="phase3" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º3 â€” ç·Šæ€¥åº¦ã¨å„ªå…ˆé †ä½ã§ä¸Šä½3ã¤ã«çµã‚‹</h2>
      <p class="small">ãã‚Œãã‚Œã®è¦ç´ ã«ã¤ã„ã¦ã€ç·Šæ€¥æ€§ï¼ˆ0-5ï¼‰ã¨é‡è¦æ€§ï¼ˆ0-5ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è‡ªå‹•çš„ã«åˆè¨ˆã‚¹ã‚³ã‚¢ã§ä¸Šä½3ã¤ãŒé¸ã°ã‚Œã¾ã™ã€‚æ‰‹å‹•ã§ãƒ”ãƒ³ç•™ã‚ã‚‚å¯èƒ½ã§ã™ã€‚</p>
      <ul id="priorityList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="backTo2" class="secondary" hx-get="index.html #phase2-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase2()">æˆ»ã‚‹</button>
        <button id="toPhase4" hx-get="index.html #phase4-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase4()">3ã¤ã«çµã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º4</button>
      </div>
    </section>
  </div>

  <div id="phase4-template" style="display:none">
    <section id="phase4" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º4 â€” 3ã¤ã®è¦ç´ ã«å„ªå…ˆé †ä½ã‚’ä»˜ã‘ã‚‹</h2>
      <p class="small">ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§é †åºã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆä¸ŠãŒä¼ãˆã‚‹é †åºã®å„ªå…ˆåº¦é«˜ï¼‰ã€‚</p>
      <ul id="orderedList"></ul>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="backTo3" class="secondary" hx-get="index.html #phase3-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase3()">æˆ»ã‚‹</button>
        <button id="toPhase5" hx-get="index.html #phase5-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase5()">æ–‡ç« ã‚’çµ„ã¿ç«‹ã¦ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º5</button>
      </div>
    </section>
  </div>

  <div id="phase5-template" style="display:none">
    <section id="phase5" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º5 â€” ç›¸æ‰‹ã«ä¼ãˆã‚‹æ–‡ç« ã‚’ä½œã‚‹</h2>
      <p class="small">é¸ã°ã‚ŒãŸ3ã¤ã‚’çŸ­ãã€å…·ä½“çš„ãªä¸€è¨€ãšã¤ã«ã¾ã¨ã‚ã¾ã™ã€‚ç›¸æ‰‹ã«ä¼ãˆã‚‹ã¨ãã®å†’é ­ï¼ˆç›®çš„ï¼‰ã¨æœ€å¾Œï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰ã‚‚ç”¨æ„ã—ã¾ã™ã€‚</p>
      <div>
        <label class="small">å†’é ­ï¼ˆç›®çš„ï¼‰</label>
        <input type="text" id="intro" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯â—‹â—‹ã«ã¤ã„ã¦è©±ã—ãŸãã¦æ¥ã¾ã—ãŸã€‚">
      </div>
      <ul id="finalInputs"></ul>
      <div style="margin-top:8px">
        <label class="small">ç· ã‚ï¼ˆãŠé¡˜ã„ï¼ç¢ºèªï¼‰</label>
        <input type="text" id="closing" placeholder="ä¾‹ï¼šã“ã‚Œã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿï¼åŠ©ã‘ã¦ã»ã—ã„ã§ã™ã€‚">
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="backTo4" class="secondary" hx-get="index.html #phase4-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase4()">æˆ»ã‚‹</button>
        <button id="toPhase6" hx-get="index.html #phase6-template" hx-swap="innerHTML" hx-on="htmx:afterSwap: initPhase6()">å®Œæˆ â†’ ãƒ•ã‚§ãƒ¼ã‚º6</button>
      </div>
    </section>
  </div>

  <div id="phase6-template" style="display:none">
    <section id="phase6" class="card">
      <h2>ãƒ•ã‚§ãƒ¼ã‚º6 â€” å®Œæˆ</h2>
      <p class="small">ä¸‹ãŒç›¸æ‰‹ã«ä¼ãˆã‚‹ãŸã‚ã®æœ€çµ‚æ–‡ç« ã§ã™ã€‚ç·¨é›†ã‚‚ã§ãã¾ã™ã€‚</p>
      <div class="final" id="finalMessage" contenteditable="false"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
        <button id="editBtn" class="secondary">ç·¨é›†ã™ã‚‹</button>
        <button id="resetBtn" class="secondary">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        <!-- PDFãƒœã‚¿ãƒ³ã¯ã“ã“ã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆinitPhase6ã§ç”Ÿæˆï¼‰ -->
      </div>
    </section>
  </div>

  <!-- ===== ã“ã“ã¾ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¾¤ ===== -->
  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä»¥å‰ã®æ©Ÿèƒ½ã‚’ä¿ã¡ã¤ã¤ã€htmx ç”¨ init é–¢æ•°ã‚’ç”¨æ„ï¼‰ -->
  <script>
    /* ===========================================================
       HTMX + æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®çµ±åˆç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
       - ãƒ•ã‚§ãƒ¼ã‚ºã®åˆ‡ã‚Šæ›¿ãˆã¯ htmx ãŒè¡Œã†ï¼ˆhx-get / hx-swapï¼‰
       - å„ãƒ•ã‚§ãƒ¼ã‚ºå·®ã—æ›¿ãˆå¾Œã«å®Ÿè¡Œã™ã‚‹åˆæœŸåŒ–é–¢æ•°ã‚’ç”¨æ„ï¼ˆinitPhase1..6ï¼‰
       - å…ƒã®æ©Ÿèƒ½ï¼ˆæ–‡åˆ†å‰²ãƒ»ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»ä¸¦ã³æ›¿ãˆãƒ»æœ€çµ‚å‡ºåŠ›ãƒ»å±é™ºèªæ¤œå‡ºï¼‰ã¯ç¶­æŒ
       - åŒãƒšãƒ¼ã‚¸ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆå–å¾—ãªã®ã§ GitHub Pages ã®é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§å‹•ä½œã—ã¾ã™
       =========================================================== */

    // --- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function qs(sel){ return document.querySelector(sel); }
    function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function splitIntoPieces(text, maxPieces){
      if(!text) return Array.from({length:maxPieces},()=>"");
      let pieces = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      pieces = pieces.flatMap(p => p.split(/(?<=[ã€‚ï¼.!?ï¼Ÿ])\s*/));
      pieces = pieces.map(s=>s.trim()).filter(Boolean);
      if(pieces.length > maxPieces){
        while(pieces.length > maxPieces){
          let a = pieces.splice(pieces.length-2,2).join(' ');
          pieces.push(a);
        }
      }
      while(pieces.length < maxPieces) pieces.push("");
      return pieces.slice(0,maxPieces);
    }

    function containsSelfHarmKeywords(text){
      if(!text) return false;
      const keywords = ['æ­»ã«ãŸã„','è‡ªæ®º','å¸Œæ­»','æ¶ˆãˆãŸã„','é¦–ã‚’','æ®ºã—ã¦','çµ‚ã‚ã‚Šã«ã—ãŸã„','æ­»ã‚“ã§'];
      const t = (text||'').replace(/\s+/g,'');
      return keywords.some(k=>t.includes(k));
    }

    /* ===========================================================
       å„ãƒ•ã‚§ãƒ¼ã‚ºã®åˆæœŸåŒ–é–¢æ•°
       htmx ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å·®ã—æ›¿ãˆãŸç›´å¾Œã«å‘¼ã³å‡ºã™ã“ã¨ã‚’æƒ³å®š
       ï¼ˆä¾‹: hx-on="htmx:afterSwap: initPhase2()" ãªã©ï¼‰
       =========================================================== */

    // ãƒ•ã‚§ãƒ¼ã‚º1: textarea ã®å…¥åŠ›ç›£è¦–ï¼ˆå±é™ºèªæ¤œå‡ºï¼‰ã‚’è¨­å®š
    function initPhase1(){
      const raw = qs('#rawText');
      if(!raw) return;
      // remove any existing listeners by cloning
      const rawClone = raw.cloneNode(true);
      raw.parentNode.replaceChild(rawClone, raw);

      // bannerï¼ˆãƒˆãƒƒãƒ—ï¼‰ã‚’ç¢ºå®Ÿã«ç”¨æ„
      let banner = qs('#__3m_banner__');
      if(!banner){
        banner = document.createElement('div');
        banner.id = '__3m_banner__';
        banner.style.padding='10px';
        banner.style.borderRadius='8px';
        banner.style.marginTop='10px';
        document.body.insertBefore(banner, document.body.firstChild.nextSibling);
      }
      banner.style.display = 'none';

      rawClone.addEventListener('input', ()=>{
        const v = rawClone.value || '';
        if(containsSelfHarmKeywords(v)){
          banner.style.display='block';
          banner.innerHTML = '<strong class=\"danger\">ã‚‚ã—ä»Šã™ãã«å±é™ºã‚’æ„Ÿã˜ã¦ã„ã‚‹ãªã‚‰ã€ã„ã¾ã™ãæœ€å¯„ã‚Šã®ç·Šæ€¥é€£çµ¡ï¼ˆ119ï¼‰ã¾ãŸã¯è­¦å¯Ÿï¼ˆ110ï¼‰ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚å°‚é–€ã®ç›¸è«‡ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®æ”¯æ´æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>';
        } else {
          banner.style.display='none';
        }
      });

      // ensure the "toPhase2" button exists in this fragment and works (htmx takes care of swap)
      // nothing else required here
    }

    // ãƒ•ã‚§ãƒ¼ã‚º2: elementsList ã‚’ä½œæˆã—ã€ï¼‹âˆ’ãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’ã‚»ãƒƒãƒˆ
    function initPhase2(){
      const raw = qs('#rawText');
      const arr = splitIntoPieces(raw ? raw.value.trim() : '', 5);
      const ul = qs('#elementsList');
      if(!ul) return;
      ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li'); li.className = 'item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <input type="text" data-index="${i}" class="elementInput" value="${escapeHtml(t)}" />
          </div>
          <div class="controls">
            <button class="secondary" data-action="add" data-index="${i}">ï¼‹</button>
            <button class="secondary" data-action="del" data-index="${i}">ï¼</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // delegate clicks inside elementsList
      ul.addEventListener('click', function handler(ev){
        const b = ev.target.closest('button'); if(!b) return;
        const action = b.dataset.action; const idx = Number(b.dataset.index);
        const inputs = qsa('.elementInput').map(x=>x.value);
        if(action==='add') inputs.splice(idx+1,0,'');
        if(action==='del') inputs.splice(idx,1);
        while(inputs.length < 5) inputs.push('');
        while(inputs.length > 5) inputs.pop();
        // rebuild
        ul.innerHTML = '';
        inputs.forEach((t,i)=>{
          const li = document.createElement('li'); li.className='item';
          li.innerHTML = `
            <div style="flex:1">
              <label class="small">è¦ç´  ${i+1}</label>
              <input type="text" data-index="${i}" class="elementInput" value="${escapeHtml(t)}" />
            </div>
            <div class="controls">
              <button class="secondary" data-action="add" data-index="${i}">ï¼‹</button>
              <button class="secondary" data-action="del" data-index="${i}">ï¼</button>
            </div>`;
          ul.appendChild(li);
        });
      }, {once:false});
    }

    // ãƒ•ã‚§ãƒ¼ã‚º3: priorityList ã‚’ä½œæˆï¼ˆå„è¦ç´ ã«ç·Šæ€¥æ€§ãƒ»é‡è¦æ€§ãƒ»ãƒ”ãƒ³ï¼‰
    function initPhase3(){
      // collect current element inputs if present
      const existing = qsa('.elementInput').map(i=>i.value.trim());
      // if none, try fallback to raw splitting
      let full = existing.length ? existing : splitIntoPieces(qs('#rawText') ? qs('#rawText').value.trim() : '', 5);

      const ul = qs('#priorityList');
      if(!ul) return;
      ul.innerHTML = '';
      full.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">è¦ç´  ${i+1}</label>
            <input type="text" class="ptext" data-i="${i}" value="${escapeHtml(t)}" />
          </div>
          <div style="width:220px">
            <label class="small">ç·Šæ€¥æ€§ (0-5)</label>
            <input type="number" class="urg" min="0" max="5" value="0" />
            <label class="small">é‡è¦æ€§ (0-5)</label>
            <input type="number" class="imp" min="0" max="5" value="0" />
            <div style="margin-top:6px"><input type="checkbox" class="pin" /> ãƒ”ãƒ³ç•™ã‚ï¼ˆå¿…ãšæ®‹ã™ï¼‰</div>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    // ãƒ•ã‚§ãƒ¼ã‚º4: ä¸Šä½3ã¤ã‚’ orderedList ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ã®å‹•ä½œã‚‚è¨­å®šï¼‰
    function initPhase4(){
      // try to pull items from priorityList inputs if exist
      const priItems = qsa('#priorityList .item');
      let items;
      if(priItems && priItems.length){
        items = priItems.map(li=>{
          const text = li.querySelector('.ptext').value.trim();
          const urg = Number(li.querySelector('.urg').value)||0;
          const imp = Number(li.querySelector('.imp').value)||0;
          const pin = li.querySelector('.pin').checked;
          return {text,urg,imp,pin,score:urg+imp};
        }).filter(x=>x.text);
      } else {
        // fallback: use elementInput or raw
        const elInputs = qsa('.elementInput').map(i=>i.value.trim()).filter(Boolean);
        items = elInputs.map(t=>({text:t,urg:0,imp:0,pin:false,score:0}));
      }

      items.sort((a,b)=> (b.score - a.score) || (b.imp - a.imp));
      const pinned = items.filter(i=>i.pin);
      let top = items.slice(0,3);
      pinned.forEach(p=>{ if(!top.includes(p)) { top.pop(); top.push(p); } });
      top = Array.from(new Set(top)).slice(0,3);
      while(top.length<3) top.push({text:'',urg:0,imp:0,score:0});

      const ul = qs('#orderedList'); if(!ul) return;
      ul.innerHTML = '';
      top.forEach((it,idx)=>{
        const li = document.createElement('li'); li.className='item draggable';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">å„ªå…ˆ ${idx+1}</label>
            <input type="text" class="ordtext" data-idx="${idx}" value="${escapeHtml(it.text)}" />
          </div>
          <div class="controls">
            <button class="secondary" data-action="up" data-idx="${idx}">â†‘</button>
            <button class="secondary" data-action="down" data-idx="${idx}">â†“</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // delegate click handling for up/down
      ul.addEventListener('click', (ev)=>{
        const b = ev.target.closest('button'); if(!b) return;
        const action = b.dataset.action; const idx = Number(b.dataset.idx);
        const inputs = qsa('.ordtext').map(i=>i.value);
        if(action==='up' && idx>0){ [inputs[idx-1],inputs[idx]] = [inputs[idx],inputs[idx-1]]; }
        if(action==='down' && idx < inputs.length-1){ [inputs[idx+1],inputs[idx]] = [inputs[idx],inputs[idx+1]]; }
        // rerender
        ul.innerHTML = '';
        inputs.forEach((t,i)=>{
          const li = document.createElement('li'); li.className='item draggable'; li.innerHTML = `
            <div style="flex:1">
              <label class="small">å„ªå…ˆ ${i+1}</label>
              <input type="text" class="ordtext" data-idx="${i}" value="${escapeHtml(t)}" />
            </div>
            <div class="controls">
              <button class="secondary" data-action="up" data-idx="${i}">â†‘</button>
              <button class="secondary" data-action="down" data-idx="${i}">â†“</button>
            </div>`;
          ul.appendChild(li);
        });
      }, {once:false});
    }

    // ãƒ•ã‚§ãƒ¼ã‚º5: orderedList ã®å…¥åŠ›ã‹ã‚‰ finalInputs ã‚’ä½œæˆ
    function initPhase5(){
      const arr = qsa('.ordtext').map(i=>i.value.trim()).filter(Boolean);
      const ul = qs('#finalInputs');
      if(!ul) return;
      ul.innerHTML = '';
      arr.forEach((t,i)=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `
          <div style="flex:1">
            <label class="small">ä¼ãˆã‚‹æ–‡ ${i+1}ï¼ˆçŸ­ãå…·ä½“çš„ã«ï¼‰</label>
            <textarea rows="2" class="finalPiece">${escapeHtml(t)}</textarea>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    // ãƒ•ã‚§ãƒ¼ã‚º6: finalMessage ã‚’ç”Ÿæˆã—ã€ã‚³ãƒ”ãƒ¼ãƒ»ç·¨é›†ãƒ»PDFãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’ã‚»ãƒƒãƒˆ
    function initPhase6(){
      // build the final message from intro, pieces, closing
      const introEl = qs('#intro');
      const closingEl = qs('#closing');
      const pieces = qsa('.finalPiece').map(t=>t.value.trim()).filter(Boolean);

      const final = buildFinalMessage(introEl ? introEl.value.trim() : '', pieces, closingEl ? closingEl.value.trim() : '');
      const finalMessageEl = qs('#finalMessage');
      if(finalMessageEl) finalMessageEl.textContent = final;

      // copy button
      const copyBtn = qs('#copyBtn');
      if(copyBtn){
        copyBtn.addEventListener('click', ()=>{
          const txt = (qs('#finalMessage') && qs('#finalMessage').textContent) || '';
          navigator.clipboard?.writeText(txt).then(()=>alert('æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'));
        }, {once:false});
      }

      // edit button
      const editBtn = qs('#editBtn');
      if(editBtn){
        editBtn.addEventListener('click', ()=>{ const el = qs('#finalMessage'); if(el){ el.contentEditable = true; el.focus(); } }, {once:false});
      }

      // reset button
      const resetBtn = qs('#resetBtn');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{ if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
          // navigate back to phase1 template via htmx
          htmx.ajax('GET', 'index.html #phase1-template', {target:'#app', swap:'innerHTML'});
        } }, {once:false});
      }

      // Add PDF button if not already present
      if(!qs('#pdfBtn')){
        const parent = qs('#phase6') && qs('#phase6').querySelector('div[style*="gap:8px"]');
        if(parent){
          const pdfBtn = document.createElement('button');
          pdfBtn.id = 'pdfBtn';
          pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜';
          pdfBtn.style.marginLeft = '8px';
          parent.appendChild(pdfBtn);
          // attach pdf generation using html2canvas + jsPDF (load libs dynamically)
          pdfBtn.addEventListener('click', handlePdfClick);
        }
      }
    }

    // build final message helper
    function buildFinalMessage(intro,pieces,closing){
      const lines = [];
      if(intro) lines.push(intro);
      pieces.forEach((p,i)=>{
        lines.push((i+1) + '. ' + p);
      });
      if(closing) lines.push(closing);
      return lines.join('\n');
    }

    /* ===========================================================
       PDF ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆhtml2canvas + jsPDF ã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ï¼‰
       - GitHub Pages ã®é™çš„ç’°å¢ƒã§ã‚‚å‹•ä½œï¼ˆCDNèª­ã¿è¾¼ã¿ï¼‰
       - ã‚¨ãƒ©ãƒ¼ã‚’æ¥µåŠ›æ•æ‰ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ˜ç¢ºãªé€šçŸ¥ã‚’è¡Œã†
       =========================================================== */

    async function loadScript(src){
      return new Promise((resolve,reject)=>{
        const existing = Array.from(document.getElementsByTagName('script')).find(s=>s.src && s.src.indexOf(src) !== -1);
        if(existing){ existing.addEventListener('load', ()=>resolve()); if(existing.readyState === 'complete') resolve(); return; }
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }

    async function ensureLibs(){
      // html2canvas
      if(!window.html2canvas){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      }
      if(!window.jspdf){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      }
    }

    async function handlePdfClick(){
      const pdfBtn = qs('#pdfBtn');
      if(!pdfBtn) return;
      try {
        pdfBtn.disabled = true;
        pdfBtn.textContent = 'PDFç”Ÿæˆä¸­...';

        await ensureLibs();
        const { jsPDF } = window.jspdf;

        // create a sanitized card element for capture
        const card = document.createElement('div');
        card.style.padding = '20px';
        card.style.background = 'white';
        card.style.borderRadius = '12px';
        card.style.boxShadow = '0 6px 18px rgba(20,30,60,0.08)';
        card.style.width = '700px';
        card.style.fontFamily = 'system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif';
        const finalText = qs('#finalMessage') ? qs('#finalMessage').textContent : '';
        card.innerHTML = `
          <h2 style="text-align:center; color:#1565d8; margin-bottom:10px;">ğŸ§  3M â€” My Message About My Mind</h2>
          <div style="white-space:pre-wrap; color:#111; line-height:1.7;">${escapeHtml(finalText)}</div>
          <hr style="margin:20px 0;">
          <p style="font-size:12px; text-align:center; color:#666;">Generated safely by 3M â€” Mental Message Maker</p>
        `;
        document.body.appendChild(card);

        // html2canvas capture
        const canvas = await html2canvas(card, {scale:2});
        const imgData = canvas.toDataURL('image/png');

        const pdf = new jsPDF({orientation:'p', unit:'px', format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth - 40;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
        pdf.save('3M_Message.pdf');

        document.body.removeChild(card);
        pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜';
        pdfBtn.disabled = false;
      } catch(err){
        console.error(err);
        alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’ç¢ºèªã—ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        if(pdfBtn){ pdfBtn.textContent = 'ğŸ–¨ï¸ PDFã¨ã—ã¦ä¿å­˜'; pdfBtn.disabled = false; }
      }
    }

    /* ===========================================================
       åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
       - htmx ãŒæœ€åˆã« #phase1-template ã‚’å·®ã—æ›¿ãˆãŸå¾Œã« initPhase1 ã‚’å‘¼ã¶ãŸã‚ã€
         onLoad æ™‚ç‚¹ã§ã¯ #app å†…ã«ãƒ•ã‚§ãƒ¼ã‚º1ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã« initPhase1 ã‚’æ‰‹å‹•ã§å‘¼ã¶
       =========================================================== */

    // htmx ãŒãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆå·®ã—æ›¿ãˆã‚’è¡Œã£ãŸç›´å¾Œã«å‘¼ã°ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã¦å„ init ã‚’å‘¼ã¶
    document.body.addEventListener('htmx:afterSwap', function(evt){
      // evt.detail.target is the element that was swapped into place
      const target = evt.detail && evt.detail.target;
      // if the swapped in fragment contains phase1 etc., call corresponding init
      if(target && target.querySelector && target.querySelector('#phase1')) initPhase1();
      if(target && target.querySelector && target.querySelector('#phase2')) initPhase2();
      if(target && target.querySelector && target.querySelector('#phase3')) initPhase3();
      if(target && target.querySelector && target.querySelector('#phase4')) initPhase4();
      if(target && target.querySelector && target.querySelector('#phase5')) initPhase5();
      if(target && target.querySelector && target.querySelector('#phase6')) initPhase6();
    });

    // Additionally, when the page first loads, htmx will have requested phase1-template
    // but to ensure initialization, we call initPhase1 after a short delay if #rawText exists.
    window.addEventListener('load', function(){
      setTimeout(()=>{ if(qs('#rawText')) initPhase1(); }, 50);
    });

    /* ===========================================================
       Footer: æ”¯æ´æƒ…å ±ï¼ˆåŒãƒ†ã‚­ã‚¹ãƒˆã¯å¤‰æ›´ã—ãªã„ã§ãã®ã¾ã¾è¡¨ç¤ºï¼‰
       - ã“ã“ã¯ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã«ä¸€åº¦ã ã‘å·®ã—è¾¼ã‚€ãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ«å°¾ã§è¿½åŠ ã—ã¾ã™
       =========================================================== */
    (function appendFooter(){
      const footer = document.createElement('div'); footer.className='card'; footer.style.marginTop='20px';
      footer.innerHTML = `
        <h3>æ”¯æ´ãƒ»ç›¸è«‡çª“å£ï¼ˆä¾‹ï¼‰</h3>
        <p class="small">ç·Šæ€¥ã§ãªã„å ´åˆã‚„è©±ã‚’è´ã„ã¦ã»ã—ã„å ´åˆã¯ä¸‹ã®çª“å£ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚ <span class="small">ï¼ˆåœ°åŸŸã«ã‚ˆã£ã¦çª“å£ã‚„ç•ªå·ã¯ç•°ãªã‚Šã¾ã™ï¼‰</span></p>
        <ul class="small">
          <li>TELL Lifelineï¼ˆè‹±èªï¼‰: +81-3-5774-0992ï¼ˆã‚¦ã‚§ãƒ–ã§Lifelineã®æ™‚é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</li>
          <li>ã„ã®ã¡ã®é›»è©±ï¼ˆåœ°åŸŸçª“å£ï¼‰: å„åœ°åŸŸã§24æ™‚é–“ç›¸è«‡ã‚’æä¾›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆè‡ªæ²»ä½“ã®æ¡ˆå†…ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰</li>
          <li>ç·Šæ€¥ãªã‚‰: 119ï¼ˆæ•‘æ€¥ï¼‰ / 110ï¼ˆè­¦å¯Ÿï¼‰</li>
        </ul>
      `;
      document.body.appendChild(footer);
    })();

  </script>
</body>
</html>
